function callback(e,t){var n=e,r=typeof t=="string"?n[t]:t,i=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return r.apply(n,i.concat(e))}}function removeAllChildren(e){while(e.hasChildNodes())e.removeChild(e.firstChild)}function isEmptyObject(e){return Ext.isDefined(e)?Object.keys(e).length===0:!0}function getX(e){var t=0;while(e.offsetParent)t+=e.offsetLeft,e=e.offsetParent;return t}function getY(e){var t=0;while(e.offsetParent)t+=e.offsetTop,e=e.offsetParent;return t}function getObj(e){return document.getElementById(e)}function attribDict(e){var t={},n=e.attributes,r=0;for(r=0;r<n.length;r+=1)t[n[r].name]=n[r].value;return t}function attribInt(e,t){var n=e.getAttribute(t);return n?parseInt(n,10):null}function attribFloat(e,t){var n=e.getAttribute(t);return n?parseFloat(n):null}function attribStr(e,t){return e.getAttribute(t)}function getElement(e){return e.target||e.srcElement}function printXML(e){var t="",n=0,r,i;if(e!==null){t="<"+e.tagName,i=e.attributes;if(i)for(n=0;n<i.length;n+=1)t+=" "+i[n].name+'="'+i[n].value+'"';if(e.hasChildNodes){t+=">	";for(r=e.firstChild;r!==null;r=r.nextSibling)t+=printXML(r);t+="</"+e.tagName+">\n"}else e.value?t+=' value="'+e.value+'"/>\n':e.text?t+=">"+e.text+"</"+e.tagName+">\n":t+=" />\n"}return t}function makeRequest(e,t,n,r,i,s){function o(){if(u.readyState===XMLHttpRequest.DONE){BQSession.reset_timeout();if(u.status===200||u.status===0)f?u.responseXML!==null?f(a,u.responseXML):f(a,u.responseText):clog("makeRequest - no callback defined: "+e);else{var t={401:undefined,403:undefined,404:undefined},n="There was a problem with the request:\n"+u.status+":	"+u.statusText+"\n",r=n+u.responseText;u.status===401||u.status===403?r="You do not have permission for this operation\nAre you logged in?\n\n"+e:u.status===404&&(r="Requested resource does not exist:\n"+e);if(l){l({request:u,message:r,message_short:n});return}if(u.status in t){BQ.ui.error(r);return}BQ.ui.error(r)}}}var u=null,a=n,f=t,l=s;try{if(window.XMLHttpRequest)return u=new XMLHttpRequest,u.onreadystatechange=o,r=="get"||r=="delete"?(u.open(r,e,!0),u.send(null)):(u.open(r,e,!0),u.setRequestHeader("Content-Type","text/xml"),u.send(i)),u}catch(c){clog("Exception in Ajax request: "+c.toString())}}function xmlrequest(e,t,n,r,i){function s(){if(o.readyState===XMLHttpRequest.DONE){BQSession.reset_timeout();if(o.status===200)o.callback?o.responseXML!==null?o.callback(o.responseXML):(clog("WARNING: xmlrequest return text/html"),o.callback(o.responseText)):clog("xmlrequest - no callback defined: "+e);else{var t="There was a problem with the request:\n";o.request_url&&(t+="URL: "+o.request_url+"\n"),t+="Status: "+o.status+"\n",t+="Message: "+o.statusText+"\n";var n=t+o.responseText,r={401:undefined,403:undefined,404:undefined};o.status===401||o.status===403?n="You do not have permission for this operation\nAre you logged in?\n\n"+e:o.status===404&&(n="Requested resource does not exist:\n"+e),o.errorcallback?o.errorcallback({request:o,message:n,message_short:t}):(o.status===401&&(window.location="/auth_service/login?came_from="+window.location),BQ.ui.error(n))}}}var o=null;try{if(window.XMLHttpRequest)return o=new XMLHttpRequest,o.onreadystatechange=s,o.callback=t,o.errorcallback=i,o.request_url=e,n=n||"get",o.open(n,e,!0),o.setRequestHeader("Accept","text/xml"),n==="get"||n==="delete"?o.send(null):(o.setRequestHeader("Content-Type","text/xml"),o.send(r)),o}catch(u){clog("Exception in Ajax request: "+u.toString())}}function chainRequest(e,t){function i(e){n(e),r(e)}var n=e.callback,r=t;e.callback=i}function clog(e){if(typeof window["console"]!="undefined"){var t=arguments.callee.caller.$name||arguments.callee.caller.name,n=null;try{t=arguments.callee.caller.caller.$name||arguments.callee.caller.caller.name,n=arguments.callee.caller.caller.$owner.$className}catch(r){}var i="";t&&(i=t+": "),n&&(i=n+"."+i),console.log(i+e)}}function extend(e,t){e.prototype.__proto__=t.prototype}function isdefined(e){return typeof window[e]=="undefined"?!1:!0}function BQFactory(){}function parseValueType(e,t){try{if(t&&t=="number")return parseFloat(e);if(t&&t=="boolean")return e=="true"?!0:!1}catch(n){return e}return e}function BQValue(e,t){this.resource_type="value",this.xmlfields=["type","index"];if(e instanceof Element&&arguments.length==1){this.initializeXml(e);return}e!=undefined&&(this.type=e),t!=undefined&&(this.value=parseValueType(t,this.type))}function BQVertex(e,t,n,r,i,s){this.resource_type="vertex",this.xmlfields=["x","y","z","t","ch","index"];if(e instanceof Element&&arguments.length==1){this.initializeXml(e);return}this.x=e,this.y=t,this.z=n,this.t=r,this.ch=i,this.index=s}function BQXml(){this.resource_type="",this.xmlfields=[]}function BQObject(e,t){BQXml.call(this,e,t),this.readonly=!1,this.uri=e,this.doc=t||this,this.children=[],this.tags=[],this.gobjects=[],this.values=undefined,this.vertices=undefined,this.dirty=!0,this.created=!0,this.mex=null,this.resource_type="resource",this.xmlfields=["type","name","value","uri","owner","permission","ts","resource_uniq","index","hidden"]}function clean_resources(e,t){for(var n in e)(n in BQObject.attributes_skip||t&&n=="template")&&delete e[n];if(t&&e.tags){var r=e.tags.length-1;while(r>=0){var i=e.tags[r];i.type in BQObject.types_skip&&e.tags.splice(r,1),r--}}if(t&&e.children){var r=e.children.length-1;while(r>=0){var i=e.children[r];i.resource_type in BQObject.types_skip&&e.children.splice(r,1),r--}}var s=undefined;for(var r=0;s=e.tags[r];r++)clean_resources(s,t);for(var r=0;s=e.gobjects[r];r++)clean_resources(s,t);for(var r=0;s=e.children[r];r++)clean_resources(s,t)}function BQResource(e,t){BQObject.call(this,e,t),this.resource_type="resource"}function BQTemplate(e,t){BQObject.call(this,e,t),this.resource_type="template"}function BQImage(e){BQObject.call(this,e),this.resource_type="image"}function BQFile(e){BQObject.call(this,e),this.resource_type="file"}function BQTag(e,t,n,r){BQObject.call(this,e),this.resource_type="tag",this.name=t,this.value=n,this.type=r}function BQGObject(e,t){BQObject.call(this,t),this.type=e,this.uri=null,this.name=null,this.vertices=[],this.resource_type="gobject"}function BQVisitor(){}function BQClassVisitor(){this.VISIT="visit",this.START="start",this.FINISH="finish",this.state=null}function BQProxyClassVisitor(e){this.proxy=e}function visit_all(e,t){var n=Array.prototype.slice.call(arguments,2),r=new BQVisitor;r.visit=t,r.visitall(e,n)}function visit_array(e,t){var n=Array.prototype.slice.call(arguments,2),r=new BQVisitor;r.visit=t,r.visit_array(e,n)}function BQImagePhys(e){this.num_channels=0,this.pixel_depth=null,this.pixel_size=[],this.pixel_units=[],this.channel_names=[],this.display_channels=[],this.channel_colors=[],this.pixel_size_ds=[],this.channel_names_ds=[],this.display_channels_ds=[],this.pixel_size_is=[],this.channel_names_is=[],this.display_channels_is=[],this.channel_colors_default=[new Ext.draw.Color(255,0,0),new Ext.draw.Color(0,255,0),new Ext.draw.Color(0,0,255),new Ext.draw.Color(255,255,255),new Ext.draw.Color(0,255,255),new Ext.draw.Color(255,0,255),new Ext.draw.Color(255,255,0)],this.pixel_formats={"unsigned integer":"u","signed integer":"s","floating point":"f"},this.is_done=!1,this.ds_done=!1,this.loadcallback=null,this.image=e}function combineValue(e,t,n){return e||t||n}function parseUri(e){var t=["source","protocol","authority","domain","port","path","directoryPath","fileName","query","anchor"],n=(new RegExp("^(?:([^:/?#.]+):)?(?://)?(([^:/?#]*)(?::(\\d*))?)?((/(?:[^?#](?![^?#/]*\\.[^?#/.]+(?:[\\?#]|$)))*/?)?([^?#/]*))?(?:\\?([^#]*))?(?:#(.*))?")).exec(e),r={};for(var i=0;i<10;i++)r[t[i]]=n[i]?n[i]:"";return r.directoryPath.length>0&&(r.directoryPath=r.directoryPath.replace(/\/?$/,"/")),r}function BQUrl(e){this.uri=parseUri(e)}function BQUser(){BQObject.call(this),this.resource_type="user"}function BQAuth(){BQObject.call(this),this.resource_type="auth",this.xmlfields=["action","user","email"]}function BQModule(){this.readonly=!0,this.reserved_io_types={"system-input":null,template:null},this.configs={help:"help",thumbnail:"thumbnail",title:"title",authors:"authors",description:"description","display_options/group":"group","module_options/version":"version"},BQObject.call(this),this.resource_type="module"}function BQMex(){BQObject.call(this),this.resource_type="mex"}function BQDataset(){BQObject.call(this),this.resource_type="dataset"}function BQSession(){BQObject.call(this),this.current_timer=null,this.timeout=null,this.expires=null,this.user=undefined,this.user_uri=undefined}function BQQuery(e,t,n){this.parent=t,this.tags=new Array,this.callback=n,makeRequest(e,this.parseResponse,this,"GET",null)}function analysisAction(e,t){var n=Math.round(Math.min(500,BQApp?BQApp.getCenterComponent().getWidth()*.8:document.width*.8)),r=Math.round(BQApp?BQApp.getCenterComponent().getHeight()*.99:document.height*.99),i=Ext.create("Bisque.ResourceBrowser.Browser",{layout:Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.IconList,wpublic:!0,selType:"SINGLE",viewMode:"ModuleBrowser",showOrganizer:!1,dataset:"/module_service/",listeners:{Select:function(e,t){BQApp.resource?pageAction("/module_service/"+t.name+"/?resource="+BQApp.resource.uri):pageAction("/module_service/"+t.name)}}}),s=Ext.create("Ext.tip.ToolTip",{target:e.el,anchor:"right",width:n,maxWidth:n,minWidth:n,height:r,layout:"fit",autoHide:!1,shadow:!0,items:[i]});s.show()}function showTip(e,t,n){n=n||{},"color"in n||(n.color="red"),"timeout"in n||(n.timeout=5e3),n.anchor=n.anchor||"top";var r=new Ext.ToolTip({target:e,anchor:n.anchor,bodyStyle:"font-size: 160%; color: "+n.color+";",html:t});r.show(),setTimeout(function(){r.destroy()},n.timeout)}function DateDiff(e){this.weeks=0,this.days=0,this.hours=0,this.mins=0,this.secs=0,this.msecs=0,this.fromMS(e)}Ext.define("Ext.LoadMask",{override:"Ext.LoadMask",constructor:function(e,t){t=Ext.applyIf(t||{},{shadow:!1,floating:!0}),this.callParent([e,t])}});var svgns="http://www.w3.org/2000/svg",xlinkns="http://www.w3.org/1999/xlink",xhtmlns="http://www.w3.org/1999/xhtml";encodeParameters=function(e){var t=new Array;for(key in e)e[key]&&t.push(key+"="+encodeURIComponent(e[key]));return t.join("&")},Array.prototype.reduce||(Array.prototype.reduce=function(e){var t=this.length;if(typeof e!="function")throw new TypeError;if(t==0&&arguments.length==1)throw new TypeError;var n=0;if(arguments.length>=2)var r=arguments[1];else do{if(n in this){r=this[n++];break}if(++n>=t)throw new TypeError}while(!0);for(;n<t;n++)n in this&&(r=e.call(null,r,this[n],n,this));return r}),Array.prototype.forEach||(Array.prototype.forEach=function(e){var t=this.length>>>0;if(typeof e!="function")throw new TypeError;var n=arguments[1];for(var r=0;r<t;r++)r in this&&e.call(n,this[r],r,this)}),Array.prototype.find=function(e){var t=!1;for(var n=0;n<this.length;n++)typeof e=="function"?e.test(this[n])&&(t||(t=[]),t.push(n)):this[n]===e&&(t||(t=[]),t.push(n));return t},String.prototype.startswith||(String.prototype.startswith=function(e){return this.substr(0,e.length)===e}),BQTypeError=new Error("Bisque type error"),BQOperationError=new Error("Bisque operation error"),default_error_callback=function(e){clog(e.message),BQ.ui.error(e.message)},BQFactory.ctormap={tag:BQTag,image:BQImage,file:BQFile,gobject:BQGObject,point:BQGObject,rectangle:BQGObject,ellipse:BQGObject,polygon:BQGObject,polyline:BQGObject,circle:BQGObject,label:BQGObject,module:BQModule,mex:BQMex,session:BQSession,user:BQUser,auth:BQAuth,dataset:BQDataset,resource:BQResource,template:BQTemplate},BQFactory.ignored={vertex:BQVertex,value:BQValue},BQFactory.escapeXML=function(e){var t=[[/</g,"&lt;"],[/>/g,"&gt;"],[RegExp("'","g"),"&#039;"],[RegExp('"',"g"),"&quot;"]];return e=String(e).replace(/&/g,"&amp;"),t.every(function(t){return e=e.replace(t[0],t[1]),!0}),e},BQFactory.session={},BQFactory.make=function(e,t,n,r){var i=BQResource;return e in BQFactory.ctormap&&(i=BQFactory.ctormap[e]),o=new i(t),i==BQResource&&e&&(o.resource_type=e),o.name=n,o.value=r,o},BQFactory.createFromXml=function(e,t,n){var i=[],s=[];i.push([e,t,n]);while(i.length!=0){var o=i.shift(),u=o[0],t=o[1],n=o[2],a=u.nodeName;t==null&&(a=="resource"&&(a=attribStr(u,"type")),t=BQFactory.make(a)),t.initializeXml(u),s.push(t),n&&(t.setParent(n),t.doc=n.doc);for(var f=0;f<u.childNodes.length;f++){var l=u.childNodes[f];l.nodeType==1&&!(l.nodeName in BQFactory.ignored)&&i.push([l,null,t])}}response=s[0];var c=s.reverse();for(var h=0;r=c[h];h++)r.afterInitialized&&r.afterInitialized();return response},BQFactory.load=function(e,t,n,r){BQFactory.request({uri:e,cb:t,progresscb:n,cache:r})},BQFactory.request=function(e){var t=e.uri,n=e.uri_params,r=e.cb,i=e.progresscb,s=typeof e.cache=="undefined"?!0:!1,o=e.method||"get",u=e.xmldata;e.errorcb=e.errorcb||default_error_callback;if(n){var a=[],f;for(var l in n)n[l]?(f=encodeURIComponent(n[l]),a.push(l+"="+f)):a.push(l);t.indexOf("?")==-1?t=t+"?"+a.join("&"):t=t+"&"+a.join("&")}clog("Loading: "+t),t||clog("ERROR: trying to load null uri"),BQFactory.session[t]=xmlrequest(t,callback(BQFactory,"on_xmlresponse",e),o,u,e.errorcb)},BQFactory.loaded_callback=function(e,t,n){clog("Loaded callback for "+e);var r=BQFactory.session[e];t(r)},BQFactory.on_xmlresponse=function(e,t){var n=e.uri,r=e.cb,i=e.errorcb;clog("Response: "+n);try{var s=t.firstChild;if(!s)return null;s.nodeName=="response"&&(s=s.firstChild);if(!s)return null;var o=s.nodeName;o=="resource"&&(o=attribStr(s,"type"));var u=BQFactory.make(o,n);BQFactory.createFromXml(s,u,null),u.doc=u,BQFactory.session[n]=u}catch(a){clog("on_xmlresponse error"+a),i&&i({xmldoc:t,message:"parse error in BQFactory.on_xmlresponse"});return}if(r)return r(u)},BQFactory.parseBQDocument=function(e){var t=new DOMParser;xmldoc=t.parseFromString(e,"text/xml");var n=xmldoc.firstChild;if(!n)return null;n.nodeName=="response"&&(n=n.firstChild);if(!n)return null;var r=n.nodeName,i=BQFactory.make(r);return BQFactory.createFromXml(n,i,null),i.doc=i,i},BQValue.prototype=new BQXml,BQValue.prototype.initializeXml=function(e){this.type=attribStr(e,"type"),this.value=parseValueType(e.textContent,this.type),this.index=attribInt(e,"index")},BQValue.prototype.setParent=function(e){e.values=e.values||[],e.values.push(this)},BQValue.prototype.xmlNode=function(){return BQXml.prototype.xmlNode.call(this,BQFactory.escapeXML(this.value))},BQVertex.prototype=new BQXml,BQVertex.prototype.setParent=function(e){e.vertices=e.vertices||[],e.vertices.push(this)},BQVertex.prototype.initializeXml=function(e){this.x=attribFloat(e,"x"),this.y=attribFloat(e,"y"),this.z=attribFloat(e,"z"),this.t=attribFloat(e,"t"),this.ch=attribInt(e,"ch"),this.index=attribInt(e,"index")},BQXml.prototype.toXML=function(){return this.xmlNode()},BQXml.prototype.xmlNode=function(e){var t="<"+this.resource_type+" ",n=this.xmlfields;for(var r in n)this[n[r]]!=undefined&&this[n[r]]!=null&&(t+=n[r]+'="'+BQFactory.escapeXML(this[n[r]])+'" ');return e&&e!=""?(t+=">",t+=e,t+="</"+this.resource_type+">"):t+="/>",t},BQObject.prototype=new BQXml,BQObject.prototype.initializeXml=function(e){this.resource_type=attribStr(e,"resource_type")||e.nodeName,this.type=attribStr(e,"type"),this.name=attribStr(e,"name"),this.value=parseValueType(attribStr(e,"value"),this.type),this.uri=attribStr(e,"uri"),this.owner=attribStr(e,"owner"),this.permission=attribStr(e,"permission"),this.ts=attribStr(e,"ts"),this.resource_uniq=attribStr(e,"resource_uniq"),this.index=attribStr(e,"index"),this.hidden=attribStr(e,"hidden"),this.attributes=attribDict(e),this.dirty=!1,this.created=!1,this.template={};var t=e.ownerDocument.evaluate("./value",e,null,XPathResult.ANY_TYPE,null),n=t.iterateNext();n&&(this.values=[]);while(n)this.values.push(new BQValue(n)),n=t.iterateNext();this.resource_uniq&&(this.src="/blob_service/"+this.resource_uniq,this.src=this.uri.replace(/\/data_service\/.*$/i,this.src))},BQObject.prototype.afterInitialized=function(){var e=this.find_children("template");e&&e instanceof Array&&e.length>0?this.template=e[0].toDict(!0):e&&(this.template=e.toDict(!0));if(this.template)return;e=this.find_tags("template"),e&&e instanceof Array&&e.length>0?this.template=e[0].toDict(!0):e&&(this.template=e.toDict(!0))},BQObject.prototype.setValues=function(e){if(this.readonly)throw"This object is read only!";this.values=[];if(e instanceof Array)for(var t=0;t<e.length;t++)this.values.push(new BQValue(undefined,e[t]));else for(var t in e)this.values.push(new BQValue(e[t],t))},BQObject.prototype.testReadonly=function(){if(this.readonly)throw"This object is read only!"},BQObject.prototype.setParent=function(e){e.children=e.children||[],e.children.push(this),this.parent=e},BQObject.prototype.getkids=function(){var e=this.children.concat(this.tags,this.gobjects);return e},BQObject.prototype.load=function(e,t){this.uri=e,makeRequest(this.uri,callback(this,"load_response",t),null,"get")},BQObject.prototype.load_response=function(e,t,n){var r=n.firstChild;r.nodeName=="response"&&(r=r.firstChild),BQFactory.createFromXml(r,this,null),e&&e(this)},BQObject.prototype.toXML=function(){var e="";if(this.values)for(var t=0;t<this.values.length;t++)e+=this.values[t].xmlNode();if(this.vertices)for(var t=0;t<this.vertices.length;t++)e+=this.vertices[t].xmlNode();if(this.tags)for(var t=0;t<this.tags.length;t++)e+=this.tags[t].toXML();if(this.gobjects)for(var t=0;t<this.gobjects.length;t++)e+=this.gobjects[t].toXML();if(this.children)for(var t=0;t<this.children.length;t++)e+=this.children[t].toXML();return this.xmlNode(e)},BQObject.prototype.delete_=function(e,t){this.testReadonly(),this.uri!=null&&xmlrequest(this.uri,callback(this,"response_","delete",t,e),"delete",null,t)},BQObject.prototype.rename=function(e,t,n){clog("BQAPI: BQObject.prototype.rename - Not implemented")},BQObject.prototype.deleteTag=function(e,t,n){e instanceof BQTag?(this.remove(e),e.delete_(t,n)):clog("BQAPI: deleteTag - Input is not a BQTag.")},BQObject.prototype.find_tags=function(e,t,n){n=n||[];for(var r=0;r<this.tags.length;r++){var i=this.tags[r];i.name==e&&n.push(i),t&&i.tags.length>0&&i.find_tags(e,t,n)}return n.length==0?null:n.length==1?n[0]:n},BQObject.prototype.find_children=function(e,t,n,r){r=r||[];for(var i=0;i<this.children.length;i++){var s=this.children[i];s.resource_type==e&&(!t||t&&s.name==t)&&r.push(s),n&&s.children.length>0&&s.find_children(e,t,n,r)}return r.length==0?null:r.length==1?r[0]:r},BQObject.prototype.findTags=function(e){var t=[],n;e.returnFirst=Ext.isDefined(e.returnFirst)?e.returnFirst:!0;for(var r=0;r<this.tags.length;r++){n=this.tags[r];if(n[e.attr]==e.value){t.push(n);if(e.returnFirst)break}else e.deep&&(t=t.concat(n.findTags(e)))}return t},BQObject.prototype.testAuth=function(e,t,n,r){if(!n)e==this.owner?t("owner"):this.getAuth(Ext.bind(this.testAuth,this,[e,t,!0],0));else{r=r.children;for(var i=0;i<r.length;i++)if(r[i].user==e){r[i].action=="edit"||r[i].action=="owner"?t(!0):t(!1,r[i].action);return}t(!1)}},BQObject.prototype.getAuth=function(e,t,n){t?e(n):BQFactory.request({uri:this.uri+"/auth",cb:Ext.bind(this.getAuth,this,[e,!0],0)})},BQObject.attributes_skip={uri:undefined,src:undefined,permission:undefined,ts:undefined,owner:undefined,parent:undefined,doc:undefined,mex:undefined},BQObject.types_skip={template:undefined},BQObject.prototype.clone=function(e){var t=Ext.clone(this);return clean_resources(t,e),t},BQObject.prototype.toDict=function(e,t,n){e=e||!1,t=t||{},n=n||"";var r=null;for(var i=0;r=this.tags[i];i++){var s=undefined;if(r.values&&r.values.length>0){s=[];for(var o=0;v=r.values[o];o++)s.push(v.value)}n+r.name in t?t[n+r.name]instanceof Array?s?t[n+r.name]=t[n+r.name].concat(s):t[n+r.name].push(r.value):s?(t[n+r.name]=[t[n+r.name]],t[n+r.name]=t[n+r.name].concat(s)):t[n+r.name]=[t[n+r.name],r.value]:t[n+r.name]=s?s:r.value,e&&r.tags.length>0&&r.toDict(e,t,n+r.name+"/")}return t},BQObject.prototype.toNestedDict1=function(e){var t={},n;isEmptyObject(this.template)||(t._template=this.template);if(this.tags.length==0)return this.value||"";for(var r=0;r<this.tags.length;r++)n=this.tags[r],t[n.name]=e&&n.tags.length>0?n.toNestedDict(e):n.value||"";return t},BQObject.prototype.toNestedDict=function(e){var t={},n={};Ext.apply(t,{name:this.name,value:this.value||""}),isEmptyObject(this.template)||(t.template=this.template);if(e)for(var r=0;r<this.tags.length;r++)n[this.tags[r].name]=this.tags[r].toNestedDict(e);return{data:t,tags:n}},BQObject.prototype.fromNestedDict=function(e){Ext.apply(this,e.data);for(var t in e.tags)this.addtag().fromNestedDict(e.tags[t])},BQObject.prototype.fromNestedDict1=function(e){var t;e._template&&(this._template=e._template,delete e._template);for(var n in e)t=e[n],t instanceof Object?this.addtag({name:n}).fromNestedDict(t):this.addtag({name:n,value:t})},BQObject.prototype.create_flat_index=function(e,t){e=e||{},t=t||"";var n=null;for(var r=0;n=this.tags[r];r++)t+n.name in e||(e[t+n.name]=n),n.tags.length>0&&(e=n.create_flat_index(e,t+n.name+"/"));return e},BQObject.prototype.find_resource=function(e){for(var t=0;t<this.children.length;t++)if(this.children[t].type==e)return this.children[t];return null},BQObject.prototype.remove_resource=function(e){for(var t=0;t<this.children.length;t++)this.children[t].uri==e&&(delete this.children[t],this.children.splice(t,1));return null},BQObject.prototype.remove=function(e){var t=this.tags.indexOf(e);t!=-1?this.tags.splice(t,1):(t=this.gobjects.indexOf(e),t!=-1?this.gobjects.splice(t,1):(t=this.children.indexOf(e),t!=-1&&this.children.splice(t,1)))},BQObject.prototype.save_=function(e,t,n){this.testReadonly();var r=this.doc,i=r.toXML();n=n||default_error_callback,r.uri?xmlrequest(r.uri,callback(r,"response_","update",n,t),"put",i,n):(e=e||"/data_service/"+this.resource_type+"/",xmlrequest(e,callback(r,"response_","created",n,t),"post",i,n))},BQObject.prototype.save_ww=function(e,t,n){this.testReadonly();var r=this,i=r.toXML();n=n||default_error_callback,r.uri?xmlrequest(r.uri,callback(r,"response_","update",n,t),"put",i,n):(e=e||"/data_service/"+this.resource_type+"/",xmlrequest(e,callback(r,"response_","created",n,t),"post",i,n))},BQObject.prototype.append=function(e,t){this.testReadonly();var n=this.doc,r=n.toXML();xmlrequest(n.uri,callback(n,"response_","update",t,e),"post",r,t)},BQObject.prototype.response_=function(e,t,n,r){var i=r;if(i.nodeName=="#document"||i.nodeName=="response")i=i.firstChild;if(e=="created"){this.children=[],this.tags=[],this.gobjects=[];try{BQFactory.createFromXml(i,this,null)}catch(s){clog("save_"+s),t&&t({xmldoc:r,message:"parse error in BQObject.response_"});return}}n!=null&&n(this)},BQObject.prototype.load_tags=function(e,t,n){if(!t){if(!this.uri){e&&e();return}t=this.uri+"/tag"}this.remove_resource(t),BQFactory.load(t+"?view=deep",callback(this,"loaded_tags",e),n)},BQObject.prototype.load_children=function(e){Ext.apply(e,{attrib:e.attrib||"tag",depth:e.depth||"deep",vector:e.vector||"tags",cb:e.cb||Ext.emptyFn}),Ext.apply(e,{uri:e.uri||this.uri+"/"+e.attrib}),this.remove_resource(e.uri),BQFactory.request({uri:e.uri+"?view="+e.depth,cb:Ext.bind(function(e,t){this[t.vector]=e[t.vector],t.cb(e[t.vector])},this,[e],!0),progresscb:e.progress})},BQObject.prototype.loadTags=function(e){e.attrib="tag",e.vector="tags",BQObject.prototype.load_children.call(this,e)},BQObject.prototype.loadGObjects=function(e){e.attrib="gobject",e.vector="gobjects",BQObject.prototype.load_children.call(this,e)},BQObject.prototype.loaded_tags=function(e,t){this.tags=t.tags,e&&e(t.tags)},BQObject.prototype.load_gobjects=function(e,t,n){t||(t=this.uri+"/gobject"),this.remove_resource(t),BQFactory.load(t+"?view=deep",callback(this,"loaded_gobjects",e),n)},BQObject.prototype.loaded_gobjects=function(e,t){this.gobjects=t.gobjects,e&&e(t.gobjects)},BQObject.prototype.save_gobjects=function(e,t,n,r){this.testReadonly(),t||(t=this.uri);var i=new BQResource(t+"/gobject");i.gobjects=this.gobjects,i.created=!1,i.save_(i.uri,e,r)},BQObject.prototype.save_tags=function(e,t,n,r){this.testReadonly(),t||(t=this.uri);var i=new BQResource(t+"/tag");i.tags=this.tags,i.created=!1,i.save_(i.uri,e,r)},BQObject.prototype.dispose=function(){visit=new BQVisitor,visit.visit=function(e){e.doc=null},visit.visitall(this)},BQObject.prototype.addtag=function(e,t){if(!(e instanceof BQTag)||t){var n=new BQTag;for(var r in e)n[r]=e[r];e=n}return e.setParent(this),e.doc=this.doc,this.dirty=!0,e},BQObject.prototype.addtags=function(e,t){for(var n=0;n<e.length;n++)this.addtag(e[n],t)},BQObject.prototype.addgobjects=function(e){if(!(e instanceof BQGObject)){var t=new BQGObject;for(var n in e)t[n]=e[n];e=t}return e.setParent(this),e.doc=this.doc,this.dirty=!0,e},BQObject.prototype.addchild=function(e){e.setParent(this),e.doc=this.doc,this.dirty=!0},BQObject.prototype.convert_tags=function(){for(var e=0;e<this.tags.length;e++){var t=this.tags[e],n=t.name.replace(/\W/g,"_"),r=t.value;this[n]==undefined?this[n]=r:(this[n]instanceof Array||(this[n]=[this[n]]),this[n].push(r))}},BQResource.prototype=new BQObject,BQTemplate.prototype=new BQObject,BQImage.prototype=new BQObject,BQImage.prototype.initializeXml=function(e){BQObject.prototype.initializeXml.call(this,e),this.resource_uniq&&(this.src="/image_service/images/"+this.resource_uniq,this.src=this.uri.replace(/\/data_service\/.*$/i,this.src))},BQFile.prototype=new BQObject,BQFile.prototype.initializeXml=function(e){BQObject.prototype.initializeXml.call(this,e)},BQTag.prototype=new BQObject,BQTag.prototype.setParent=function(e){e.tags==this.tags&&alert("Warning - BQTag.prototype.setParent: parent and child are same"),e.tags=e.tags||[],e.tags.push(this),this.parent=e},BQGObject.prototype=new BQObject,BQGObject.prototype.initializeXml=function(e){BQObject.prototype.initializeXml.call(this,e),this.type=e.nodeName,this.type=="gobject"&&(this.type=attribStr(e,"type"));var t=e.ownerDocument.evaluate("./vertex",e,null,XPathResult.ANY_TYPE,null),n=t.iterateNext();n&&(this.vertices=[]);while(n)this.vertices.push(new BQVertex(n)),n=t.iterateNext()},BQGObject.prototype.setParent=function(e){e.gobjects=e.gobjects||[],e.gobjects.push(this),this.parent=e},BQVisitor.prototype.visit_array=function(e,t){for(var n=0;n<e.length;n++)this.visitall(e[n],t)},BQVisitor.prototype.visit_special_array=function(e,t){for(var n=0;n<e.length;n++)this.visit_special(e[n],t)},BQVisitor.prototype.visit=function(e,t){},BQVisitor.prototype.start=function(e,t){},BQVisitor.prototype.finish=function(e,t){},BQVisitor.prototype.visitall=function(e,t){var n=[];n.push(e);while(n.length!=0){var r=n.pop();this.visit(r,t);var i=r.getkids();for(var s=0;s<i.length;s++)n.push(i[s])}},BQVisitor.prototype.visit_special=function(e,t){var n=[];n.push([e,null]);while(n.length!=0){var r=n.pop(),i=r[0],s=r[1];if(i==null){this.finish(s,t);continue}var o=i.getkids();o.length>0&&(n.push([null,i]),this.start(i,t)),this.visit(i,t);for(var u=0;u<o.length;u++)n.push([o[u],i])}},BQClassVisitor.prototype=new BQVisitor,BQClassVisitor.prototype.callnode=function(e,t){var n=this[e.type]||this.default_visit||null;if(n!=null){var r=[e].concat(t);n.apply(this,r)}},BQClassVisitor.prototype.visit=function(e,t){this.state=this.VISIT,this.callnode(e,t)},BQClassVisitor.prototype.start=function(e,t){this.state=this.START,this.callnode(e,t)},BQClassVisitor.prototype.finish=function(e,t){this.state=this.FINISH,this.callnode(e,t)},BQProxyClassVisitor.prototype=new BQClassVisitor,BQProxyClassVisitor.prototype.callnode=function(e,t){var n=this.proxy[e.type]||this.proxy.default_visit||null;if(n!=null){var r=[this,e].concat(t);n.apply(this.proxy,r)}},BQImagePhys.prototype.init=function(){if(!this.image)return;this.num_channels=this.ch||this.image.ch,this.pixel_size=[0,0,0,0],this.pixel_units=[undefined,undefined,undefined,undefined],this.display_channels[0]=0,this.display_channels[1]=1,this.display_channels[2]=2,this.num_channels==1&&(this.display_channels[1]=0,this.display_channels[2]=0),this.num_channels==2&&(this.display_channels[2]=-1),this.channel_colors=this.channel_colors_default.slice(0,Math.min(this.num_channels,this.channel_colors_default.length));var e=this.num_channels-this.channel_colors.length;for(var t=0;t<e;t++)this.channel_colors.push(new Ext.draw.Color(0,0,0));for(var t=0;t<this.num_channels;t++)this.channel_names[t]="Ch"+(t+1);this.num_channels==3&&(this.channel_names[0]="Red",this.channel_names[1]="Green",this.channel_names[2]="Blue")},BQImagePhys.prototype.normalizeMeta=function(){clog("BQImagePhys: Aggregate metadata");for(var e=0;e<this.pixel_size.length;e++)this.pixel_size[e]=combineValue(this.pixel_size_ds[e],this.pixel_size_is[e],this.pixel_size[e]),this.pixel_size[e]=parseFloat(this.pixel_size[e]);for(var e=0;e<this.channel_names.length;e++)this.channel_names[e]=combineValue(this.channel_names_ds[e],this.channel_names_is[e],this.channel_names[e]);for(var e=0;e<this.display_channels.length;e++)this.display_channels[e]=combineValue(this.display_channels_ds[e],this.display_channels_is[e],this.display_channels[e]),this.display_channels[e]=parseInt(this.display_channels[e]);this.channel_colors_ds&&this.channel_colors_ds.length===this.num_channels&&(this.channel_colors=this.channel_colors_ds),this.initialized=!0},BQImagePhys.prototype.load=function(e){this.initialized=undefined,this.loadcallback=e,BQFactory.load(this.image.src+"?meta",callback(this,"onloadIS")),this.image.tags.length==0?this.image.load_tags(callback(this,"onloadDS")):this.onloadDS()},BQImagePhys.prototype.onload=function(){clog("BQImagePhys: onload test: "+this.is_done+" "+this.ds_done),this.is_done==1&&this.ds_done==1&&(this.normalizeMeta(),this.loadcallback!=null&&this.loadcallback(this))},BQImagePhys.prototype.onloadIS=function(e){clog("BQImagePhys: Got metadata from IS");var t={};for(var n in e.tags)t[e.tags[n].name]=e.tags[n].value;this.pixel_size_is[0]=t.pixel_resolution_x,this.pixel_size_is[1]=t.pixel_resolution_y,this.pixel_size_is[2]=t.pixel_resolution_z,this.pixel_size_is[3]=t.pixel_resolution_t,this.x=t.image_num_x,this.y=t.image_num_y,this.z=t.image_num_z,this.t=t.image_num_t,this.ch=t.image_num_c,this.init();var r={pixel_resolution_unit_x:0,pixel_resolution_unit_y:1,pixel_resolution_unit_z:2,pixel_resolution_unit_t:3};for(var i in r)i in t&&(this.pixel_units[r[i]]=this.pixel_units[r[i]]||t[i]);this.display_channels_is[0]=t.display_channel_red,this.display_channels_is[1]=t.display_channel_green,this.display_channels_is[2]=t.display_channel_blue;for(var s=0;s<this.num_channels;s++)t["channel_color_"+s]&&(this.channel_colors[s]=Ext.draw.Color.fromString("rgb("+t["channel_color_"+s]+")"));for(var s=0;s<this.num_channels;s++){var o="channel_"+s+"_name";this.channel_names_is[s]=t[o]}this.pixel_depth=t.image_pixel_depth,this.pixel_format=t.image_pixel_format,this.is_done=!0,this.onload()},BQImagePhys.prototype.onloadDS=function(){clog("BQImagePhys: Got metadata from DS");var e=this.image,t={};for(var n in e.tags)t[e.tags[n].name]=e.tags[n].value;i="pixel_resolution_x_y",i in t&&(this.pixel_size_ds[0]=parseFloat(t[i]),this.pixel_size_ds[1]=parseFloat(t[i]));var r={pixel_resolution_x:0,pixel_resolution_y:1,pixel_resolution_z:2,pixel_resolution_t:3};for(var i in r)i in t&&(this.pixel_size_ds[r[i]]=parseFloat(t[i]));var r={pixel_resolution_unit_x:0,pixel_resolution_unit_y:1,pixel_resolution_unit_z:2,pixel_resolution_unit_t:3};for(var i in r)i in t&&(this.pixel_units[r[i]]=t[i]);this.display_channels_ds[0]=t.display_channel_red,this.display_channels_ds[1]=t.display_channel_green,this.display_channels_ds[2]=t.display_channel_blue,this.channel_colors_ds=[];for(var s=0;s<this.num_channels;s++)t["channel_color_"+s]&&(this.channel_colors_ds[s]=Ext.draw.Color.fromString("rgb("+t["channel_color_"+s]+")"));for(var s=0;s<this.num_channels;s++){var o="channel_"+s+"_name";this.channel_names_ds[s]=t[o]}this.ds_done=!0,this.onload()},BQImagePhys.prototype.getPixelInfo=function(e){var t=[undefined,undefined];return this.pixel_size[e]!=undefined&&!isNaN(this.pixel_size[e])&&this.pixel_size[e]!=0&&(t[0]=this.pixel_size[e],t[1]=this.pixel_units[e]),t},BQImagePhys.prototype.getPixelInfoZ=function(){return this.getPixelInfo(2)},BQImagePhys.prototype.getPixelInfoT=function(){return this.getPixelInfo(3)},BQUrl.prototype.toString=function(){return this.uri.source},BQUrl.prototype.server=function(){return this.uri.protocol+"://"+this.uri.authority},BQUser.prototype=new BQObject,BQUser.prototype.initializeXml=function(e){BQObject.prototype.initializeXml.call(this,e),this.user_name=this.name,this.display_name=this.user_name,this.email=this.value,this.email_address=this.email},BQUser.prototype.afterInitialized=function(){var e=this.find_tags("display_name");this.display_name=e&&e.value?e.value:this.user_name},BQUser.prototype.get_credentials=function(e){BQFactory.load(bq.url("/auth_service/credentials/"))},BQUser.prototype.on_credentials=function(e,t){this.credentials=t,this.credentials.convert_tags(),e&&e(t)},BQAuth.prototype=new BQObject,BQAuth.prototype.initializeXml=function(e){BQObject.prototype.initializeXml.call(this,e),this.action=attribStr(e,"action"),this.email=attribStr(e,"email"),this.user=attribStr(e,"user")},BQAuth.prototype.save_=function(e){debugger},BQModule.prototype=new BQObject,BQModule.prototype.afterInitialized=function(){var e=this.toDict(!0);for(var t in this.configs)t in e&&!(t in this)&&(this[this.configs[t]]=e[t]);var n=this.find_tags("inputs");n&&n.tags&&(this.inputs=n.tags,this.inputs_index=n.create_flat_index());var r=this.find_tags("outputs");r&&r.tags&&(this.outputs=r.tags,this.outputs_index=r.create_flat_index());if("execute_options/iterable"in e){this.iterables=[e["execute_options/iterable"]];var i=this.iterables[0];if(!(i in this.outputs_index)){var s=new BQTag(undefined,i,undefined,"dataset");this.outputs.push(s),this.outputs_index[i]=s}}this.updateTemplates()},BQModule.prototype.updateTemplates=function(){for(var e in this.inputs_index){var n=this.inputs_index[e];if(n.template){var r={};n.type&&(r[n.type]=n.type);if(n.template.accepted_type)for(var i=0;t=n.template.accepted_type[i];i++)r[t]=t;n.template.accepted_type=r}}},BQModule.prototype.fromNode=function(e){this.initializeXml(e)},BQModule.prototype.createMEX=function(){var e=new BQMex,t=e.addtag({name:"inputs"}),n=undefined;for(var r=0;n=this.inputs[r];r++){var i=n.clone(!0);t.addchild(i)}if(this.iterables&&this.iterables.length>0){var s=e.addtag({name:"execute_options"}),o=undefined;for(var r=0;o=this.iterables[r];r++){var n=this.inputs_index[o];if(!n)continue;s.addtag({name:"iterable",value:n.name})}}return e},BQMex.prototype=new BQObject,BQMex.prototype.initializeXml=function(e){BQObject.prototype.initializeXml.call(this,e),this.status=this.value},BQMex.prototype.hasIterables=function(){return this.iterables?Object.keys(this.iterables).length>0:!1},BQMex.prototype.findMexsForIterable=function(e,t){t=t||"inputs/",this.iterables=this.iterables||{};if(!e||this.children.length<1)return;this.dict=this.dict||this.toDict(!0);var n=this.dict[t+e];this.iterables[e]=this.iterables[e]||{},this.iterables[e].dataset=n;var r=null;for(var i=0;r=this.children[i];i++)if(r instanceof BQMex){var s=r.dict[t+e];s&&(this.iterables[e][s]=r)}},BQMex.prototype.afterInitialized=function(){this.dict=this.dict||this.toDict(!0);var e=this.find_tags("inputs");e&&e.tags&&(this.inputs=e.tags,this.inputs_index=e.create_flat_index());var t=this.find_tags("outputs");t&&t.tags&&(this.outputs=t.tags,this.outputs_index=t.create_flat_index());if(this.dict["execute_options/iterable"]){var n=this.dict["execute_options/iterable"];this.findMexsForIterable(n,"inputs/"),this.outputs=this.outputs||[],this.outputs_index=this.outputs_index||{};if(!(n in this.outputs_index)&&this.iterables&&n in this.iterables&&"dataset"in this.iterables[n]){var r=new BQTag(undefined,n,this.iterables[n].dataset,"dataset");this.outputs.push(r),this.outputs_index[n]=r}}},BQDataset.prototype=new BQObject,BQDataset.prototype.getMembers=function(e){return this.values?e&&e(this):BQFactory.request({uri:this.uri+"/value",cb:callback(this,"_loaded",e),uri_params:{view:"deep"}}),this},BQDataset.prototype._loaded=function(e,t){this.values=t.children||[],e&&e(this)},BQDataset.prototype.setMembers=function(e){this.values=e},BQDataset.prototype.appendMembers=function(e,t){this.getMembers(callback(this,this.appendMembersResp,e,t))},BQDataset.prototype.appendMembersResp=function(e,t,n){var r=n.values.concat(e);this.setMembers(r),t&&t()},BQDataset.prototype.tmp_deleteMembers=function(e){function t(t){t?this.tmp_success++:this.tmp_failure++,this.tmp_success+this.tmp_failure==this.tmp_final&&e({success:this.tmp_success,failure:this.tmp_failure})}Ext.apply(this,{tmp_cb:e,tmp_success:0,tmp_failure:0,tmp_final:this.tmp_members.length});for(var n=0;n<this.tmp_members.length;n++)this.tmp_members[n].resource.delete_(Ext.pass(t,[!0],this),Ext.pass(t,[!1],this))},BQDataset.prototype.tmp_setMembers=function(e){e instanceof Array||(e=[e]),this.tmp_members=e},BQDataset.prototype.tmp_downloadMembers=function(){var e=Ext.create("BQ.Export.Panel"),t=[];for(var n=0;n<this.tmp_members.length;n++)t.push(this.tmp_members[n].resource);e.downloadResource(t,"tar")},BQDataset.prototype.tmp_changePermission=function(e,t,n){function i(e,t){--e.count==0&&t()}var r={count:this.tmp_members.length};for(var s=0;s<this.tmp_members.length;s++)this.tmp_members[s].changePrivacy(e,Ext.pass(i,[r,t]))},BQDataset.prototype.tmp_shareMembers=function(){var e=Ext.create("BQ.ShareDialog.Offline",{resources:this.tmp_members})},BQSession.prototype=new BQObject,BQSession.current_session=undefined,BQSession.reset_timeout=function(){BQSession.current_session&&BQSession.current_session.reset_timeout()},BQSession.initialize_timeout=function(e,t){BQFactory.load(e+bq.url("/auth_service/session"),function(n){BQSession.current_session=n,n.set_timeout(e,t),n.onsignedin&&n.onsignedin(n)},null,!1)},BQSession.clear_timeout=function(e){BQSession.current_session&&(clearTimeout(BQSession.current_session.current_timer),BQSession.current_session=undefined)},BQSession.prototype.parseTags=function(){var e=this.find_tags("timeout"),t=this.find_tags("expires");t&&e&&(this.timeout=parseInt(e.value)*1e3,this.expires=parseInt(t.value)*1e3,clog("session "+this.timeout+":"+this.expires));var n=this.find_tags("user");if(n)this.user_uri=n.value,BQFactory.request({uri:n.value,cb:callback(this,"setUser"),cache:!1,uri_params:{view:"full"}});else{this.user=null,this.user_uri=null;var r=this;r.onnouser&&r.onnouser()}},BQSession.prototype.hasUser=function(){return this.user?!0:!1},BQSession.prototype.setUser=function(e){this.user=e,this.ongotuser&&this.ongotuser(this.user)},BQSession.prototype.set_timeout=function(e,t){t&&(t.onsignedin&&(this.onsignedin=t.onsignedin),t.onsignedout&&(this.onsignedout=t.onsignedout),t.ongotuser&&(this.ongotuser=t.ongotuser),t.onnouser&&(this.onnouser=t.onnouser)),this.parseTags(),this.timeout?(this.callback=callback(this,"check_timeout",e),clog("timeout in "+this.timeout),this.reset_timeout()):clog("no expire")},BQSession.prototype.reset_timeout=function(){clearTimeout(this.current_timer),this.timeout&&(this.current_timer=setTimeout(this.callback,this.timeout)),BQSession.current_session=this},BQSession.prototype.cancel_timeout=function(){clearTimeout(this.current_timer)},BQSession.prototype.check_timeout=function(e){BQSession.clear_timeout(),BQFactory.load(e+bq.url("/auth_service/session"),function(t){t.session_timeout(e)},null,!1)},BQSession.prototype.session_timeout=function(e){this.parseTags();if(this.expires>3e4){clog("session timeout is resetting: expires ="+this.expires),this.set_timeout(e);return}this.onsignedout&&this.onsignedout()},BQQuery.prototype.parseResponse=function(e,t){var n=t.getElementsByTagName("tag");for(var r=0;r<n.length;r++)e.tags[r]=n[r].getAttribute("value");e.callback(e)},Ext.require(["Ext.util.Observable"]),Ext.require(["Ext.container.Viewport"]),Ext.define("BQ",{extend:"Ext.util.Observable",root:"/",baseCSSPrefix:"bq-",constructor:function(e){return typeof bq=="undefined"&&(bq={}),this.callParent(arguments)},url:function(e,t){return this.root&&this.root!="/"?this.root+e:e}}),bq=Ext.create("BQ"),Ext.define("BQ.Application",{extend:"Ext.util.Observable",constructor:function(e){return this.addEvents({signedin:!0,signedout:!0,gotuser:!0,nouser:!0}),e=e||{},this.callParent(),e.config=e.config||{},this.onReady(),this.main=Ext.create("BQ.Application.Window",e.config),BQSession.initialize_timeout("",{onsignedin:callback(this,this.onSignedIn),onsignedout:callback(this,this.onSignedOut),ongotuser:callback(this,this.onGotUser),onnouser:callback(this,this.onNoUser)}),this},onReady:function(){function e(e){this.userList={};for(var t=0;t<e.children.length;t++)this.userList[e.children[t].uri]=e.children[t]}BQFactory.request({uri:bq.url("/data_service/user?view=deep&wpublic=true"),cb:Ext.bind(e,this)})},onSignedIn:function(){this.session=BQSession.current_session,this.fireEvent("signedin",BQSession.current_session)},onSignedOut:function(){this.session=undefined,this.fireEvent("signedout"),alert("Your session has  timed out"),window.location=this.url("/auth_service/logout")},onGotUser:function(){this.user=BQSession.current_session.user,this.fireEvent("gotuser",BQSession.current_session.user),BQ.Preferences.loadUser(BQSession.current_session.user,"INIT")},onNoUser:function(){this.user=null,this.fireEvent("nouser"),BQ.Preferences.loadUser(null,"LOADED")},hasUser:function(){return this.session&&this.user},getCenterComponent:function(){if(this.main)return this.main.getCenterComponent()},setCenterComponent:function(e){if(!this.main)return;this.main.setCenterComponent(e)},getToolbar:function(){if(this.main)return this.main.getToolbar()},setLoading:function(e,t){if(!this.main)return;var n=this.getCenterComponent()||this.main;n.setLoading(e,t)}}),Ext.define("BQ.Application.Window",{extend:"Ext.container.Viewport",requires:["Ext.tip.QuickTipManager","Ext.tip.QuickTip"],id:"appwindow",layout:"border",border:!1,initComponent:function(){Ext.tip.QuickTipManager.init();var e=document.getElementById("content");e&&e.children.length<1&&(document.body.removeChild(e),e=undefined),this.toolbar=Ext.create("BQ.Application.Toolbar",{toolbar_opts:bq.toolbar_opts}),this.items=[this.toolbar,{region:"center",id:"centerEl",layout:"fit",flex:3,border:!1,header:!1,contentEl:e,autoScroll:!0},{id:"help",region:"east",collapsible:!0,split:!0,layout:"fit",hidden:!0,cls:"help",width:320,border:!1}],this.callParent()},onDestroy:function(){this.callParent()},removeWindowContent:function(){var e=this.getComponent("centerEl");e.removeAll(),e.update("")},getCenterComponent:function(){return this.getComponent("centerEl")},setCenterComponent:function(e){this.removeWindowContent(),this.getComponent("centerEl").add(e)},getHelpComponent:function(){return this.getComponent("help")},getToolbar:function(){return this.toolbar}}),BQ.Application.Window.prototype.test=function(){alert("test")},Ext.define("BisqueServices",{singleton:!0,constructor:function(){BQFactory.request({uri:"/services",cb:Ext.bind(this.servicesLoaded,this)})},servicesLoaded:function(e){this.services=[];for(var t=0;t<e.tags.length;t++)this.services[e.tags[t].type.toLowerCase()]=e.tags[t]},getURL:function(e){var t=this.services[e];return t?t.value:""}}),BisqueService=function(e){this.urls=e,this.urls.length&&(this.url=this.urls[0])},BisqueService.prototype.make_url=function(e,t){var n=this.url;return e&&(n=n+"/"+e),t&&(n=n+"?"+encodeParameters(t)),n},BisqueService.prototype.xmlrequest=function(e,t,n,r){var i=null,s=this.make_url(e,t);r&&(i="post"),xmlrequest(s,n,i,r)},BisqueService.prototype.request=function(e,t,n,r){var i=null,s=this.make_url(e,t);r&&(i="post"),BQFactory.request({uri:s,callback:n,method:i,body:r})},Bisque=function(){this.services={}},Bisque.prototype.init=function(){BQFactory.load("/services",callback(this,"on_init"))},Bisque.prototype.on_init=function(e){var t=e.tags;for(var n=0;n<t.length;n++){var r=t[n].type,i=t[n].value;Bisque[r]=new BisqueService(i)}},Bisque.onReady=function(e){Ext.onReady(e)},Bisque.init_services=function(e){for(var t in e)Bisque[t]=new BisqueService(e[t])},Ext.require(["Ext.toolbar.Toolbar"]),Ext.require(["Ext.tip.QuickTip"]),Ext.require(["Ext.tip.QuickTipManager"]);var urlAction=function(e){window.open(e)},pageAction=function(e){document.location=e},htmlAction=function(e,t){var n={modal:!0,width:BQApp?BQApp.getCenterComponent().getWidth()/1.6:document.width/1.6,height:BQApp?BQApp.getCenterComponent().getHeight()/1.2:document.height/1.2,buttonAlign:"center",autoScroll:!0,loader:{url:e,renderer:"html",autoLoad:!0},buttons:[{text:"Ok",handler:function(){r.close()}}]};t&&typeof t=="string"&&(n.title=t);var r=Ext.create("Ext.window.Window",n);r.show()};Ext.define("BQ.Application.Toolbar",{extend:"Ext.toolbar.Toolbar",requires:["Ext.toolbar.Toolbar","Ext.tip.QuickTipManager","Ext.tip.QuickTip"],region:"north",border:!1,layout:{overflowHandler:"Menu"},defaults:{scale:"large"},cls:"toolbar-main",preferences:{},title:"Bisque demo",toolbar_opts:{browse:!0,upload:!0,download:!0,services:!0,query:!0},image_query_text:"Find images using tags",tools_big_screen:["button_upload","button_download"],tools_none:["menu_user_signin","menu_user_register","menu_user_register_sep","menu_user_recover"],tools_user:["menu_user_name","menu_user_profile","menu_user_signout","menu_user_prefs","menu_user_signout_sep","menu_resource_template","menu_resource_create"],tools_admin:["menu_user_admin_separator","menu_user_admin","menu_user_admin_prefs"],initComponent:function(){this.images_base_url=this.images_base_url||bq.url("/images/toolbar/"),this.title=bq.title||this.title,Ext.QuickTips.init(),Ext.tip.QuickTipManager.init();var e=this;BQ.Preferences.get({key:"Toolbar",callback:Ext.bind(this.onPreferences,this)}),this.menu_services={xtype:"menu",cls:"toolbar-menu",plain:!0,items:[{text:"Analysis",handler:analysisAction},"-",{text:"Import",iconCls:"icon-import",handler:Ext.Function.pass(pageAction,"/import/")},{text:"Export",iconCls:"icon-export",handler:Ext.Function.pass(pageAction,"/export/")},"-",{text:"Statistics",handler:Ext.Function.pass(pageAction,"/stats/")}]};var t={itemId:"menu_user_signin",plain:!0,xtype:"form",id:"login_form",layout:"form",cls:"loginmenu",standardSubmit:!0,border:!1,bodyBorder:!1,url:"/auth_service/login_check",width:350,fieldDefaults:{msgTarget:"side",border:0},items:[{xtype:"hiddenfield",name:"came_from",value:document.location,allowBlank:!0},{xtype:"textfield",fieldLabel:"User name",name:"login",inputId:"loginusername",allowBlank:!1,fieldSubTpl:['<input id="{id}" type="{type}" {inputAttrTpl}',' size="1"','<tpl if="name"> name="{name}"</tpl>','<tpl if="value"> value="{[Ext.util.Format.htmlEncode(values.value)]}"</tpl>','<tpl if="placeholder"> placeholder="{placeholder}"</tpl>','<tpl if="maxLength !== undefined"> maxlength="{maxLength}"</tpl>','<tpl if="readOnly"> readonly="readonly"</tpl>','<tpl if="disabled"> disabled="disabled"</tpl>','<tpl if="tabIdx"> tabIndex="{tabIdx}"</tpl>','<tpl if="fieldStyle"> style="{fieldStyle}"</tpl>',' class="{fieldCls} {typeCls} {editableCls}" autocomplete="on" autofocus="true" />',{disableFormats:!0}],listeners:{specialkey:function(e,t){if(t.getKey()==t.ENTER){var n=e.up("form").getForm();n.submit()}}}}],buttons:[{xtype:"button",text:"Sign in",formBind:!0,disabled:!0,handler:function(){var e=this.up("form").getForm();e.isValid()&&e.submit()}}],autoEl:{tag:"form"},listeners:{render:function(){this.el.set({autocomplete:"on"})}}};this.menu_user={xtype:"menu",cls:"toolbar-menu",plain:!0,items:[{plain:!0,cls:"toolbar-menu"},{xtype:"tbtext",itemId:"menu_user_name",text:"Sign in",indent:!0,hidden:!0,cls:"menu-heading"},{text:"Profile",itemId:"menu_user_profile",hidden:!0,handler:Ext.Function.pass(pageAction,bq.url("/registration/edit_user"))},{xtype:"menuseparator",itemId:"menu_user_admin_separator",hidden:!0},{text:"Website admin",itemId:"menu_user_admin",hidden:!0,handler:Ext.Function.pass(pageAction,bq.url("/admin"))},{text:"User preferences",itemId:"menu_user_prefs",handler:this.userPrefs,scope:this,hidden:!0},{text:"System preferences",itemId:"menu_user_admin_prefs",hidden:!0,handler:this.systemPrefs,scope:this},{xtype:"menuseparator",itemId:"menu_user_signout_sep",hidden:!0},{text:"Sign out",itemId:"menu_user_signout",hidden:!0,handler:Ext.Function.pass(pageAction,bq.url("/auth_service/logout_handler"))},t,{xtype:"menuseparator",itemId:"menu_user_register_sep"},{text:"Register new user",itemId:"menu_user_register",handler:Ext.Function.pass(pageAction,bq.url(this.preferences.registration||"/registration"))},{text:"Recover Password",itemId:"menu_user_recover",handler:Ext.Function.pass(pageAction,bq.url(this.preferences.registration||"/registration/lost_password"))}]};var n={xtype:"menu",cls:"toolbar-menu",plain:!0,items:[{xtype:"tbtext",text:'<img src="'+this.images_base_url+'bisque_logo_white_170.png" style="width: 96px; height: 77px; margin: 10px; margin-left: 30px;" />',indent:!0},{text:"About Bisque",handler:Ext.Function.pass(htmlAction,[bq.url("/client_service/about"),"About Bisque"])},{text:"Privacy policy",handler:Ext.Function.pass(htmlAction,bq.url("/client_service/public/about/privacypolicy.html"))},{text:"Terms of use",handler:Ext.Function.pass(htmlAction,bq.url("/client_service/public/about/termsofuse.html"))},{text:"License",handler:Ext.Function.pass(htmlAction,bq.url("/client_service/public/about/license.html"))},"-",{text:"Usage statistics",handler:Ext.Function.pass(pageAction,bq.url("/usage/"))},"-",{text:"Online Help",handler:Ext.Function.pass(urlAction,bq.url("/client_service/help"))},{text:"Bisque project website",handler:Ext.Function.pass(urlAction,"http://www.bioimage.ucsb.edu/downloads/Bisque%20Database")},"-",{xtype:"tbtext",text:"Problems with Bisque?",indent:!0,cls:"menu-heading"},{text:"Developers website",handler:Ext.Function.pass(urlAction,"http://biodev.ece.ucsb.edu/projects/bisquik")},{text:"Submit a bug or suggestion",handler:Ext.Function.pass(urlAction,"http://biodev.ece.ucsb.edu/projects/bisquik/newticket")},{text:"Send us e-mail",handler:Ext.Function.pass(urlAction,"mailto:bisque-dev@biodev.ece.ucsb.edu,bisque-bioimage@googlegroups.com")}]},r=this.toolbar_opts&&this.toolbar_opts.browse===!1?!1:!0;this.items=[{xtype:"tbtext",text:'<img src="'+this.images_base_url+'bisque_logo_100px.png" style="width: 58px; height: 38px; margin-right: 5px; margin-left: 5px;" />'},{xtype:"tbtext",itemId:"menu_title",text:'<h3><a href="/">'+this.title+"</a></h3>"},{xtype:"tbspacer",width:40},{xtype:"button",itemId:"button_services",menu:this.menu_services,iconCls:"icon-services",text:"Services"},{text:"Upload",itemId:"button_upload",iconCls:"icon-import",handler:Ext.Function.pass(pageAction,bq.url("/import/upload")),tooltip:""},{text:"Download",itemId:"button_download",iconCls:"icon-export",handler:Ext.Function.pass(pageAction,"/export/"),tooltip:""},{itemId:"menu_images",xtype:"splitbutton",text:"Images",iconCls:"icon-browse",hidden:!r,tooltip:"Browse images",handler:function(t){var n="",r=e.queryById("menu_query");r&&r.value!=e.image_query_text&&(n="?tag_query="+escape(r.value)),document.location=bq.url("/client_service/browser"+n)}},{itemId:"menu_resources",text:"Resources",iconCls:"icon-browse",hidden:r,tooltip:"Browse resources"},{xtype:"tbspacer",width:10,hidden:!r},{itemId:"menu_query",xtype:"textfield",flex:2,name:"search",value:this.image_query_text,hidden:!r,minWidth:60,tooltip:"Query for images used Bisque expression",enableKeyEvents:!0,listeners:{focus:function(t){t.value==e.image_query_text&&t.setValue("")},specialkey:function(t,n){n.getKey()==n.ENTER&&t.value!=""&&t.value!=e.image_query_text&&(document.location=bq.url("/client_service/browser?tag_query="+escape(t.value)))}}},"->",{itemId:"menu_user",menu:this.menu_user,iconCls:"icon-user",text:"Sign in",tooltip:"Edit your user account",plain:!0},{menu:n,iconCls:"icon-help",tooltip:"All information about Bisque"}],this.addListener("resize",this.onResized,this),this.callParent(),Ext.util.Observable.observe(BQ.Application),BQ.Application.on("gotuser",function(e){this.queryById("menu_user").setText(e.display_name),this.queryById("menu_user_name").setText(e.display_name+" - "+e.email_address);for(var t=0;p=this.tools_none[t];t++)this.setSubMenuVisibility(p,!1);for(var t=0;p=this.tools_user[t];t++)this.setSubMenuVisibility(p,!0);if(e.user_name=="admin")for(var t=0;p=this.tools_admin[t];t++)this.setSubMenuVisibility(p,!0)},this),BQ.Application.on("signedin",function(){}),BQ.Application.on("signedout",function(){for(var e=0;p=this.tools_none[e];e++)this.setSubMenuVisibility(p,!0);for(var e=0;p=this.tools_user[e];e++)this.setSubMenuVisibility(p,!1);for(var e=0;p=this.tools_admin[e];e++)this.setSubMenuVisibility(p,!1)},this),this.fetchResourceTypes()},setSubMenuVisibility:function(e,t){var n=this.queryById(e);n&&n.setVisible(t)},onResized:function(){var e=this.getWidth();if(e<1024)for(var t=0;id=this.tools_big_screen[t];++t)this.queryById(id).setVisible(!1);else for(var t=0;id=this.tools_big_screen[t];++t)this.queryById(id).setVisible(!0)},userPrefs:function(){var e=Ext.create("BQ.Preferences.Dialog")},systemPrefs:function(){var e=Ext.create("BQ.Preferences.Dialog",{prefType:"system"})},fetchResourceTypes:function(){BQFactory.request({uri:"/data_service/",cb:callback(this,"onResourceTypes"),cache:!1})},onResourceTypes:function(e){var t={xtype:"menu",cls:"toolbar-menu",plain:!0,items:[{text:"dataset",handler:Ext.Function.pass(pageAction,"/client_service/browser?resource=/data_service/dataset")}]};BQApp.resourceTypes=[];var n=null;for(var r=0;n=e.children[r];r++){BQApp.resourceTypes.push({name:n.name,uri:n.uri});if(n.name=="dataset")continue;var i=n.name,s=n.uri;t.items.push({text:i,handler:Ext.Function.pass(pageAction,"/client_service/browser?resource="+s)})}t.items.push("-"),t.items.push({text:"Create a new resource",itemId:"menu_resource_create",handler:function(){this.createResource(e)},scope:this,hidden:!BQApp.hasUser()}),t.items.push({itemId:"menu_resource_template",text:"Create resource from template",handler:function(){this.createResourceFromTemplate()},scope:this,hidden:!BQApp.hasUser()}),t=Ext.create("Ext.menu.Menu",t),this.queryById("menu_images").menu=t,this.queryById("menu_resources").menu=t},createResourceFromTemplate:function(e){if(!e){BQFactory.request({uri:"/data_service/template/",cb:Ext.bind(this.createResourceFromTemplate,this),errorcb:function(e){BQ.ui.error("createResourceFromTemplate: Error occured while fetching list of available templates."+e.message,4e3)}});return}var t=Ext.create("Ext.data.Store",{fields:["name","uri"],data:e.children}),n=Ext.create("Ext.form.Panel",{frame:!0,width:350,defaultType:"textfield",bodyStyle:{padding:"10px"},fieldDefaults:{msgTarget:"side",labelWidth:100},defaults:{anchor:"100%",allowBlank:!1},items:[{xtype:"combobox",name:"template",fieldLabel:"Select template",store:t,displayField:"name",valueField:"uri",editable:!1},{fieldLabel:"Name",name:"name"}]}),r=Ext.create("Ext.window.Window",{items:n,modal:!0,border:!1,title:"Create resource from template",buttonAlign:"center",buttons:[{text:"Create",scope:this,margin:3,handler:function(e){var t=n.getForm();if(t.isValid()){var r=t.getValues();BQ.TemplateManager.createResource({name:r.name},this.onResourceCreated,r.template+"?view=deep")}}},{text:"Cancel",scope:this,margin:3,handler:function(){r.destroy()}}]}).show()},createResource:function(e){var t={mex:null,user:null,image:null,module:null,service:null,system:null,file:null,dataset:null},n=[["dataset"]],r=null;for(var i=0;r=e.children[i];i++)r.name in t||n.push([r.name]);delete t.dataset,store_types=Ext.create("Ext.data.ArrayStore",{fields:[{name:"name"}],data:n});var s=Ext.create("Ext.form.Panel",{frame:!0,bodyStyle:"padding:5px 5px 0",width:350,fieldDefaults:{msgTarget:"side",labelWidth:75},defaultType:"textfield",defaults:{anchor:"100%"},items:[{xtype:"combobox",fieldLabel:"Type",name:"type",allowBlank:!1,store:store_types,displayField:"name",valueField:"name",queryMode:"local",validator:function(e){return e in t?"This type is not allowed for creation!":/[^\w]/.test(e)?"Resource type may only contain word characters: letters, digits, dash and underscore":!0}},{fieldLabel:"Name",name:"name",allowBlank:!1}]}),o=Ext.create("Ext.window.Window",{layout:"fit",modal:!0,border:!1,title:"Create new resource",buttonAlign:"center",items:s,buttons:[{text:"Save",scope:this,handler:function(){var e=s.getForm();if(e.isValid()){var t=e.getValues(),n=BQFactory.make(t.type,undefined,t.name);n.save_("/data_service/"+t.type,callback(this,this.onResourceCreated),callback(this,this.onResourceError)),s.ownerCt.hide()}}},{text:"Cancel",handler:function(e){s.ownerCt.hide()}}]}).show()},onResourceCreated:function(e){document.location="/client_service/view?resource="+e.uri},onResourceError:function(e){BQ.ui.error("Error creating resource: <br>"+e)},onPreferences:function(e){this.preferences=e,this.preferences.registration==="disabled"&&this.queryById("menu_user_register").setVisible(!1),this.queryById("menu_user_register").setHandler(Ext.Function.pass(pageAction,bq.url(this.preferences.registration||"/registration")),this),this.preferences.title&&this.queryById("menu_title").setText('<h3><a href="/">'+this.preferences.title+"</a></h3>")}}),Ext.namespace("BQ.ui"),BQ.ui=function(){function t(e,t,n){return'<div class="msg '+n+'"><img src="/images/cancel.png" /><h3>'+e+"</h3><p>"+t+"</p></div>"}var e;return{message:function(n,r,i,s){e||(e=Ext.core.DomHelper.insertFirst(document.body,{id:"messagepopup"},!0)),i==undefined&&(i=3e3),s==undefined&&(s="");var o=Ext.String.format.apply(String,Array.prototype.slice.call(arguments,1)),u=Ext.core.DomHelper.append(e,t(n,o,s),!0);u.hide(),u.on("click",function(){this.stopAnimation(),this.destroy()},u,{single:!0,stopEvent:!0}),u.slideIn("t").ghost("t",{delay:i,remove:!0})},popup:function(e,t,n){var r=BQ.ui.types[e]||BQ.ui.types.notification;BQ.ui.message(r.title,t,n||r.delay,r.cls)},notification:function(e,t){BQ.ui.popup("notification",e,t)},attention:function(e,t){BQ.ui.popup("attention",e,t)},warning:function(e,t){BQ.ui.popup("warning",e,t)},error:function(e,t){BQ.ui.popup("error",e,t)},tip:function(e,t,n){n=n||{},"color"in n||(n.color="red"),"timeout"in n||(n.timeout=5e3),n.anchor=n.anchor||"top";var r=new Ext.ToolTip({target:e,anchor:n.anchor,bodyStyle:"font-size: 160%; color: "+n.color+";",html:t});r.show(),setTimeout(function(){r.destroy()},n.timeout)},highlight:function(e,t,n){n=n||{},n.timeout=n.timeout||5e3,n.anchor=n.anchor||"top";var r=Ext.create("Ext.ToolTip",Ext.apply({target:e,anchor:n.anchor,cls:"highlight",html:t,autoHide:!1,shadow:!1},n));r.show(),r.getEl().fadeOut({delay:n.timeout})}}}(),BQ.ui.types={notification:{delay:5e3,title:"",cls:"notification"},attention:{delay:1e4,title:"",cls:"warning"},warning:{delay:1e4,title:"Warning",cls:"warning"},error:{delay:5e4,title:"Error",cls:"error"}},Date.prototype.setISO8601=function(e){var t="([0-9]{4})(-([0-9]{2})(-([0-9]{2})([T|\\s]([0-9]{2}):([0-9]{2})(:([0-9]{2})(.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",n=e.match(new RegExp(t)),r=0,i=new Date(n[1],0,1);n[3]&&i.setMonth(n[3]-1),n[5]&&i.setDate(n[5]),n[7]&&i.setHours(n[7]),n[8]&&i.setMinutes(n[8]),n[10]&&i.setSeconds(n[10]),n[12]&&i.setMilliseconds(Number("0."+n[12])*1e3),this.setTime(Number(i))},Date.prototype.setISO=function(e){return this.setISO8601(e)},Date.prototype.toISOString=function(){function e(e){return e<10?"0"+e:e}return this.getFullYear()+"-"+e(this.getMonth()+1)+"-"+e(this.getDate())+" "+e(this.getHours())+":"+e(this.getMinutes())+":"+e(this.getSeconds())},Date.prototype.diff=function(e){return new DateDiff(this-e)},DateDiff.prototype.fromMS=function(e){if(!e)return;this.weeks=0,this.days=0,this.hours=0,this.mins=0,this.secs=0,this.msecs=0,this.weeks=Math.floor(e/6048e5),e-=this.weeks*6048e5,this.days=Math.floor(e/864e5),e-=this.days*864e5,this.hours=Math.floor(e/36e5),e-=this.hours*36e5,this.mins=Math.floor(e/6e4),e-=this.mins*6e4,this.secs=Math.floor(e/1e3),e-=this.secs*1e3,this.msecs=e},DateDiff.prototype.toString=function(){var e="";return this.weeks>0&&(e+=""+this.weeks+" weeks "),this.days>0&&(e+=""+this.days+" days "),this.hours>0&&(e+=""+this.hours+" hours "),this.mins>0&&(e+=""+this.mins+" minutes "),this.secs>0&&(e+=""+this.secs+" seconds "),e==""&&this.msecs>0&&(e+=""+this.msecs+"ms"),e},Encoder={EncodeType:"entity",isEmpty:function(e){return e?e===null||e.length==0||/^\s+$/.test(e):!0},arr1:new Array("&nbsp;","&iexcl;","&cent;","&pound;","&curren;","&yen;","&brvbar;","&sect;","&uml;","&copy;","&ordf;","&laquo;","&not;","&shy;","&reg;","&macr;","&deg;","&plusmn;","&sup2;","&sup3;","&acute;","&micro;","&para;","&middot;","&cedil;","&sup1;","&ordm;","&raquo;","&frac14;","&frac12;","&frac34;","&iquest;","&Agrave;","&Aacute;","&Acirc;","&Atilde;","&Auml;","&Aring;","&Aelig;","&Ccedil;","&Egrave;","&Eacute;","&Ecirc;","&Euml;","&Igrave;","&Iacute;","&Icirc;","&Iuml;","&ETH;","&Ntilde;","&Ograve;","&Oacute;","&Ocirc;","&Otilde;","&Ouml;","&times;","&Oslash;","&Ugrave;","&Uacute;","&Ucirc;","&Uuml;","&Yacute;","&THORN;","&szlig;","&agrave;","&aacute;","&acirc;","&atilde;","&auml;","&aring;","&aelig;","&ccedil;","&egrave;","&eacute;","&ecirc;","&euml;","&igrave;","&iacute;","&icirc;","&iuml;","&eth;","&ntilde;","&ograve;","&oacute;","&ocirc;","&otilde;","&ouml;","&divide;","&Oslash;","&ugrave;","&uacute;","&ucirc;","&uuml;","&yacute;","&thorn;","&yuml;","&quot;","&amp;","&lt;","&gt;","&oelig;","&oelig;","&scaron;","&scaron;","&yuml;","&circ;","&tilde;","&ensp;","&emsp;","&thinsp;","&zwnj;","&zwj;","&lrm;","&rlm;","&ndash;","&mdash;","&lsquo;","&rsquo;","&sbquo;","&ldquo;","&rdquo;","&bdquo;","&dagger;","&dagger;","&permil;","&lsaquo;","&rsaquo;","&euro;","&fnof;","&alpha;","&beta;","&gamma;","&delta;","&epsilon;","&zeta;","&eta;","&theta;","&iota;","&kappa;","&lambda;","&mu;","&nu;","&xi;","&omicron;","&pi;","&rho;","&sigma;","&tau;","&upsilon;","&phi;","&chi;","&psi;","&omega;","&alpha;","&beta;","&gamma;","&delta;","&epsilon;","&zeta;","&eta;","&theta;","&iota;","&kappa;","&lambda;","&mu;","&nu;","&xi;","&omicron;","&pi;","&rho;","&sigmaf;","&sigma;","&tau;","&upsilon;","&phi;","&chi;","&psi;","&omega;","&thetasym;","&upsih;","&piv;","&bull;","&hellip;","&prime;","&prime;","&oline;","&frasl;","&weierp;","&image;","&real;","&trade;","&alefsym;","&larr;","&uarr;","&rarr;","&darr;","&harr;","&crarr;","&larr;","&uarr;","&rarr;","&darr;","&harr;","&forall;","&part;","&exist;","&empty;","&nabla;","&isin;","&notin;","&ni;","&prod;","&sum;","&minus;","&lowast;","&radic;","&prop;","&infin;","&ang;","&and;","&or;","&cap;","&cup;","&int;","&there4;","&sim;","&cong;","&asymp;","&ne;","&equiv;","&le;","&ge;","&sub;","&sup;","&nsub;","&sube;","&supe;","&oplus;","&otimes;","&perp;","&sdot;","&lceil;","&rceil;","&lfloor;","&rfloor;","&lang;","&rang;","&loz;","&spades;","&clubs;","&hearts;","&diams;"),arr2:new Array("&#160;","&#161;","&#162;","&#163;","&#164;","&#165;","&#166;","&#167;","&#168;","&#169;","&#170;","&#171;","&#172;","&#173;","&#174;","&#175;","&#176;","&#177;","&#178;","&#179;","&#180;","&#181;","&#182;","&#183;","&#184;","&#185;","&#186;","&#187;","&#188;","&#189;","&#190;","&#191;","&#192;","&#193;","&#194;","&#195;","&#196;","&#197;","&#198;","&#199;","&#200;","&#201;","&#202;","&#203;","&#204;","&#205;","&#206;","&#207;","&#208;","&#209;","&#210;","&#211;","&#212;","&#213;","&#214;","&#215;","&#216;","&#217;","&#218;","&#219;","&#220;","&#221;","&#222;","&#223;","&#224;","&#225;","&#226;","&#227;","&#228;","&#229;","&#230;","&#231;","&#232;","&#233;","&#234;","&#235;","&#236;","&#237;","&#238;","&#239;","&#240;","&#241;","&#242;","&#243;","&#244;","&#245;","&#246;","&#247;","&#248;","&#249;","&#250;","&#251;","&#252;","&#253;","&#254;","&#255;","&#34;","&#38;","&#60;","&#62;","&#338;","&#339;","&#352;","&#353;","&#376;","&#710;","&#732;","&#8194;","&#8195;","&#8201;","&#8204;","&#8205;","&#8206;","&#8207;","&#8211;","&#8212;","&#8216;","&#8217;","&#8218;","&#8220;","&#8221;","&#8222;","&#8224;","&#8225;","&#8240;","&#8249;","&#8250;","&#8364;","&#402;","&#913;","&#914;","&#915;","&#916;","&#917;","&#918;","&#919;","&#920;","&#921;","&#922;","&#923;","&#924;","&#925;","&#926;","&#927;","&#928;","&#929;","&#931;","&#932;","&#933;","&#934;","&#935;","&#936;","&#937;","&#945;","&#946;","&#947;","&#948;","&#949;","&#950;","&#951;","&#952;","&#953;","&#954;","&#955;","&#956;","&#957;","&#958;","&#959;","&#960;","&#961;","&#962;","&#963;","&#964;","&#965;","&#966;","&#967;","&#968;","&#969;","&#977;","&#978;","&#982;","&#8226;","&#8230;","&#8242;","&#8243;","&#8254;","&#8260;","&#8472;","&#8465;","&#8476;","&#8482;","&#8501;","&#8592;","&#8593;","&#8594;","&#8595;","&#8596;","&#8629;","&#8656;","&#8657;","&#8658;","&#8659;","&#8660;","&#8704;","&#8706;","&#8707;","&#8709;","&#8711;","&#8712;","&#8713;","&#8715;","&#8719;","&#8721;","&#8722;","&#8727;","&#8730;","&#8733;","&#8734;","&#8736;","&#8743;","&#8744;","&#8745;","&#8746;","&#8747;","&#8756;","&#8764;","&#8773;","&#8776;","&#8800;","&#8801;","&#8804;","&#8805;","&#8834;","&#8835;","&#8836;","&#8838;","&#8839;","&#8853;","&#8855;","&#8869;","&#8901;","&#8968;","&#8969;","&#8970;","&#8971;","&#9001;","&#9002;","&#9674;","&#9824;","&#9827;","&#9829;","&#9830;"),HTML2Numerical:function(e){return this.swapArrayVals(e,this.arr1,this.arr2)},NumericalToHTML:function(e){return this.swapArrayVals(e,this.arr2,this.arr1)},numEncode:function(e){if(this.isEmpty(e))return"";var t="";for(var n=0;n<e.length;n++){var r=e.charAt(n);if(r<" "||r>"~")r="&#"+r.charCodeAt()+";";t+=r}return t},htmlDecode:function(e){var t,n,r=e;if(this.isEmpty(r))return"";r=this.HTML2Numerical(r),arr=r.match(/&#[0-9]{1,5};/g);if(arr!=null)for(var i=0;i<arr.length;i++)n=arr[i],t=n.substring(2,n.length-1),t>=-32768&&t<=65535?r=r.replace(n,String.fromCharCode(t)):r=r.replace(n,"");return r},htmlEncode:function(e,t){if(this.isEmpty(e))return"";t=t||!1,t&&(this.EncodeType=="numerical"?e=e.replace(/&/g,"&#38;"):e=e.replace(/&/g,"&amp;")),e=this.XSSEncode(e,!1);if(this.EncodeType=="numerical"||!t)e=this.HTML2Numerical(e);return e=this.numEncode(e),t||(e=e.replace(/&#/g,"##AMPHASH##"),this.EncodeType=="numerical"?e=e.replace(/&/g,"&#38;"):e=e.replace(/&/g,"&amp;"),e=e.replace(/##AMPHASH##/g,"&#")),e=e.replace(/&#\d*([^\d;]|$)/g,"$1"),t||(e=this.correctEncoding(e)),this.EncodeType=="entity"&&(e=this.NumericalToHTML(e)),e},XSSEncode:function(e,t){return this.isEmpty(e)?"":(t=t||!0,t?(e=e.replace(/\'/g,"&#39;"),e=e.replace(/\"/g,"&quot;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;")):(e=e.replace(/\'/g,"&#39;"),e=e.replace(/\"/g,"&#34;"),e=e.replace(/</g,"&#60;"),e=e.replace(/>/g,"&#62;")),e)},hasEncoded:function(e){return/&#[0-9]{1,5};/g.test(e)?!0:/&[A-Z]{2,6};/gi.test(e)?!0:!1},stripUnicode:function(e){return e.replace(/[^\x20-\x7E]/g,"")},correctEncoding:function(e){return e.replace(/(&amp;)(amp;)+/,"$1")},swapArrayVals:function(e,t,n){if(this.isEmpty(e))return"";var r;if(t&&n&&t.length==n.length)for(var i=0,s=t.length;i<s;i++)r=new RegExp(t[i],"g"),e=e.replace(r,n[i]);return e},inArray:function(e,t){for(var n=0,r=t.length;n<r;n++)if(t[n]===e)return n;return-1}},Ext.namespace("Bisque.ResourceBrowser"),Ext.require(["Ext.tip.*"]),Ext.tip.QuickTipManager.init(),Ext.define("Bisque.ResourceBrowser.Dialog",{extend:"Ext.window.Window",constructor:function(e){e=e||{},e.height=e.height||"85%",e.width=e.width||"85%",e.selType=e.selType||"MULTI",e.showOrganizer="showOrganizer"in e?e.showOrganizer:!0;var t=Ext.getBody().getViewSize(),n=parseInt(e.height.toString().indexOf("%")==-1?e.height:t.height*parseInt(e.height)/100),r=parseInt(e.width.toString().indexOf("%")==-1?e.width:t.width*parseInt(e.width)/100);Ext.apply(this,{layout:"fit",title:"Resource Browser",modal:!0,border:!1,height:n,width:r,items:new Bisque.ResourceBrowser.Browser(e)},e),this.dockedItems=[{xtype:"toolbar",dock:"bottom",layout:{type:"hbox",align:"middle",pack:"center"},padding:10,items:[{xtype:"buttongroup",margin:5,items:[{text:"Select",iconCls:"icon-select",scale:"medium",width:90,handler:this.btnSelect,scope:this}]},{xtype:"buttongroup",margin:5,items:[{text:"Cancel",iconCls:"icon-cancel",textAlign:"left",scale:"medium",width:90,handler:this.destroy,scope:this}]}]}],this.callParent([arguments]),this.browser=this.getComponent(0),this.browser.on("Select",function(e,t){this.destroy()},this),this.show()},btnSelect:function(){var e=this.browser.resourceQueue.selectedRes,t=Ext.Object.getValues(e);if(t.length)if(t.length==1)this.browser.fireEvent("Select",this,t[0].resource);else{for(var n=0,r=[];n<t.length;n++)r.push(t[n].resource);this.browser.fireEvent("Select",this,r)}else BQ.ui.message("Selection empty!","Please select an image or press cancel to abort.")}}),Ext.define("Bisque.QueryBrowser.Dialog",{extend:"Bisque.ResourceBrowser.Dialog",btnSelect:function(){var e=this.browser.commandBar.getComponent("searchBar").getValue();e&&e.length>1?this.browser.fireEvent("Select",this,e):BQ.ui.message("Query is empty!","Please type a query or press cancel to abort.")}}),Ext.define("Bisque.ResourceBrowser.Browser",{extend:"Ext.panel.Panel",alias:"widget.bq-resource-browser",constructor:function(e){var t=new Image;t.src=bq.url("/js/ResourceBrowser/Images/loading.gif"),this.westPanel=new Ext.panel.Panel({region:"west",split:!0,layout:"fit",cls:"organizer",frame:!0,header:!1,hidden:!0,collapsible:!0,hideCollapseTool:!0,listeners:{beforecollapse:function(e){e.setTitle(e.getComponent(0).title)}}}),this.centerPanel=new Ext.Panel({region:"center",border:!1,layout:"fit"}),e=e||{},Ext.apply(this,{browserParams:e,layoutKey:parseInt(e.layout),viewMgr:Ext.create("Bisque.ResourceBrowser.viewStateManager",e.viewMode),organizerCt:null,datasetCt:null,layoutMgr:null,browserState:{},resourceQueue:[],msgBus:new Bisque.Misc.MessageBus,gestureMgr:null,showGroups:!1,preferenceKey:"ResourceBrowser",bodyCls:"browser-main",border:!1,title:e.title||"",layout:"border",items:[this.westPanel,this.centerPanel],listeners:e.listeners||{}},e),this.commandBar=new Bisque.ResourceBrowser.CommandBar({browser:this}),this.tbar=this.commandBar,this.callParent([arguments]),this.loadPreferences(),Ext.supports.Touch&&(this.gestureMgr=new Bisque.Misc.GestureManager)},loadPreferences:function(e,t){if(e==undefined)BQ.Preferences.get({type:"user",key:this.preferenceKey,callback:Ext.bind(this.loadPreferences,this)});else{this.preferences=e,this.applyPreferences(),Ext.apply(this.browserParams,{layout:this.browserParams.layout||1,dataset:this.browserParams.dataset||"/data_service/image/",offset:this.browserParams.offset||0,tagQuery:this.browserParams.tagQuery||"",tagOrder:this.browserParams.tagOrder||'"@ts":desc',wpublic:this.browserParams.wpublic=="true"?!0:!1,selType:(this.browserParams.selType||"SINGLE").toUpperCase()}),this.browserState.offset=this.browserParams.offset,this.layoutKey=this.layoutKey||this.browserParams.layout,this.showOrganizer=this.browserParams.showOrganizer||!1,this.selectState=this.browserParams.selectState||"ACTIVATE",this.commandBar.applyPreferences();if(this.browserParams.dataset!="None"){var n=this.browserParams.dataset instanceof BQDataset?this.browserParams.dataset.uri+"/value":this.browserParams.dataset;this.loadData({baseURL:n,offset:this.browserParams.offset,tag_query:this.browserParams.tagQuery,tag_order:this.browserParams.tagOrder});var r=this.commandBar.getComponent("btnGear").menu.getComponent("btnOrganize");this.showOrganizer?r.handler.call(this.commandBar):""}}},applyPreferences:function(){var e=this.preferences.Browser;e!=undefined&&!this.browserParams.viewMode&&(this.browserParams.tagQuery=this.browserParams.tagQuery||e["Tag Query"],this.layoutKey=parseInt(this.browserParams.layout||Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS[e.Layout]),this.browserParams.wpublic=e["Include Public Resources"]==undefined?this.browserParams.wpublic:e["Include Public Resources"])},loadData:function(e){function a(e){e&&(this.uri.baseURL=e.uri+"/value"),this.browserState.baseURL=this.uri.baseURL;for(var t in this.uri)this.uri[t].length==0&&delete this.uri[t];this.resourceQueue=new Bisque.ResourceBrowser.ResourceQueue,this.resourceQueue.init({callBack:callback(this,"dataLoaded"),browser:this,uri:this.uri})}this.loading=!0,this.on("afterlayout",function(e){e.centerPanel.setLoading(e.loading)}),this.centerPanel.setLoading({msg:""}),e=e||null;if(e){e.tag_query==undefined&&(e.tag_query=this.browserState.tag_query||""),e.tag_order==undefined&&(e.tag_order=this.browserState.tag_order||""),e.offset==undefined&&(e.offset=this.browserState.offset),e.baseURL||(e.baseURL=this.browserState.baseURL),e.wpublic=this.browserParams.wpublic;function t(e){if(e.indexOf("@ts")==-1){var t=this.commandBar.getComponent("btnTS").sortState;e+=e?",":"",e+=t=="ASC"?'"@ts":asc':'"@ts":desc'}return e}e.tag_order=t.call(this,e.tag_order),this.setBrowserState(e)}else var e=this.getURIFromState();if(e.tag_order){var n=e.tag_order.split(","),r=[],i=[],s;function o(e){return e.length<2?e:e.substring(1,e.length-1)}for(var u=0;u<n.length;u++)s=n[u].split(":"),o(s[0])!="@ts"&&(r.push(o(s[0])),i.push(s[1].toUpperCase()));e.view=r.join(","),r.length>=1&&(this.showGroups={tags:r,order:i})}else this.showGroups=!1;this.uri=e,e.baseURL instanceof BQDataset?e.baseURL.getMembers(Ext.bind(a,this)):a.call(this)},dataLoaded:function(){function e(){this.ChangeLayout(this.layoutKey),this.eventsManaged||this.ManageEvents()}this.fireEvent("browserLoad",this,this.resourceQueue),this.rendered?e.call(this):this.on("afterlayout",Ext.bind(e,this),{single:!0})},ChangeLayout:function(e,t){this.loading=!1,this.centerPanel.setLoading(this.loading),t=t||"none",this.layoutMgr&&this.layoutMgr.destroy(),this.layoutKey=e==-1?this.layoutKey:e,this.layoutMgr=Bisque.ResourceBrowser.LayoutFactory.getLayout({browser:this,direction:t}),this.resourceQueue.changeLayout({key:this.layoutKey,layoutMgr:this.layoutMgr}),this.layoutMgr.Init(this.resourceQueue.getMainQ(this.layoutMgr.getVisibleElements(t),this.layoutMgr)),this.centerPanel.add(this.layoutMgr),this.updateTbarItemStatus()},ManageEvents:function(){this.eventsManaged=!0,this.addEvents("Select"),this.changeLayoutThrottled=Ext.Function.createThrottled(this.ChangeLayout,400,this),this.centerPanel.on("resize",Ext.bind(this.ChangeLayout,this,[-1])),this.centerPanel.getEl().on("mousewheel",function(e){if(this.layoutMgr.key!=Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.Full)if(e.getWheelDelta()>0){var t=this.commandBar.getComponent("btnLeft");t.disabled||t.handler.call(t.scope,t)}else{var n=this.commandBar.getComponent("btnRight");n.disabled||n.handler.call(n.scope,n)}},this),Ext.create("Ext.util.KeyMap",{target:Ext.getDoc(),binding:[{key:"aA",ctrl:!0,handler:function(e,t){this.layoutMgr.toggleSelectAll()},defaultEventAction:"stopEvent",scope:this}]}),this.msgBus.mon(this.msgBus,{ResourceDblClick:function(e){this.browserParams.selType=="MULTI"&&this.selectState=="ACTIVATE"&&this.fireEvent("Select",this,e)},ResourceSingleClick:function(e){this.browserParams.selType=="SINGLE"&&this.selectState=="ACTIVATE"&&this.fireEvent("Select",this,e)},Browser_ReloadData:function(e){if(e=="")this.resourceQueue=new Bisque.ResourceBrowser.ResourceQueue({callBack:callback(this,"ChangeLayout",this.layoutKey),browser:this,uri:""});else if(e=="ReloadPrefs"){var t=BQSession.current_session.user;t&&(BQ.Preferences.reloadUser(t),this.browserParams={},this.loadPreferences())}else this.loadData(e)},scope:this}),this.gestureMgr&&this.gestureMgr.addListener({dom:this.centerPanel.getEl().dom,eventName:"swipe",listener:Ext.bind(function(e,t){if(t.direction=="left"){var n=this.commandBar.getComponent("btnRight");n.disabled||n.handler.call(n.scope,n)}else{var r=this.commandBar.getComponent("btnLeft");r.disabled||r.handler.call(r.scope,r)}},this),options:{swipeThreshold:100}})},setBrowserState:function(e){this.browserState.baseURL=e.baseURL,this.browserState.tag_query=e.tag_query,this.browserState.wpublic=this.browserParams.wpublic,this.browserState.layout=this.layoutKey,this.browserState.tag_order=e.tag_order},updateTbarItemStatus:function(){var e=this.commandBar.getComponent("btnRight"),t=this.commandBar.getComponent("btnLeft"),n=this.resourceQueue.getStatus();this.commandBar.setStatus(n),t.setDisabled(n.left||n.loading.left),e.setDisabled(n.right||n.loading.right),this.commandBar.slider.slider.setDisabled(t.disabled&&e.disabled),this.commandBar.btnTSSetState(this.browserState.tag_order.toLowerCase()),this.commandBar.btnSearchSetState(this.browserState.tag_query),this.commandBar.btnActivateSetState(this.selectState)},getURIFromState:function(){var e={baseURL:this.browserState.baseURL,offset:this.browserState.offset,tag_query:this.browserState.tag_query||"",tag_order:this.browserState.tag_order||"",wpublic:this.browserParams.wpublic};for(var t in e)e[t].length==0&&delete e[t];return e},findRecord:function(e){return this.resourceQueue.find(e)}}),Ext.define("Bisque.ResourceBrowser.LayoutFactory",{statics:{baseClass:"Bisque.ResourceBrowser.Layout",getClass:function(e){var t=Ext.Object.getKey(Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS,e),n=Bisque.ResourceBrowser.LayoutFactory.baseClass+"."+t;return n},getLayout:function(e){var t=this.getClass(e.browser.layoutKey);return Ext.ClassManager.get(t)?Ext.create(t,e):(Ext.log({msg:Ext.String.format("Unknown layout: {0}",t),level:"warn",stack:!0}),Ext.create(Bisque.ResourceBrowser.Layout+".Base",e))}}}),Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS={Compact:1,Card:2,PStrip:3,PStripBig:3.1,Full:4,List:5,IconList:6,Page:7,Grid:8,COMPACT:1,CARD:2},Bisque.ResourceBrowser.LayoutFactory.DEFAULT_LAYOUT=Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.Compact,Ext.define("Bisque.ResourceBrowser.Layout.Base",{extend:"Ext.panel.Panel",inheritableStatics:{layoutCSS:null,readCSS:function(){var e={};return e.layoutCSS=this.layoutCSS,e.layoutEl={width:null,height:null},e.layoutCSS&&(e.css=Ext.util.CSS.getRule("."+e.layoutCSS).style,e.layoutEl.padding=parseInt(e.css.padding),e.layoutEl.margin=parseInt(e.css.margin),e.layoutEl.border=parseInt(e.css.borderWidth),e.layoutEl.width=e.css["width"].indexOf("%")==-1?parseInt(e.css.width):e.css.width,e.layoutEl.height=e.css["height"].indexOf("%")==-1?parseInt(e.css.height):e.css.height,e.layoutEl.outerWidth=e.layoutEl.width+(e.layoutEl.padding+e.layoutEl.border+2*e.layoutEl.margin),e.layoutEl.outerHeight=e.layoutEl.height+(e.layoutEl.padding+e.layoutEl.border+2*e.layoutEl.margin)),e}},constructor:function(e){Ext.apply(this,{browser:e.browser,direction:e.direction,key:e.browser.layoutKey,parentCt:e.browser.centerPanel,msgBus:e.browser.msgBus,showGroups:e.browser.showGroups,resQ:[],layoutEl:{},border:!1,autoScroll:!0,toggleAll:!1}),this.callParent(arguments),Ext.apply(this,Ext.ClassManager.getClass(this).readCSS()),this.manageEvents()},manageEvents:function(){this.browser.selType=="SINGLE"?this.on({select:function(e){Ext.Object.getSize(this.browser.resourceQueue.selectedRes)!=0&&this.browser.resourceQueue.selectedRes.toggleSelect(!1),this.browser.resourceQueue.selectedRes=e,this.msgBus.fireEvent("ResSelectionChange",[e.resource.uri])},unselect:function(e){this.browser.resourceQueue.selectedRes={},this.msgBus.fireEvent("ResSelectionChange",[])},scope:this}):this.on({select:function(e){this.browser.resourceQueue.selectedRes[e.resource.uri]=e;var t=this.browser.resourceQueue.selectedRes,n=Ext.Object.getKeys(t),r=[];for(var i=0;i<n.length;i++)r.push(n[i]);this.msgBus.fireEvent("ResSelectionChange",r)},unselect:function(e){delete this.browser.resourceQueue.selectedRes[e.resource.uri];var t=this.browser.resourceQueue.selectedRes,n=Ext.Object.getKeys(t),r=[];for(var i=0;i<n.length;i++)r.push(t[i]);this.msgBus.fireEvent("ResSelectionChange",r)},scope:this})},toggleSelectAll:function(){this.toggleAll=!this.toggleAll;if(this.browser.selType!="SINGLE")for(var e=0;e<this.resQ.length;e++)this.resQ[e].toggleSelect(this.toggleAll),this.resQ[e].fireEvent("select",this.resQ[e])},Init:function(e,t){this.resQ=e,t||(t=this);var n=[],r=[],i=0,s;if(this.resQ.length==0){this.noResults();return}if(this.showGroups)while(i<this.resQ.length){s=this.getGroup(this.resQ[i]);while(i<this.resQ.length&&this.getGroup(this.resQ[i])==s)this.resQ[i].setSize({width:this.layoutEl.width,height:this.layoutEl.height}),this.resQ[i].addCls(this.layoutCSS),r.push(this.resQ[i]),this.relayEvents(this.resQ[i],["select","unselect"]),i++;n.push(new Ext.form.FieldSet({items:r,cls:"fieldSet",margin:"8 0 0 8",width:this.getParentSize().width-30,padding:0,title:"<b>Group </b><i>"+Ext.String.ellipsis(s,80)+"</i>",collapsible:!0,collapsed:!1})),r=[]}else for(var i=0;i<this.resQ.length;i++)this.resQ[i].setSize({width:this.layoutEl.width,height:this.layoutEl.height}),this.resQ[i].addCls(this.layoutCSS),this.browser.resourceQueue.selectedRes[this.resQ[i].resource.uri]&&(this.resQ[i].cls="resource-view-selected"),n.push(this.resQ[i]),this.relayEvents(this.resQ[i],["select","unselect"]);t.add(n)},noResults:function(){this.imgNoResults=Ext.create("Ext.Img",{width:300,margin:0,padding:0,src:bq.url("/js/ResourceBrowser/Images/no-results.png")});var e=Ext.create("Ext.panel.Panel",{border:!1,layout:{type:"vbox",pack:"center",align:"center"}});e.addListener("afterlayout",function(e){e.add(this.imgNoResults)},this,{single:!0}),this.layout="fit",this.add(e)},getParentSize:function(){return this.browser.centerPanel.getSize()},getVisibleElements:function(e){var t=this.getParentSize(),n=Math.floor(t.height/this.layoutEl.outerHeight),r=Math.floor(t.width/this.layoutEl.outerWidth);return this.showGroups?this.getNoGroupedElements(this.browser.resourceQueue.getTempQ(n*r,e)):n*r},getNoGroupedElements:function(e){var t,n=0,r=1,i={};i[r]=0;while(n<e.length&&!this.containerFull(i)){t=this.getGroup(e[n]);while(n<e.length&&!this.containerFull(i)&&this.getGroup(e[n])==t)i[r]=i[r]+1,n++;if(this.containerFull(i)){n--;break}r++,i[r]=0}return n},getGroup:function(e){var t="",n={},r,i=e.resource.tags,r;for(var s=0;s<i.length;s++)n[i[s].name]=i[s].value;for(var o=0;o<this.showGroups.tags.length;o++)r=n[this.showGroups.tags[o]],t+=this.showGroups.tags[o]+(r?":"+r:"")+", ";return t.substring(0,t.length-2)},containerFull:function(e){var t=42,n=this.getParentSize(),r=n.height-Ext.Object.getSize(e)*t,i=Math.floor(r/this.layoutEl.outerHeight),s=Math.floor(n.width/this.layoutEl.outerWidth),o=0;for(var u in e)o+=Math.ceil(e[u]/s);return o>i}}),Ext.define("Bisque.ResourceBrowser.Layout.Compact",{extend:"Bisque.ResourceBrowser.Layout.Base",inheritableStatics:{layoutCSS:"ImageCompact"},constructor:function(){this.callParent(arguments),this.layoutEl.imageWidth=150,this.layoutEl.imageHeight=150}}),Ext.define("Bisque.ResourceBrowser.Layout.Card",{extend:"Bisque.ResourceBrowser.Layout.Base",inheritableStatics:{layoutCSS:"ImageCard"},constructor:function(){this.callParent(arguments),this.layoutEl.imageWidth=140,this.layoutEl.imageHeight=115}}),Ext.define("Bisque.ResourceBrowser.Layout.PStrip",{extend:"Bisque.ResourceBrowser.Layout.Base",inheritableStatics:{layoutCSS:"ImagePStripSmall"},constructor:function(){Ext.apply(this,{layout:{type:"vbox",align:"stretch"}}),this.callParent(arguments),this.layoutEl.imageWidth=150,this.layoutEl.imageHeight=150,this.setSize(this.getParentSize())},Init:function(e){this.resQ=e;if(this.resQ.length==0){this.noResults();return}this.proxyPnl=Ext.create("Ext.panel.Panel",{border:!1,flex:1,autoScroll:!0,layout:{type:"hbox",align:"middle",pack:"center"}});var t=Ext.create("Ext.panel.Panel",{border:!1});for(var n=0;n<this.resQ.length;n++)this.resQ[n].setSize({width:this.layoutEl.width,height:this.layoutEl.height}),this.resQ[n].addCls(this.layoutCSS),t.add(this.resQ[n]),this.relayEvents(this.resQ[n],["select","unselect"]);this.add([this.proxyPnl,t]),this.resQ.length&&this.on("afterlayout",function(){this.CreateBigResource(this.resQ[0].resource,this)},this),this.msgBus.on("PStripResourceClick",this.CreateBigResource)},getVisibleElements:function(){var e=this.getParentSize(),t=Math.floor(e.width/this.layoutEl.outerWidth);return t},CreateBigResource:function(e,t){var n=Bisque.ResourceFactory.getResource({resource:e,browser:t.browser,layoutKey:Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.PStripBig,msgBus:t.msgBus,bigPanel:t.proxyPnl});t.proxyPnl.add(0,n),t.proxyPnl.animate({from:{opacity:0},to:{opacity:1},easing:"easeIn",duration:180}),t.proxyPnl.items.length>1&&t.proxyPnl.getComponent(t.proxyPnl.items.length-1).destroy()}}),Ext.define("Bisque.ResourceBrowser.Layout.Full",{extend:"Bisque.ResourceBrowser.Layout.Base",inheritableStatics:{layoutCSS:"ImageFull"},constructor:function(){this.callParent(arguments),this.layoutEl.imageHeight=275,this.layoutEl.imageWidth=280},getVisibleElements:function(){return 10}}),Ext.define("Bisque.ResourceBrowser.Layout.List",{extend:"Bisque.ResourceBrowser.Layout.Full",inheritableStatics:{layoutCSS:"ResourceList"},getVisibleElements:function(){return 35}}),Ext.define("Bisque.ResourceBrowser.Layout.IconList",{extend:"Bisque.ResourceBrowser.Layout.List",inheritableStatics:{layoutCSS:"ResourceIconList"},constructor:function(){this.callParent(arguments),this.layoutEl.iconHeight=110,this.layoutEl.iconWidth=110},getVisibleElements:function(){return 3500}}),Ext.define("Bisque.ResourceBrowser.Layout.Page",{extend:"Bisque.ResourceBrowser.Layout.Base",inheritableStatics:{layoutCSS:null}}),Ext.define("Bisque.ResourceBrowser.Layout.Grid",{extend:"Bisque.ResourceBrowser.Layout.Base",inheritableStatics:{layoutCSS:null},constructor:function(){Ext.apply(this,{layout:"fit"}),this.callParent(arguments)},Init:function(e){if(e.length==0){this.noResults();return}this.layoutConfig=this.browser.layoutConfig||{},this.add(this.getResourceGrid());var t,n=[];for(var r=0;r<e.length;r++)n.push(e[r].getFields());this.resourceStore.loadData(n);var i=this.resourceGrid.getSelectionModel();this.resQ=e,this.resourceGrid.on("afterrender",function(e){var t=this.resQ,n=this.resourceGrid.getSelectionModel();for(var r=0;r<t.length;r++)this.browser.resourceQueue.selectedRes[t[r].resource.uri]&&n.select(r,!0)},this,{single:!0})},getVisibleElements:function(e){var t=this.getParentSize().height-22,n=Math.floor(t/21)+1,r=this.browser.resourceQueue.getTempQ(n,e),i,s=0;for(var o=0;o<r.length;o++){i=r[o].getFields()[6].height;if(s+i>t)break;s+=i}return o},getResourceGrid:function(){return this.resourceGrid=Ext.create("Ext.grid.Panel",{store:this.getResourceStore(),border:0,multiSelect:!0,simpleSelect:!0,listeners:{scope:this,itemclick:function(e,t,n,r){var i=t.get("raw");this.browser.msgBus.fireEvent("ResourceSingleClick",i.resource),this.fireEvent("select",i)},itemdblclick:function(e,t,n,r){var i=t.get("raw");this.browser.msgBus.fireEvent("ResourceDblClick",i.resource)}},plugins:new Ext.ux.DataTip({tpl:"<div>{name}:{value}</div>"}),columns:{items:[{dataIndex:"icon",menuDisabled:!0,sortable:!1,align:"center",maxWidth:this.layoutConfig.colIconWidth||70,minWidth:1},{text:this.layoutConfig.colNameText||"Name",dataIndex:"name",align:"left",flex:.4},{text:this.layoutConfig.colValueText||"Owner",dataIndex:"value",flex:.6},{text:"Type",dataIndex:"type",hidden:!0},{text:this.layoutConfig.colDateText||"Date created",dataIndex:"ts",flex:.4}],defaults:{tdCls:"align",align:"center",sortable:!0,flex:.4}}}),this.resourceGrid},getResourceStore:function(){return this.resourceStore=Ext.create("Ext.data.ArrayStore",{fields:["icon","name","value","type",{name:"ts",convert:function(e){var t=new Date,n=new Date;t.setISO(e);var r=Math.round((n-t)/864e5),i=r?"n/j/Y":"g:i A";return Ext.Date.format(t,i)}},"raw"]}),this.resourceStore}}),Ext.define("Bisque.ResourceBrowser.Organizer",{extend:"Ext.panel.Panel",defaults:{border:0},constructor:function(){Ext.apply(this,{parentCt:arguments[0].parentCt,dataset:arguments[0].dataset,wpublic:arguments[0].wpublic,msgBus:arguments[0].msgBus,uri:arguments[0].browser.uri,tag_order:arguments[0].browser.uri.tag_order||"",tag_query:arguments[0].browser.uri.tag_query||"",title:"Organizer",width:305,itemId:"organizerCt",layout:"accordion",border:!1,tbar:{items:[{iconCls:"icon-add",text:"Add",tooltip:"Add new filter",handler:this.AddFilter,scope:this},{iconCls:"icon-refresh",text:"Reset",tooltip:"Reset all filters",handler:this.resetFilters,scope:this}]},existingTags:new Array,items:[],tools:[{type:"left",title:"Collapse organizer panel",tooltip:"Collapse organizer panel",handler:function(){this.parentCt.hideCollapseTool=!1,this.parentCt.collapse()},scope:this}]}),this.callParent(arguments),this.on("afterrender",function(){this.initFilters(this.uri),this.ManageEvents()},this,{single:!0})},initFilters:function(e){this.tag_order=e.tag_order||"",this.tag_query=e.tag_query||"",this.tag_order=this.tag_order.replace(/"/g,"").split(","),this.tag_query=this.parseTagQuery(this.tag_query.replace(/"/g,""));var t=0;for(var n=0;n<this.tag_order.length;n++){if(this.tag_order[n].indexOf("@ts")!=-1)continue;t++;var r=this.tag_order[n].split(":"),i=new Bisque.ResourceBrowser.Organizer.TagFilterCt({parent:this,tag_order:r,tag_query:this.tag_query[r[0]]||""});this.add(i),i.addEvents("onFilterDragDrop"),this.relayEvents(i,["onFilterDragDrop"])}t==0&&this.AddFilter()},parseTagQuery:function(e){var t={},n,r,i,s=e.split(" AND ");for(var o=0;o<s.length;o++){i=s[o].split(" OR "),n=[];for(var u=0;u<i.length;u++)r=i[u].split(":"),n.push(r[1]);t[r[0]]=n||""}return t},AddFilter:function(){var e=new Bisque.ResourceBrowser.Organizer.TagFilterCt({parent:this});this.add(e),e.addEvents("onFilterDragDrop"),this.relayEvents(e,["onFilterDragDrop"]),e.expand(!0)},ManageEvents:function(){this.msgBus.on("Organizer_OnCBSelect",function(e){this.CBSelect(e),this.ReloadBrowserData()},this),this.msgBus.on("Organizer_OnGridSelect",function(){this.GridSelect(),this.ReloadBrowserData()},this),this.on("onFilterDragDrop",this.ReorderFilters,this)},ReorderFilters:function(e){var t=this.items.keys.indexOf(e.source),n=this.items.keys.indexOf(e.sink),r=Ext.fly(e.source),i=this.getComponent(n).el;this.items.indexOf(n)<this.items.indexOf(t)?(r.insertBefore(i),this.items.insert(t,this.items.removeAt(n))):(r.insertAfter(i),this.items.insert(t+1,this.items.removeAt(n))),this.ReloadBrowserData()},CBSelect:function(e){this.PopulateGrid(!1,e),this.AddNewTag(e.oldTag,e.getId()),this.existingTags.push(e.tag),this.RemoveExistingTags(e.tag,e.getId())},GridSelect:function(){for(var e=0;e<this.items.length;e++){if(this.getComponent(e).value.length>0)continue;this.PopulateGrid(!1,this.getComponent(e))}},ReloadBrowserData:function(){var e={offset:0,tag_query:this.GetTagQuery(),tag_order:this.GetTagOrder()};this.msgBus.fireEvent("Browser_ReloadData",e),this.msgBus.fireEvent("SearchBar_Query",this.GetTagQuery())},PopulateGrid:function(e,t,n){if(!e){t.grid.setLoading({msg:""});var r=this.GetTagQuery(),i=Ext.String.urlAppend(this.dataset,"{0}="+t.tag+"&wpublic="+this.browser.browserParams.wpublic+(r.length?"&tag_query="+r:"")),i=Ext.String.format(i,t.tagType=="tag"?"tag_values":"gob_names");BQFactory.load(i,callback(this,"PopulateGrid",!0,t))}else{t.grid.setLoading(!1);var s=[],o=t.tagType=="tag"?n.tags:n.gobjects;for(var u=0;u<o.length;u++)s.push(new Ext.grid.property.Property({name:u+1,value:t.tagType=="tag"?o[u].value:o[u].name}));t.grid.store.loadData(s);var a,f=t.grid.getSelectionModel();for(var u=0;u<t.tag_query.length;u++)a=t.grid.store.findExact("value",t.tag_query[u]),f.select(t.grid.store.getAt(a),!0),t.OnGridSelect()}},AddNewTag:function(e,t){if(this.existingTags.indexOf(e)>=0){this.existingTags.splice(this.existingTags.indexOf(e),1);for(var n=0;n<this.items.length;n++)this.getComponent(n).getId()!=t&&(this.getComponent(n).tagCombo.store.loadData([e],!0),this.getComponent(n).SortComboBox("ASC"))}},RemoveExistingTags:function(e,t){for(var n=0;n<this.items.length;n++)if(this.getComponent(n).getId()!=t){var r=this.getComponent(n).tagCombo;r.store.remove(r.findRecord(r.displayField,e))}},GetTagOrder:function(){var e="";for(var t=0;t<this.items.length;t++){if(this.getComponent(t).tag==""||this.getComponent(t).tagType!="tag")continue;e=e+'"'+encodeURIComponent(this.getComponent(t).tag)+'":'+(this.getComponent(t).sortOrder==""?"asc":this.getComponent(t).sortOrder)+","}return e.substring(0,e.length-1)},GetTagQuery:function(){var e="";for(var t=0;t<this.items.length;t++){var n=this.getComponent(t).GetTagValuePair();n!=""&&(e+=n+" AND ")}return e.substring(0,e.length-5)},resetFilters:function(){while(this.items.length!=0)this.getComponent(0).destroy()}}),Ext.define("Bisque.ResourceBrowser.Organizer.TagFilterCt",{extend:"Ext.panel.Panel",cls:"organizer-filter",constructor:function(){Ext.apply(this,{layout:{type:"vbox",align:"stretch"},parent:arguments[0].parent,tag_order:arguments[0].tag_order||"",tag_query:arguments[0].tag_query||"",tag:"",oldTag:"",sortOrder:"",value:new Array,tagCombo:[],grid:[],titleCollapse:!0,collapsible:!0,hideCollapseTool:!0,frame:!0,border:!1,tools:[{type:"up",tooltip:"Sort ascending",handler:function(){this.sortOrder="asc",this.SetTitle(),this.ownerCt.ReloadBrowserData()},scope:this},{type:"down",tooltip:"Sort descending",handler:function(){this.sortOrder="desc",this.SetTitle(),this.ownerCt.ReloadBrowserData()},scope:this},{type:"close",tooltip:"Close this filter",handler:this.destroy,scope:this}]}),this.callParent(arguments),this.on("afterrender",function(e){var t=new Ext.dd.DragSource(e.id,{dragData:e.id});t.setHandleElId(e.header.id);var n=new Ext.dd.DropTarget(e.id,{filterCt:this,notifyDrop:function(e,t,n){this.filterCt.fireEvent("onFilterDragDrop",{source:n,sink:this.id})}})},this),this.GenerateComponents(),this.GetTagList(!1)},SetTitle:function(){var e=this.tag||"";e+=this.sortOrder?":"+this.sortOrder:"",e+=this.value.length!=0?":"+this.value:"",this.setTitle('<span class="TagStyle">'+e+"</span>")},SortComboBox:function(e){this.tagCombo.store.sort(this.tagCombo.displayField,e)},GetTagList:function(e,t,n){if(!e){var r=this.parent.GetTagQuery(),i=Ext.String.urlAppend(this.parent.dataset,"{0}=1&wpublic="+this.parent.browser.browserParams.wpublic+(r.length?"&tag_query="+r:""));BQFactory.load(Ext.String.format(i,"tag_names"),Ext.bind(this.GetTagList,this,[!0,"tag"],0)),BQFactory.load(Ext.String.format(i,"gob_types"),Ext.bind(this.GetTagList,this,[!0,"gobject"],0))}else if(t=="tag"){var s=[];for(a=0;a<n.tags.length;a++)s.push({name:n.tags[a].name?n.tags[a].name.toString():"",value:"tag"});this.tagArr=s,this.tagArrLoaded=!0}else if(t=="gobject"){var o=[];for(a=0;a<n.gobjects.length;a++){var u=n.gobjects[a].type||"";o.push({name:u.toString(),value:"gobject"})}this.gobArr=o,this.gobArrLoaded=!0}if(this.tagArrLoaded&&this.gobArrLoaded){this.tagCombo.store.loadData(this.tagArr.concat(this.gobArr),!1),this.tagCombo.setLoading(!1);for(var a=0;a<this.parent.existingTags.length;a++)this.tagCombo.store.remove(this.tagCombo.findRecord(this.tagCombo.displayField,this.parent.existingTags[a]));this.tag_order.length&&(this.tagCombo.select(this.tag_order[0]),this.tagCombo.fireEvent("Select",this.tagCombo,!0)),this.SortComboBox("ASC")}},GenerateComponents:function(){this.tagCombo=Ext.create("Ext.form.field.ComboBox",{editable:!1,forceSelection:!0,displayField:"name",store:Ext.create("Ext.data.Store",{model:"Ext.grid.property.Property",sorters:[{property:"value",direction:"DESC"},{property:"name",direction:"ASC"}]}),listConfig:{getInnerTpl:function(){return['<tpl if="value==&quot;gobject&quot;"><div><p class="alignLeft">{name}</p><p class="alignRightGobject">gobject</p><div style="clear: both;"></div></div><tpl else><div><p class="alignLeft">{name}</p><p class="alignRightTag">tag</p><div style="clear: both;"></div></div></tpl>']}},emptyText:"Select a tag...",queryMode:"local",listeners:{select:this.OnCBSelect,scope:this}}),this.grid=Ext.create("Ext.grid.Panel",{store:Ext.create("Ext.data.Store",{model:"Ext.grid.property.Property"}),hideHeaders:!0,multiSelect:!0,flex:1,border:0,viewConfig:{emptyText:"No data to display",forceFit:!0,scrollOffset:2},plugins:new Ext.ux.DataTip({tpl:"<div>{value}</div>"}),listeners:{cellclick:this.OnGridSelect,scope:this},columns:[{text:"Tag",dataIndex:"name",hidden:!0},{text:"Value",flex:1,dataIndex:"value"}]}),this.add([this.tagCombo,this.grid])},GetSelection:function(){var e=this.grid.getSelectionModel().getSelection(),t=new Array;for(var n=0;n<e.length;n++)t.push(e[n].data.value);return t},GetTagValuePair:function(){if(this.tagType=="gobject"){if(this.value.length>0){var e="";for(var t=0;t<this.value.length;t++)e+='"'+encodeURIComponent(this.tag)+'"::"'+encodeURIComponent(this.value[t])+'": OR ';return e.substring(0,e.length-4)}return this.tag!=""?'"'+encodeURIComponent(this.tag)+'":::':""}if(this.value.length>0){var e="";for(var t=0;t<this.value.length;t++)e+='"'+encodeURIComponent(this.tag)+'":"'+encodeURIComponent(this.value[t])+'" OR ';return e.substring(0,e.length-4)}return""},Reinitialize:function(){this.removeAll(!0),this.ownerCt.AddNewTag(this.tag,this.getId()),this.tag="",this.oldTag="",this.value=[],this.SetTitle(),this.GenerateComponents(),this.GetTagList(!1),this.ownerCt.ReloadBrowserData()},destroy:function(){this.ownerCt&&this.ownerCt.AddNewTag(this.tag,this.getId()),this.removeAll(!0),this.tag="",this.oldTag="",this.value=[],this.ownerCt&&this.ownerCt.ReloadBrowserData(),this.callParent(arguments)},OnCBSelect:function(e,t){this.tag!=e.getRawValue()&&(this.oldTag=this.tag,this.tag=e.getRawValue(),this.tagType=e.lastSelection[0].data.value,this.value=[],this.SetTitle(),t&&this.parent.msgBus.fireEvent("Organizer_OnCBSelect",this))},OnGridSelect:function(){this.value=this.GetSelection(),this.SetTitle(),this.parent.msgBus.fireEvent("Organizer_OnGridSelect")}}),Bisque.ResourceBrowser.ResourceQueue=function(){},Bisque.ResourceBrowser.ResourceQueue.prototype=new Array,Ext.apply(Bisque.ResourceBrowser.ResourceQueue.prototype,{init:function(e){Ext.apply(this,{browser:e.browser,layoutKey:e.browser.layoutKey,msgBus:e.browser.msgBus,uri:e.uri,callBack:e.callBack,prefetchFactor:1,dataLimit:350,noUnloadClicks:5,hasMoreData:{left:!0,right:!0},loading:{left:!1,right:!1},dataHash:{},list:[],selectedRes:{},indRight:[],indLeft:[],dbOffset:{left:0,center:parseInt(e.uri.offset),right:0},currentDirection:1,clicks:{right:0,left:0},rqOffset:0}),this.loadData()},loadData:function(){this.dbOffset.left=this.dbOffset.center-this.dataLimit>=0?this.dbOffset.center-this.dataLimit:0;var e=this.uri;e.offset=this.dbOffset.left,e.limit=2*this.dataLimit,BQFactory.request({uri:this.generateURI(e),cb:callback(this,"dataLoaded"),cache:!1})},dataLoaded:function(e){this.rqOffset=this.dbOffset.center-this.dbOffset.left,this.dbOffset.right=this.dbOffset.left+e.children.length;for(var t=0;t<e.children.length;t++)this.push(Bisque.ResourceFactory.getResource({resource:e.children[t],layoutKey:this.layoutKey,msgBus:this.msgBus,resQ:this,browser:this.browser}));this.hasMoreData.left=this.dbOffset.left>0?!0:!1,this.hasMoreData.right=this.dbOffset.right-this.dbOffset.center>=this.dataLimit?!0:!1,this.callBack()},loadDataRight:function(e,t){if(!e){this.loading.right=!0;var n=this.browser.getURIFromState();n.offset=this.dbOffset.right,n.limit=this.dataLimit,BQFactory.request({uri:this.generateURI(n),cb:callback(this,"loadDataRight",!0),cache:!1}),this.browser.commandBar.getComponent("btnRight").setDisabled(!0),this.browser.commandBar.getComponent("btnRight").setLoading({msg:""})}else{this.browser.commandBar.getComponent("btnRight").setDisabled(!1),this.browser.commandBar.getComponent("btnRight").setLoading(!1),this.dbOffset.right+=t.children.length;for(var r=0;r<t.children.length;r++)this.push(Bisque.ResourceFactory.getResource({resource:t.children[r],layoutKey:this.layoutKey,msgBus:this.msgBus,resQ:this,browser:this.browser}));this.hasMoreData.right=t.children.length==this.dataLimit?!0:!1,this.loading.right=!1,this.browser.changeLayoutThrottled(this.browser.layoutKey,"Right")}},loadDataLeft:function(e,t){if(!e){this.loading.left=!0;var n=this.dbOffset.left;this.dbOffset.left=this.dbOffset.left-this.dataLimit>=0?this.dbOffset.left-this.dataLimit:0;var r=this.browser.getURIFromState();r.offset=this.dbOffset.left,r.limit=n-this.dbOffset.left,BQFactory.request({uri:this.generateURI(r),cb:callback(this,"loadDataLeft",!0),cache:!1}),this.browser.commandBar.getComponent("btnLeft").setDisabled(!0),this.browser.commandBar.getComponent("btnLeft").setLoading({msg:""})}else{this.browser.commandBar.getComponent("btnLeft").setDisabled(!1),this.browser.commandBar.getComponent("btnLeft").setLoading(!1);for(var i=0;i<t.children.length;i++)this.unshift(Bisque.ResourceFactory.getResource({resource:t.children[i],layoutKey:this.layoutKey,msgBus:this.msgBus,resQ:this,browser:this.browser}));this.hasMoreData.left=t.children.length==this.dataLimit?!0:!1,this.loading.left=!1,this.rqOffset=this.rqOffset+t.children.length,this.browser.changeLayoutThrottled(this.browser.layoutKey,"Left")}},loadPrev:function(e){this.currentDirection=0,this.rqOffset-e>0?this.rqOffset-=e:this.rqOffset=0,this.clicks.left+=1,this.unloadRight()},loadNext:function(e){var t=e||this.visLimit;this.currentDirection=1,this.rqOffset+t<this.length&&(this.rqOffset+=t),this.clicks.right+=1,this.unloadLeft()},prefetchPrev:function(e){var t=this.prefetchFactor;if(this.rqOffset-t*this.visLimit>0)for(i=this.rqOffset-t*this.visLimit;i<this.rqOffset;i++)this[i].prefetch(e),this.indLeft.push(this[i].resource.uri);else{for(i=0;i<this.rqOffset;i++)this[i].prefetch(e),this.indLeft.push(this[i].resource.uri);this.hasMoreData.left&&!this.loading.left&&this.loadDataLeft(!1)}},prefetchNext:function(e){var t=this.prefetchFactor;if(this.rqOffset+(t+1)*this.visLimit<this.length)for(i=this.rqOffset;i<=this.rqOffset+(t+1)*this.visLimit;i++)this[i].prefetch(e),this.indRight.push(this[i].resource.uri);else{for(i=this.rqOffset;i<this.length;i++)this[i].prefetch(e),this.indRight.push(this[i].resource.uri);this.hasMoreData.right&&!this.loading.right&&this.loadDataRight(!1)}},unloadRight:function(){if(this.clicks.left==this.noUnloadClicks){this.clicks.left=0;var e=Math.floor(this.indRight.length/2);for(var t=0;t<e;t++)this.dataHash[this.indRight.shift()]={}}},unloadLeft:function(){if(this.clicks.right==this.noUnloadClicks){this.clicks.right=0;var e=Math.floor(this.indLeft.length/2);for(var t=0;t<e;t++)this.dataHash[this.indLeft.shift()]={}}},prefetch:function(e){this.list=this.slice(this.rqOffset,this.rqOffset+this.visLimit);for(var t=0;t<this.list.length;t++)this.splice(t+this.rqOffset,1,Bisque.ResourceFactory.getResource({resource:this[t+this.rqOffset].resource,layoutKey:this.layoutKey,msgBus:this.msgBus,resQ:this,browser:this.browser})),this.list[t].prefetch(e);return this.currentDirection?window.setTimeout(Ext.bind(this.prefetchNext,this,[e]),400):window.setTimeout(Ext.bind(this.prefetchPrev,this,[e]),400),this.list},getMainQ:function(e,t){return this.visLimit=e,this.browser.browserState.offset=this.rqOffset+this.dbOffset.left,this.prefetch(t)},getTempQ:function(e,t){var n=this.rqOffset,r;return t=="left"?(n=n-e>0?n-e:0,this.slice(n,this.rqOffset).reverse()):this.slice(n,n+e)},changeLayout:function(e){if(this.layoutKey!=e.key){this.layoutKey=e.key,this.dataHash={};for(i=0;i<this.length;i++)this.splice(i,1,Bisque.ResourceFactory.getResource({resource:this[i].resource,layoutKey:this.layoutKey,msgBus:this.msgBus,resQ:this,browser:this.browser}))}},getStatus:function(){var e=!1,t=!1,n=this.visLimit;this.rqOffset==0&&this.dbOffset.left==0&&(e=!0),this.rqOffset+n>=this.length&&!this.hasMoreData.right&&(t=!0,n=this.length-this.rqOffset);var r=Ext.String.format("Showing {0}-{1} of {2} {3}",this.dbOffset.left+this.rqOffset+(this.list.length?1:0),this.dbOffset.left+this.rqOffset+this.list.length,this.hasMoreData.left||this.hasMoreData.right?"atleast ":"total ",this.dbOffset.left+this.length),i={left:this.hasMoreData.left,right:this.hasMoreData.right,min:this.dbOffset.left+1,max:this.dbOffset.left+this.length,value:this.dbOffset.left+this.rqOffset+1};return{status:r,left:e,right:t,sliderSt:i,loading:this.loading}},generateURI:function(e){function r(e){return e.length<2?e:e.substring(1,e.length-1)}var t="",n=e.baseURL;delete e.baseURL;if(e.tag_order){var i=e.tag_order.split(","),s=[],o=[],u;for(var a=0;a<i.length;a++)u=i[a].split(":"),r(u[0])!="@ts"&&s.push(r(u[0]));e.view=s.join(",")}for(var f in e)e[f].length==0?delete e[f]:t+="&"+f+"="+e[f];return t=t==""?t:t.substring(1,t.length),Ext.urlAppend(n,t)},uriStateToString:function(e){var t="",n=e.baseURL;delete e.baseURL;for(var r in e)t+="&"+r+"="+e[r];var i=window.location.href.substr(0,window.location.href.lastIndexOf(window.location.search));return i[i.length-1]!="?"&&(i+="?"),i+"dataset="+n+t+"&layout="+this.layoutKey},storeMyData:function(e,t,n){Ext.isDefined(this.dataHash[e])||(this.dataHash[e]={}),this.dataHash[e][t]=n},getMyData:function(e,t){return Ext.isDefined(this.dataHash[e])&&Ext.isDefined(this.dataHash[e][t])?this.dataHash[e][t]:0},find:function(e){var t=!1;for(var n=0;n<this.length;n++)if(this[n].resource.uri==e){t=this[n].resource;break}return t}}),Bisque.ResourceBrowser.DatasetManager=Ext.extend(Ext.Panel,{constructor:function(e){Ext.apply(this,{selectedDS:null,selectedRes:null,msgBus:e.msgBus,parentCt:e.parentCt,browser:e.browser,title:"Datasets",itemId:"datasetCt",width:300,autoScroll:!0,tools:[{type:"left",text:"Collapse dataset panel",tooltip:"Collapse dataset panel",handler:function(){this.parentCt.hideCollapseTool=!1,this.parentCt.collapse()},scope:this}],tbar:new Ext.Toolbar({items:[{xtype:"tbspacer",width:6},{text:"Add Dataset",icon:"/js/ResourceBrowser/Images/add.png",hidden:!0,scale:"medium",iconAlign:"left",handler:Ext.bind(this.promptDatasetName,this,[!1])},{text:"Delete Dataset",icon:"/js/ResourceBrowser/Images/delete.png",scale:"medium",hidden:!0,iconAlign:"left",handler:this.deleteDataset,scope:this}]})}),this.callParent(arguments),this.ManageEvents(),this.LoadDSList(!1)},LoadDSList:function(e,t){if(!e)BQFactory.load("/data_service/dataset/?view=short",callback(this,"LoadDSList",!0));else for(i=0;i<t.children.length;i++)this.addDataset(t.children[i])},addDataset:function(e){var t=new Bisque.ResourceBrowser.DatasetManager.DatasetTbar({dataset:e});this.add(t),this.relayEvents(t,["datasetLoad"])},deleteDataset:function(){if(this.selectedDS){this.selectedDS.deleteDS(),this.selectedDS=null;var e={offset:0,baseURL:"/data_service/image"};this.msgBus.fireEvent("Browser_ReloadData",e)}},promptDatasetName:function(e,t,n){Ext.MessageBox.prompt("Create new dataset","Dataset name:",this.createDataset,this)},createDataset:function(e,t){if(e=="ok"){var n=new BQDataset;n.name=t,n.save_(undefined,callback(this,"addDataset"))}},ManageEvents:function(){this.on("datasetLoad",function(e){this.selectedDS&&this.selectedDS.removeCls("DS-Tbar-HLite");if(this.selectedDS==e.ct){this.selectedDS=null;var t={offset:0,baseURL:"/data_service/image"};document.title="Dataset: Images",this.msgBus.fireEvent("DatasetUnselected"),this.msgBus.fireEvent("Browser_ReloadData",t)}else this.selectedDS=e.ct,document.title="Dataset: "+this.selectedDS.dataset.name,this.selectedDS.addClass("DS-Tbar-HLite"),this.msgBus.fireEvent("DatasetSelected",this.selectedDS.dataset),e.ct.dataset.getMembers(callback(this,"ChangeDataset"))},this),this.msgBus.on("ResSelectionChange",function(e){this.selectedRes=e},this)},ChangeDataset:function(e){if(e.length!=0){var t={offset:0,baseURL:e.uri+"/value"};this.msgBus.fireEvent("Browser_ReloadData",t)}}}),Bisque.ResourceBrowser.DatasetManager.DatasetTbar=Ext.extend(Ext.Toolbar,{constructor:function(e){Ext.apply(this,{layout:"hbox",height:44,layoutConfig:{align:"middle"},dataset:e.dataset,menuClicked:!1,cls:"DS-Tbar",items:[{xtype:"tbspacer",width:6},{text:Ext.String.ellipsis(e.dataset.name,35),overCls:"",pressedCls:"",handler:this.datasetLoad,scope:this},{text:" ",scale:"medium",overCls:"",pressedCls:"",flex:1,handler:this.datasetLoad,scope:this},{text:"Options",icon:"/js/ResourceBrowser/Images/menu.png",scale:"medium",hidden:!0,iconAlign:"left",handler:this.showMenu,scope:this}],contextMenu:new Ext.menu.Menu({items:[{text:"Add selection to dataset",handler:this.addRes,scope:this},{text:"Add query result to dataset",handler:this.addResFromQuery,scope:this},"-",{text:"Remove selection from dataset"}]})}),this.callParent(arguments)},showMenu:function(e){this.contextMenu.showBy(e.getEl())},addRes:function(){if(this.ownerCt.selectedRes){var e=[];for(var t=0;t<this.ownerCt.selectedRes.length;t++)e.push(new BQValue("object",this.ownerCt.selectedRes[t]));this.dataset.appendMembers(e,callback(this,function(){this.dataset.save_(undefined,callback(this,"datasetLoad"))}))}},addResFromQuery:function(){var e=this.ownerCt.browser.resourceQueue,t=[];for(var n=0;n<e.length;n++)t.push(new BQValue("object",e[n].resource.uri));this.dataset.appendMembers(t,callback(this,function(){this.dataset.save_(undefined,callback(this,"datasetLoad"))}))},datasetLoad:function(){this.fireEvent("datasetLoad",{ct:this})},deleteDS:function(){this.dataset.delete_(),this.removeAll(!0),this.destroy()}}),Ext.define("Bisque.ResourceBrowser.CommandBar",{extend:"Ext.toolbar.Toolbar",constructor:function(e){this.viewMgr=e.browser.viewMgr,this.slider=new Bisque.Misc.Slider({hidden:this.viewMgr.cBar.slider}),Ext.apply(this,{browser:e.browser,taqQuery:e.browser.browserParams.tagQuery,msgBus:e.browser.msgBus,westPanel:e.browser.westPanel,organizerCt:e.browser.organizerCt,datasetCt:e.browser.datasetCt,hidden:e.browser.viewMgr.cBar.cbar,layout:{type:"hbox",align:"middle"},items:[{xtype:"tbspacer",width:6},{xtype:"textfield",tooltip:"Enter a tag query here",itemId:"searchBar",flex:7,scale:"large",height:25,boxMinWidth:100,hidden:this.viewMgr.cBar.searchBar,value:e.tagQuery,listeners:{specialkey:{fn:function(e,t){t.getKey()==t.ENTER&&this.btnSearch()},scope:this}}},{icon:bq.url("/js/ResourceBrowser/Images/search.png"),hidden:this.viewMgr.cBar.searchBar,tooltip:"Search",scale:"large",handler:this.btnSearch,scope:this},{xtype:"tbseparator",hidden:this.viewMgr.cBar.searchBar},{itemId:"btnThumb",icon:bq.url("/js/ResourceBrowser/Images/thumb.png"),hidden:this.viewMgr.cBar.btnLayoutThumb,tooltip:"Thumbnail layout",toggleGroup:"btnLayout",scale:"large",handler:this.btnLayoutClick,padding:"3 0 3 0",scope:this},{itemId:"btnGrid",icon:bq.url("/js/ResourceBrowser/Images/grid.png"),hidden:this.viewMgr.cBar.btnLayoutGrid,tooltip:"Grid layout",scale:"large",toggleGroup:"btnLayout",handler:this.btnLayoutClick,padding:"3 0 3 0",scope:this},{itemId:"btnCard",icon:bq.url("/js/ResourceBrowser/Images/card.png"),hidden:this.viewMgr.cBar.btnLayoutCard,tooltip:"Card layout",scale:"large",toggleGroup:"btnLayout",handler:this.btnLayoutClick,padding:"3 0 3 0",scope:this},{itemId:"btnFull",icon:bq.url("/js/ResourceBrowser/Images/full.png"),hidden:this.viewMgr.cBar.btnLayoutFull,tooltip:"Full layout",scale:"large",toggleGroup:"btnLayout",handler:this.btnLayoutClick,padding:"3 0 3 0",scope:this},"->",{itemId:"btnActivate",icon:bq.url("/js/ResourceBrowser/Images/activate.png"),tooltip:"(ACTIVATE) Press button to switch to selection mode",state:"ACTIVATE",hidden:this.viewMgr.cBar.btnActivate,scale:"large",handler:this.btnActivate,scope:this},{itemId:"btnRefresh",icon:bq.url("/js/ResourceBrowser/Images/refresh.png"),tooltip:"Refresh browser",hidden:this.viewMgr.cBar.btnRefresh,scale:"large",handler:this.btnRefresh,scope:this},{itemId:"btnTS",icon:bq.url("/js/ResourceBrowser/Images/desc.png"),tooltip:"Sort data ascending by timestamp (current: descending)",hidden:this.viewMgr.cBar.btnTS,sortState:"DESC",scale:"large",handler:this.btnTS,scope:this},{xtype:"tbseparator",hidden:this.viewMgr.cBar.btnTS},{tooltip:"Load more data",itemId:"btnLeft",icon:bq.url("/js/ResourceBrowser/Images/left.png"),hidden:this.viewMgr.cBar.btnLeft,scale:"large",padding:"0 1 0 0",handler:function(e){this.browser.resourceQueue.loadPrev(this.browser.layoutMgr.getVisibleElements("left")),this.browser.changeLayoutThrottled(this.browser.layoutKey,"Left")},scope:this},{tooltip:"Load more data",itemId:"btnRight",icon:bq.url("/js/ResourceBrowser/Images/right.png"),hidden:this.viewMgr.cBar.btnRight,scale:"large",padding:"0 0 0 1",handler:function(e){this.browser.resourceQueue.loadNext(),this.browser.changeLayoutThrottled(this.browser.layoutKey,"Right")},scope:this},this.slider,{xtype:"tbseparator",hidden:this.viewMgr.cBar.btnGear},{icon:bq.url("/js/ResourceBrowser/Images/gear.png"),hidden:this.viewMgr.cBar.btnGear,itemId:"btnGear",scale:"large",tooltip:"Options",menu:{items:[{text:"Include public resources",itemId:"btnWpublic",checked:!1,listeners:{checkchange:{fn:function(t,n){var r={offset:0};e.browser.browserParams.wpublic=n,e.browser.msgBus.fireEvent("Browser_ReloadData",r)},scope:this}}},"-",{text:"Organize",itemId:"btnOrganize",icon:bq.url("/js/ResourceBrowser/Images/organize.png"),hidden:!0,handler:this.btnOrganizerClick,scope:this},{text:"Datasets",icon:bq.url("/js/ResourceBrowser/Images/datasets.png"),hidden:!0,handler:this.btnDatasetClick,scope:this},{text:"Link",icon:bq.url("/js/ResourceBrowser/Images/link.png"),hidden:this.viewMgr.cBar.btnLink,handler:function(){var t=e.browser.resourceQueue.uriStateToString(e.browser.getURIFromState());Ext.Msg.show({title:"Link to this view",msg:"Bisque URL:",modal:!0,prompt:!0,width:500,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,value:t})}}]}},{xtype:"tbspacer",flex:.2,maxWidth:20}]}),Bisque.ResourceBrowser.CommandBar.superclass.constructor.apply(this,arguments),this.manageEvents()},manageEvents:function(){this.msgBus.on("SearchBar_Query",function(e){this.getComponent("searchBar").setValue(decodeURIComponent(e))},this),this.mon(this,"afterlayout",this.toggleLayoutBtn,this),this.slider.on("buttonClick",Ext.Function.createThrottled(function(e){var t=this.browser.resourceQueue.rqOffset+this.browser.resourceQueue.dbOffset.left,n=e-t;n>0?(this.browser.resourceQueue.loadNext(n),this.browser.changeLayoutThrottled(this.browser.layoutKey,"Right")):n<0&&(this.browser.resourceQueue.loadPrev(-1*n),this.browser.changeLayoutThrottled(this.browser.layoutKey,"Left"))},400,this),this)},btnRefresh:function(){this.browser.msgBus.fireEvent("Browser_ReloadData",{})},btnActivate:function(e){e.state=="ACTIVATE"?(e.setIcon(bq.url("/js/ResourceBrowser/Images/select.png")),e.state="SELECT",e.setTooltip("(SELECT) Press button to switch to activation mode")):(e.setIcon(bq.url("/js/ResourceBrowser/Images/activate.png")),e.state="ACTIVATE",e.setTooltip("(ACTIVATE) Press button to switch to selection mode")),this.browser.selectState=e.state,this.browser.fireEvent("SelectMode_Change",e.state)},btnTS:function(e){function n(e){var t=e.lastIndexOf('"@ts":desc');return t!=-1?e.slice(0,t):(t=e.lastIndexOf('"@ts":asc'),t!=-1?e.slice(0,t):e)}var t=n(this.browser.browserState.tag_order)||"";t.length!=0?t[t.length-1]!=","?t+=",":"":"",e.sortState=="ASC"?(e.setIcon(bq.url("/js/ResourceBrowser/Images/desc.png")),e.sortState="DESC",e.setTooltip("Sort data ascending by timestamp (current: descending)"),t+='"@ts":desc'):(e.setIcon(bq.url("/js/ResourceBrowser/Images/asc.png")),e.sortState="ASC",e.setTooltip("Sort data descending by timestamp (current: ascending)"),t+='"@ts":asc'),this.msgBus.fireEvent("Browser_ReloadData",{offset:0,tag_order:t})},btnSearch:function(){var e={offset:0,tag_query:this.getComponent("searchBar").getValue()};this.msgBus.fireEvent("Browser_ReloadData",e)},btnDatasetClick:function(){this.westPanel.removeAll(!1),this.datasetCt=this.datasetCt||new Bisque.ResourceBrowser.DatasetManager({parentCt:this.westPanel,browser:this.browser,msgBus:this.msgBus}),this.westPanel.setWidth(this.datasetCt.width).show().expand(),this.westPanel.add(this.datasetCt),this.westPanel.doComponentLayout(null,null,!0)},btnOrganizerClick:function(e){this.westPanel.removeAll(!1),this.organizerCt=(e?undefined:this.organizerCt)||new Bisque.ResourceBrowser.Organizer({parentCt:this.westPanel,dataset:this.browser.browserState.baseURL,wpublic:this.browser.browserParams.wpublic,browser:this.browser,msgBus:this.msgBus}),this.westPanel.setWidth(this.organizerCt.width).show().expand(),this.westPanel.add(this.organizerCt),this.westPanel.doComponentLayout(null,null,!0)},btnLayoutClick:function(e){switch(e.itemId){case"btnThumb":this.browser.changeLayoutThrottled(Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.Compact);break;case"btnCard":this.browser.changeLayoutThrottled(Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.Card);break;case"btnGrid":this.browser.changeLayoutThrottled(Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.Grid);break;case"btnFull":this.browser.changeLayoutThrottled(Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.Full)}},toggleLayoutBtn:function(){switch(this.browser.layoutKey){case Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.Compact:this.getComponent("btnThumb").toggle(!0,!1);break;case Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.Card:this.getComponent("btnCard").toggle(!0,!1);break;case Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.Grid:this.getComponent("btnGrid").toggle(!0,!1);break;case Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.Full:this.getComponent("btnFull").toggle(!0,!1)}},btnActivateSetState:function(e){var t=this.getComponent("btnActivate");t.state=e=="ACTIVATE"?"SELECT":"ACTIVATE",this.btnActivate(t)},btnTSSetState:function(e){var t=e.indexOf('"@ts":desc')!=-1?"DESC":e.indexOf('"@ts":asc')!=-1?"ASC":"",n=this.getComponent("btnTS");n.sortState!=t&&(t=="DESC"?(n.setIcon(bq.url("/js/ResourceBrowser/Images/desc.png")),n.sortState="DESC",n.setTooltip("Sort data ascending by timestamp (current: descending)")):(n.setIcon(bq.url("/js/ResourceBrowser/Images/asc.png")),n.sortState="ASC",n.setTooltip("Sort data descending by timestamp (current: ascending)")))},btnSearchSetState:function(e){this.getComponent("searchBar").setValue(decodeURIComponent(e))},setStatus:function(e){this.slider.rendered&&this.slider.setStatus(e)},applyPreferences:function(){this.rendered&&this.toggleLayoutBtn(),this.getComponent("btnGear").menu.getComponent("btnWpublic").setChecked(this.browser.browserParams.wpublic,!0)}}),Ext.define("Bisque.ResourceBrowser.viewStateManager",{constructor:function(e){this.cBar={cbar:!1,searchBar:!1,btnActivate:!1,btnTS:!1,btnRefresh:!1,btnLayoutThumb:!1,btnLayoutCard:!1,btnLayoutGrid:!1,btnLayoutFull:!1,btnLayoutLeft:!1,btnLayoutRight:!1,slider:!1,btnGear:!1,btnOrganizer:!1,btnDataset:!1,btnLink:!1,btnPreferences:!1};switch(e){case"MexBrowser":case"ViewerOnly":case"DatasetBrowser":this.cBar.searchBar=!0,this.cBar.btnLayoutThumb=!0,this.cBar.btnLayoutCard=!0,this.cBar.btnLayoutGrid=!0,this.cBar.btnLayoutFull=!0,this.cBar.btnGear=!0;break;case"ViewSearch":this.cBar.btnActivate=!0,this.cBar.btnTS=!0,this.cBar.btnRefresh=!0,this.cBar.btnLayoutThumb=!0,this.cBar.btnLayoutCard=!0,this.cBar.btnLayoutGrid=!0,this.cBar.btnLayoutFull=!0,this.cBar.slider=!0,this.cBar.btnGear=!0;break;case"ViewerLayouts":this.cBar.searchBar=!0,this.cBar.btnGear=!0;break;case"ModuleBrowser":this.cBar.cbar=!0}return this}}),Ext.define("Bisque.ResourceBrowser.OperationBar",{extend:"Ext.container.Container",floating:!0,constructor:function(){var e=Ext.create("Ext.button.Button",{icon:bq.url("/js/ResourceBrowser/Images/close.gif"),tooltip:"Delete this resource.",handler:this.close,scope:this}),t=Ext.create("Ext.button.Button",{icon:bq.url("/js/ResourceBrowser/Images/down.png"),tooltip:"Available operations for this resource.",handler:this.menuHandler,scope:this});this.items=[t,e],this.callParent(arguments)},close:function(e,t){t.stopPropagation();var n=Ext.Object.getSize(this.browser.resourceQueue.selectedRes);if(n>1){var r=new BQDataset,i=[];for(var s in this.browser.resourceQueue.selectedRes)i.push(this.browser.resourceQueue.selectedRes[s]);r.tmp_setMembers(i),r.tmp_deleteMembers(Ext.bind(o,this));function o(e){BQ.ui.notification(e.success+" resources deleted. "+e.failure+" resources failed."),this.browser.msgBus.fireEvent("Browser_ReloadData",{})}}else e.operation=Ext.pass(this.resourceCt.resource.delete_,[Ext.bind(this.success,this),Ext.Function.pass(this.failure,["Delete operation failed!"])],this.resourceCt.resource),this.resourceCt.testAuth1(e)},menuHandler:function(e,t){t.stopPropagation(),this.menu=this.createMenu().showBy(this,"tr-br")},createMenu:function(){var e=Ext.Object.getSize(this.browser.resourceQueue.selectedRes),t=[{text:"Download",iconCls:"icon-download-small",handler:this.btnMenu,scope:this},{text:"Share",iconCls:"icon-group",handler:this.btnMenu,scope:this}];return e>1?t.push({text:"Set all published",iconCls:"icon-eye",handler:this.btnMenu,scope:this},{text:"Set all private",iconCls:"icon-eye-close",handler:this.btnMenu,scope:this}):this.resourceCt.resource.permission=="published"?t.push({text:"Published",iconCls:"icon-eye",handler:this.btnMenu,scope:this}):t.push({text:"Private",iconCls:"icon-eye-close",handler:this.btnMenu,scope:this}),t.push("-",{text:"Add to dataset",iconCls:"icon-add",handler:this.btnMenu,scope:this}),Ext.create("Ext.menu.Menu",{items:t})},btnMenu:function(e){var t=Ext.Object.getSize(this.browser.resourceQueue.selectedRes),n=new BQDataset,r=[];if(t>1){for(var i in this.browser.resourceQueue.selectedRes)r.push(this.browser.resourceQueue.selectedRes[i]);n.tmp_setMembers(r)}switch(e.text){case"Download":t>1?n.tmp_downloadMembers():this.resourceCt.downloadOriginal();break;case"Share":t>1?n.tmp_shareMembers():this.resourceCt.shareResource();break;case"Private":this.resourceCt.changePrivacy("published",Ext.bind(this.success,this));break;case"Published":this.resourceCt.changePrivacy("private",Ext.bind(this.success,this));break;case"Set all published":n.tmp_changePermission("published",Ext.bind(this.success,this));break;case"Set all private":n.tmp_changePermission("private",Ext.bind(this.success,this));break;case"Add to dataset":function s(e,t){if(e=="ok"){var n=new BQDataset,r=[];n.name=t;for(var i in this.browser.resourceQueue.selectedRes)r.push(new BQValue("object",i));n.setMembers(r);function s(e){window.location=bq.url("/client_service/view?resource="+e.uri)}n.save_(undefined,s,this.failure)}}Ext.MessageBox.prompt("Enter dataset name","New name:",s,this,!1,"NewDataset")}},success:function(e,t){this.browser.msgBus.fireEvent("Browser_ReloadData",{})},failure:function(e){BQ.ui.error(e||"Operation failed!")}}),Ext.define("Bisque.ResourceFactory",{statics:{baseClass:"Bisque.Resource",getResource:function(e){var t=Ext.Object.getKey(Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS,e.layoutKey),n=Bisque.ResourceFactory.baseClass+"."+Ext.String.capitalize(e.resource.resource_type.toLowerCase())+"."+t;return Ext.ClassManager.get(n)?Ext.create(n,e):(Ext.log({msg:Ext.String.format("Unknown class: {0}, type: {1}, layoutKey: {2}. Initializing with base resource class.",n,e.resource.resource_type,t),level:"warn",stack:!0}),Ext.create(Bisque.ResourceFactory.baseClass+"."+t,e))}}}),Ext.define("Bisque.ResourceFactoryWrapper",{statics:{getResource:function(e){e.resourceManager=Ext.create("Ext.Component",{store:{},storeMyData:function(e,t,n){this.store[t]=n},getMyData:function(e,t){return this.store[t]?this.store[t]:0}}),Ext.apply(e,{layoutKey:e.layoutKey||Bisque.ResourceBrowser.LayoutFactory.DEFAULT_LAYOUT,msgBus:e.msgBus||e.resourceManager,resQ:e.resQ||e.resourceManager,browser:e.browser||{}});var t=Bisque.ResourceFactory.getResource(e),n=Bisque.ResourceBrowser.LayoutFactory.getClass(e.layoutKey),r=Ext.ClassManager.get(n).readCSS();return t.prefetch(r),t.setSize({width:r.layoutEl.width,height:r.layoutEl.height}),t.addCls(r.layoutCSS),t}}}),Ext.define("Bisque.Resource",{extend:"Ext.container.Container",constructor:function(e){Ext.apply(this,{resource:e.resource,browser:e.browser,layoutKey:e.layoutKey,msgBus:e.msgBus,resQ:e.resQ,border:!1,cls:"LightShadow",overCls:"resource-view-over",style:"float:left;"}),this.callParent(arguments),this.manageEvents()},setLoadingMask:function(){this.getData("fetched")!=1&&this.setLoading({msg:""})},GetPropertyGrid:function(e,t){var n=Ext.create("Ext.grid.Panel",{autoHeight:e.autoHeight,style:"text-overflow:ellipsis;"+e.style,width:e.width,store:Ext.create("Ext.data.Store",{model:"Ext.grid.property.Property",data:t}),border:!1,padding:1,multiSelect:!0,plugins:new Ext.ux.DataTip({tpl:"<div>{value}</div>"}),columns:[{text:"Tag",flex:.8,dataIndex:"name"},{text:"Value",flex:1,dataIndex:"value"}]});return n},getData:function(e){if(this.resQ)return this.resQ.getMyData(this.resource.uri,e)},setData:function(e,t){this.resQ.storeMyData(this.resource.uri,e,t)},prefetch:function(e){this.layoutMgr=e},loadResource:Ext.emptyFn,updateContainer:function(){var e=Ext.create("Ext.container.Container",{cls:"lblHeading1",html:this.resource.name}),t=Ext.create("Ext.container.Container",{cls:"lblHeading2",html:this.resource.resource_type}),n=BQApp.userList[this.resource.owner]||{},r=Ext.create("Ext.container.Container",{cls:"lblContent",html:n.display_name});this.add([e,t,r]),this.setLoading(!1)},getFields:function(){var e=this.resource,t=BQApp.userList[this.resource.owner],n=t?t.find_tags("display_name").value:"";return["",e.name||"",n||"",e.resource_type,e.ts,this,{height:21}]},testAuth1:function(e,t,n){if(t!=1){var r=BQSession.current_session.user_uri;this.resource.testAuth(r,Ext.bind(this.testAuth1,this,[e,!0],0))}else n?e.operation.call(this,e):BQ.ui.attention("You do not have permission to perform this action!")},afterRenderFn:function(){this.updateContainer()},manageEvents:function(){this.on("afterrender",Ext.Function.createInterceptor(this.afterRenderFn,this.preAfterRender,this))},preAfterRender:function(){this.setLoadingMask();var e=this.getEl();e.on("mouseenter",Ext.Function.createSequence(this.preMouseEnter,this.onMouseEnter,this),this),e.on("mousemove",this.onMouseMove,this),e.on("mouseleave",Ext.Function.createSequence(this.preMouseLeave,this.onMouseLeave,this),this),e.on("click",Ext.Function.createSequence(this.preClick,this.onClick,this),this),e.on("contextmenu",this.onRightClick,this),e.on("dblclick",Ext.Function.createSequence(this.preDblClick,this.onDblClick,this),this)},preClick:function(){this.msgBus.fireEvent("ResourceSingleClick",this.resource);if(!this.el)return;this.el.hasCls("resource-view-selected")?(this.toggleSelect(!1),this.fireEvent("unselect",this)):(this.toggleSelect(!0),this.fireEvent("select",this))},toggleSelect:function(e){e?(this.removeCls("LightShadow"),this.addCls("resource-view-selected")):(this.removeCls("resource-view-selected"),this.addCls("LightShadow"))},preDblClick:function(){this.msgBus.fireEvent("ResourceDblClick",this.resource)},preMouseEnter:function(){this.removeCls("LightShadow"),this.browser.selectState=="SELECT"&&(this.operationBar||(this.operationBar=Ext.create("Bisque.ResourceBrowser.OperationBar",{renderTo:this.getEl(),resourceCt:this,browser:this.browser}),this.operationBar.alignTo(this,"tr-tr")),this.operationBar.setVisible(!0))},preMouseLeave:function(){this.browser.selectState=="SELECT"&&this.operationBar.setVisible(!1),this.el.hasCls("resource-view-selected")||this.addCls("LightShadow")},onMouseMove:Ext.emptyFn,onMouseEnter:Ext.emptyFn,onMouseLeave:Ext.emptyFn,onDblClick:Ext.emptyFn,onClick:Ext.emptyFn,onRightClick:Ext.emptyFn,shareResource:function(){var e=Ext.create("BQ.ShareDialog",{resource:this.resource})},downloadOriginal:function(){var e=Ext.create("BQ.Export.Panel");e.downloadResource(this.resource,"none")},changePrivacy:function(e,t,n){function r(e,t,n,r){t?e.permission=t:e.permission=this.resource.permission=="private"?"published":"private",e.append(Ext.bind(n,this),Ext.bind(r,this))}BQFactory.request({uri:this.resource.uri+"?view=short",cb:Ext.bind(r,this,[e,t,n],1)})}}),Ext.define("Bisque.Resource.Compact",{extend:"Bisque.Resource"}),Ext.define("Bisque.Resource.Card",{extend:"Bisque.Resource",constructor:function(){Ext.apply(this,{layout:"fit"}),this.callParent(arguments)},prefetch:function(e){this.callParent(arguments),this.getData("fetched")||(this.setData("fetched",-1),BQFactory.load(this.resource.uri+"/tag",Ext.bind(this.loadResource,this)))},loadResource:function(e){this.resource.tags=e.tags;var t,n,r=[],i=this.getSummaryTags();for(var s=0;s<this.resource.tags.length;s++)t=this.resource.tags[s],n=new Ext.grid.property.Property({name:t.name,value:t.value}),i[t.name]?r.unshift(n):r.push(n);this.setData("tags",r.slice(0,7)),this.setData("fetched",1);var o=this.getData("renderedRef");o&&!o.isDestroyed&&o.updateContainer()},afterRenderFn:function(){this.setData("renderedRef",this),this.getData("fetched")==1&&!this.isDestroyed&&this.updateContainer()},getSummaryTags:function(){return{}},updateContainer:function(){var e=this.GetPropertyGrid({},this.getData("tags"));e.determineScrollbars=Ext.emptyFn,this.add([e]),this.setLoading(!1)},onMouseMove:Ext.emptyFn}),Ext.define("Bisque.Resource.PStrip",{extend:"Bisque.Resource"}),Ext.define("Bisque.Resource.PStripBig",{extend:"Bisque.Resource"}),Ext.define("Bisque.Resource.Full",{extend:"Bisque.Resource",constructor:function(){Ext.apply(this,{layout:"fit"}),this.callParent(arguments)},afterRenderFn:function(){this.setData("renderedRef",this),this.getData("fetched")==1&&!this.isDestroyed&&this.updateContainer()},prefetch:function(e){this.callParent(arguments),this.getData("fetched")||(this.setData("fetched",-1),BQFactory.load(this.resource.uri+"/tag?view=deep",Ext.bind(this.loadResource,this)))},loadResource:function(e){this.setData("tags",e.tags),this.setData("fetched",1);var t=this.getData("renderedRef");t&&!t.isDestroyed&&t.updateContainer()},updateContainer:function(){var e=this.GetPropertyGrid({},this.getData("tags"));e.determineScrollbars=Ext.emptyFn,this.add([e]),this.setLoading(!1)},onMouseMove:Ext.emptyFn}),Ext.define("Bisque.Resource.List",{extend:"Bisque.Resource"}),Ext.define("Bisque.Resource.Page",{extend:"Ext.panel.Panel",defaults:{border:!1},layout:"fit",constructor:function(e){var t=e.resource.name||"",n=e.resource.resource_type||e.resource.type;Ext.apply(this,{border:!1,tbar:Ext.create("Ext.toolbar.Toolbar",{defaults:{scale:"medium",scope:this,needsAuth:!0},items:this.getOperations(e.resource).concat(["-","->",{itemId:"btnRename",text:n+": <b>"+t+"</b>",handler:this.promptName,scope:this,cls:"heading"}])})},e),this.callParent(arguments),this.toolbar=this.getDockedComponent(0),this.testAuth(BQApp.user,!1),this.addListener("afterlayout",this.onResourceRender,this,{single:!0})},onResourceRender:function(){this.setLoading(!0);var e=new Bisque.ResourceTagger({itemId:"resourceTagger",title:"Annotations",resource:this.resource,split:!0});this.add(e),this.setLoading(!1)},testAuth:function(e,t,n,r){function i(e){var t=this.getDockedItems("toolbar")[0];for(var n=0;n<t.items.getCount();n++){var r=t.items.getAt(n);r.needsAuth&&r.setDisabled(!0),r.itemId=="btnDelete"&&e=="read"&&r.setDisabled(!1)}}e?t?n||i.call(this,r):this.resource.testAuth(e.uri,Ext.bind(this.testAuth,this,[e,!0],0)):e===undefined?BQApp.on("gotuser",Ext.bind(this.testAuth,this,[!1],1)):e==null&&i.call(this)},getOperations:function(e){var t=[];return t.push({xtype:"button",text:"Download",itemId:"btnDownload",iconCls:"icon-download-small",needsAuth:!1,compression:"tar",menu:{defaults:{group:"downloadGroup",groupCls:Ext.baseCSSClass+"menu-group-icon",scope:this,handler:this.downloadResource,operation:this.downloadResource},items:[{xtype:"menuitem",compression:"none",text:"Original"},{xtype:"menuseparator"},{compression:"tar",text:"as TARball"},{compression:"gzip",text:"as GZip archive"},{compression:"bz2",text:"as BZip2 archive"},{compression:"zip",text:"as (PK)Zip archive"}]}},{itemId:"btnShare",text:"Share",iconCls:"icon-group",operation:this.shareResource,handler:this.testAuth1},{itemId:"btnDelete",text:"Delete",iconCls:"icon-delete",handler:this.deleteResource},{itemId:"btnPerm",operation:this.changePrivacy,handler:this.testAuth1,setBtnText:function(e){var t="Visibility: ";this.resource.permission=="published"?(t+='<span style="font-weight:bold;color: #079E0C">published</span>',e.setIconCls("icon-eye")):(t+="private",e.setIconCls("icon-eye-close")),e.setText(t)},listeners:{afterrender:function(e){e.setBtnText.call(this,e)},scope:this}}),t},testAuth1:function(e,t,n){if(t!=1){var r=BQSession.current_session.user_uri;this.resource.testAuth(r,Ext.bind(this.testAuth1,this,[e,!0],0))}else n?e.operation.call(this,e):BQ.ui.attention("You do not have permission to perform this action!")},shareResource:function(){var e=Ext.create("BQ.ShareDialog",{resource:this.resource})},deleteResource:function(){function e(){this.setLoading(!1),Ext.MessageBox.show({title:"Success",msg:"Resource deleted successfully! You will be redirected to your BISQUE homepage.",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){window.location=bq.url("/")}})}function t(t){t=="yes"&&(this.setLoading({msg:"Deleting..."}),this.resource.delete_(Ext.bind(e,this),Ext.Function.pass(this.failure,["Delete operation failed!"])))}Ext.MessageBox.confirm("Confirm operation","Are you sure you want to delete "+this.resource.name+"?",Ext.bind(t,this))},renameResource:function(e,t,n){function r(e){BQ.ui.notification(e);var t=this.resource.resource_type||this.resource.type;this.toolbar.getComponent("btnRename").setText(t+": <b>"+(this.resource.name||"")+"</b>")}if(e=="ok"&&this.resource.name!=t){var i=this.resource.resource_type||this.resource.type,s=i+" <b>"+this.resource.name+"</b> renamed to <b>"+t+"</b>.";this.resource.name=t,this.resource.save_(undefined,r.call(this,s),Ext.bind(this.failure,this))}},downloadResource:function(e){if(e.compression=="none")this.downloadOriginal();else{var t=Ext.create("BQ.Export.Panel");t.downloadResource(this.resource,e.compression)}},downloadOriginal:function(){if(this.resource.src){window.open(this.resource.src);return}var e=Ext.create("BQ.Export.Panel");e.downloadResource(this.resource,"none")},changePrivacy:function(e){function t(e){e.permission=this.resource.permission=="private"?"published":"private",e.append(Ext.bind(n,this),Ext.bind(this.failure,this))}function n(e){this.resource.permission=e.permission;var t=this.toolbar.getComponent("btnPerm");t.setBtnText.call(this,t)}BQFactory.request({uri:this.resource.uri+"?view=short",cb:Ext.bind(t,this)})},promptName:function(e){Ext.MessageBox.prompt('Rename "'+this.resource.name+'"',"Please, enter new name:",this.renameResource,this,!1,this.resource.name)},success:function(e,t){BQ.ui.notification(t||"Operation successful.")},failure:function(e){BQ.ui.error(e||"Operation failed!")},prefetch:Ext.emptyFn}),Ext.define("Bisque.Resource.Grid",{extend:"Bisque.Resource"}),Ext.define("Bisque.Resource.Image",{extend:"Bisque.Resource",GetImageThumbnailRel:function(e,t,n){return'<img style=" display: block; margin-left: auto; margin-right: auto; margin-top: '+(e.height+10-t.height)/2+'px;"'+(n==undefined?' id="'+this.resource.uri+'"':"")+' src="'+this.getThumbnailSrc(e)+'"/>'},getThumbnailSrc:function(e){return this.resource.src+this.getImageParams(e)},GetImageThumbnailAbs:function(e,t,n){return'<img style="position:absolute; top:50%; left:50%; margin-top: -'+t.height/2+"px;margin-left: -"+t.width/2+'px;"'+(n==undefined?' id="'+this.resource.uri+'"':"")+' src="'+this.getThumbnailSrc(e)+'"/>'},getImageParams:function(e){var t=this.getImagePrefs("ImageParameters")||"?slice=,,{sliceZ},{sliceT}&thumbnail={width},{height}&format=jpeg";return t=t.replace("{sliceZ}",e.sliceZ||1),t=t.replace("{sliceT}",e.sliceT||1),t=t.replace("{width}",e.width||150),t=t.replace("{height}",e.height||150),t},getImagePrefs:function(e){return this.browser.preferences&&this.browser.preferences.Images&&this.browser.preferences.Images[e]?this.browser.preferences.Images[e]:""},afterRenderFn:function(){this.setData("renderedRef",this),this.getData("fetched")==1&&!this.isDestroyed&&this.updateContainer()},OnDblClick:function(){this.msgBus.fireEvent("ResourceDblClick",this.resource.uri)},onMouseEnter:function(e,t){if(this.resource.t==1&&this.resource.z==1)this.mmData={isLoadingImage:!0};else{var n=this.getEl();this.getData("fetched")==1&&(this.mmData={x:n.getX()+n.getOffsetsTo(this.resource.uri)[0],y:n.getY()+n.getOffsetsTo(this.resource.uri)[1],isLoadingImage:!1})}},onMouseLeave:function(){this.mmData&&(this.mmData.isLoadingImage=!0)},onMouseMove:function(e,t){if(this.mmData&&!this.mmData.isLoadingImage){this.mmData.isLoadingImage=!0;var n=Math.ceil((e.getX()-this.mmData.x)*this.resource.t/t.clientWidth),r=Math.ceil((e.getY()-this.mmData.y)*this.resource.z/t.clientHeight);n>this.resource.t&&(n=this.resource.t),r>this.resource.z&&(r=this.resource.z);var i=new Image;i.src=this.resource.src+this.getImageParams({sliceZ:r,sliceT:n,width:this.layoutMgr.layoutEl.imageWidth,height:this.layoutMgr.layoutEl.imageHeight});function s(){Ext.isDefined(document.images[this.resource.uri])&&(document.images[this.resource.uri].src=i.src,this.mmData.isLoadingImage=!1)}i.onload=Ext.bind(s,this)}},downloadOriginal:function(){window.open(this.resource.src)}}),Ext.define("Bisque.Resource.Image.Compact",{extend:"Bisque.Resource.Image",afterRenderFn:function(e){this.ttip||(this.mouseIn=!1,this.ttip=Ext.create("Ext.tip.ToolTip",{target:this.id,anchor:"top",maxWidth:600,width:555,cls:"LightShadow",dismissDelay:0,style:"background-color:#FAFAFA;border: solid 2px #E0E0E0;",layout:"hbox",autoHide:!1,listeners:{beforeshow:function(e){if(!this.tagsLoaded||!this.mouseIn)return!1},scope:this}})),this.callParent(arguments)},onRightClick:function(e){e.preventDefault(),this.mouseIn=!0,this.tagsLoaded?this.ttip.show():this.requestTags()},onMouseLeave:function(e){this.mouseIn=!1,this.callParent(arguments)},requestTags:function(){this.tagsLoaded||(BQFactory.request({uri:this.resource.uri+"/tag",cb:Ext.bind(this.tagData,this,["tags"],!0)}),BQFactory.request({uri:this.resource.src+"?meta",cb:Ext.bind(this.tagData,this,["meta"],!0)}))},tagData:function(e,t){this.tagsLoaded=!0,this.resource.tags=e.tags;var n=[],r={},i="";for(var s=0;s<this.resource.tags.length;s++)i=this.resource.tags[s].value,r[this.resource.tags[s].name]=i==null||i==""?"None":i,n.push(new Ext.grid.property.Property({name:this.resource.tags[s].name,value:r[this.resource.tags[s].name]}));var o=this.GetPropertyGrid({width:270},n);t=="tags"?o.title="Tag data":o.title="Metadata",this.ttip.add(o),this.ttip.show()},prefetch:function(e){this.callParent(arguments);if(!this.getData("fetched")){this.setData("fetched",-1),BQFactory.load(this.resource.uri+"/tag",Ext.bind(this.loadResource,this,["tags"],!0));var t=new Image;t.src=this.getThumbnailSrc({width:this.layoutMgr.layoutEl.imageWidth,height:this.layoutMgr.layoutEl.imageHeight}),t.onload=Ext.bind(this.loadResource,this,["image"],!0),t.onerror=Ext.bind(this.resourceError,this),t.onabort=Ext.bind(this.resourceError,this)}},resourceError:function(){var e='<img style="display: block; margin-left: auto; margin-right: auto; margin-top: 65px;" src="'+bq.url("/js/ResourceBrowser/Images/unavailable.png")+'"/>';this.setData("image",e),this.setData("fetched",1),this.update(e),this.rendered?this.setLoading(!1):this.on("afterrender",function(e){e.setLoading(!1)},this,{single:!0})},loadResource:function(e,t){if(t=="image")this.setData("image",this.GetImageThumbnailRel({width:this.layoutMgr.layoutEl.imageWidth,height:this.layoutMgr.layoutEl.imageHeight},{width:e.currentTarget.width,height:e.currentTarget.height}));else{this.resource.tags=e.tags;var n=this.resource.find_tags("geometry")||{value:"1,1,1,1,1"};n&&n.value&&(this.resource.geometry=n.value.split(","),this.resource.z=parseInt(this.resource.geometry[2]),this.resource.t=parseInt(this.resource.geometry[3])),this.setData("tags","true")}if(this.getData("tags")&&this.getData("image")){this.setData("fetched",1);var r=this.getData("renderedRef");r&&r.updateContainer()}},updateContainer:function(){var e=Ext.String.ellipsis(this.resource.name,25)||"";this.update('<div class="textOnImage" style="width:'+this.layoutMgr.layoutEl.width+'px;">'+e+"</div>"+this.getData("image")),this.setLoading(!1)}}),Ext.define("Bisque.Resource.Image.Card",{extend:"Bisque.Resource.Image",constructor:function(){Ext.apply(this,{layout:{type:"vbox",align:"stretch"}}),this.callParent(arguments)},prefetch:function(e){this.callParent(arguments);if(!this.getData("fetched")){this.setData("fetched",-1),BQFactory.load(this.resource.uri+"/tag",Ext.bind(this.loadResource,this,["tags"],!0));var t=new Image;t.src=this.getThumbnailSrc({width:this.layoutMgr.layoutEl.imageWidth,height:this.layoutMgr.layoutEl.imageHeight}),t.onload=Ext.bind(this.loadResource,this,["image"],!0)}},loadResource:function(e,t){if(t=="image")this.setData("image",this.GetImageThumbnailRel({width:this.layoutMgr.layoutEl.imageWidth,height:this.layoutMgr.layoutEl.imageHeight},{width:e.currentTarget.width,height:e.currentTarget.height}));else{this.resource.tags=e.tags;var n,r,i=[],s=this.getSummaryTags();for(var o=0;o<this.resource.tags.length;o++)n=this.resource.tags[o],r=new Ext.grid.property.Property({name:n.name,value:n.value}),s[n.name]?i.unshift(r):i.push(r);this.setData("tags",i.slice(0,7))}if(this.getData("tags")&&this.getData("image")){this.setData("fetched",1);var u=this.getData("renderedRef");u&&!u.isDestroyed&&u.updateContainer()}},getSummaryTags:function(){return this.browser.preferences["Summary Tags"]?this.browser.preferences["Summary Tags"]:{filename:0,"attached-file":0,image_type:0,imagedate:0,experimenter:0,dataset_label:0,species:0}},updateContainer:function(){var e=this.GetPropertyGrid({},this.getData("tags"));e.determineScrollbars=Ext.emptyFn;var t=new Ext.Component({html:this.getData("image"),height:this.layoutMgr.layoutEl.imageHeight});this.add([t,e]),this.setLoading(!1)},onMouseMove:Ext.emptyFn}),Ext.define("Bisque.Resource.Image.PStrip",{extend:"Bisque.Resource.Image.Compact",onClick:function(){this.msgBus.fireEvent("PStripResourceClick",this.resource,this.layoutMgr)},afterRenderFn:function(){this.ttip=1,this.callParent(arguments)},requestTags:Ext.emptyFn}),Ext.define("Bisque.Resource.Image.PStripBig",{extend:"Bisque.Resource.Image",constructor:function(e){this.callParent(arguments),Ext.apply(this,{layout:{type:"fit"},overCls:"",data:{}}),this.setSize(e.bigPanel.getSize()),this.pnlSize=e.bigPanel.getSize(),this.pnlSize.width=Math.floor(.5*this.pnlSize.width);var t=new Image;t.src=this.resource.src+"?thumbnail="+(this.pnlSize.width-10).toString()+","+(this.pnlSize.height-10).toString(),t.onload=Ext.bind(this.loadResource,this)},loadResource:function(e,t){var n=new Bisque.ResourceTagger({region:"center",resource:this.resource.uri});this.data.image=this.GetImageThumbnailAbs({width:this.pnlSize.width-10,height:this.pnlSize.width-10},{width:e.currentTarget.width,height:e.currentTarget.height},!0);var r=new Ext.get(document.createElement("div"));r.update(this.data.image),this.add(new Ext.Panel({layout:"border",border:!1,items:[new Ext.Container({region:"west",layout:{type:"vbox",align:"top"},width:"50%",cls:"white",contentEl:r}),n]})),this.setLoading(!1)},preAfterRender:Ext.emptyFn,afterRenderFn:Ext.emptyFn}),Ext.define("Bisque.Resource.Image.Full",{extend:"Bisque.Resource.Image",constructor:function(){Ext.apply(this,{layout:"fit"}),this.callParent(arguments)},prefetch:function(e){this.callParent(arguments);if(!this.getData("fetched")){this.setData("fetched",-1),BQFactory.load(this.resource.uri+"/tag",Ext.bind(this.loadResource,this,["tags"],!0));var t=new Image;t.src=this.getThumbnailSrc({width:this.layoutMgr.layoutEl.imageWidth,height:this.layoutMgr.layoutEl.imageHeight}),t.onload=Ext.bind(this.loadResource,this,["image"],!0)}},loadResource:function(e,t){if(t=="image")this.setData("image",this.GetImageThumbnailAbs({width:this.layoutMgr.layoutEl.imageWidth,height:this.layoutMgr.layoutEl.imageHeight},{width:e.currentTarget.width,height:e.currentTarget.height},!0));else{this.resource.tags=e.tags;var n=[],r={},i="";for(var s=0;s<this.resource.tags.length;s++)i=this.resource.tags[s].value,r[this.resource.tags[s].name]=i==null||i==""?"None":i,n.push(new Ext.grid.property.Property({name:this.resource.tags[s].name,value:r[this.resource.tags[s].name]}));this.setData("tags",n)}this.getData("tags")&&this.getData("image")&&(this.setData("fetched",1),this.rendered&&this.updateContainer())},updateContainer:function(){this.setLoading(!1);var e=this.GetPropertyGrid({autoHeight:!1},this.getData("tags"));e.setAutoScroll(!0),e.region="center",e.padding=5,e.style="background-color:#FAFAFA";var t=new Ext.get(document.createElement("div"));t.dom.align="center",t.update(this.getData("image")),this.add(new Ext.Panel({layout:"border",border:!1,items:[new Ext.Container({region:"west",layout:{type:"hbox",pack:"center",align:"center"},region:"west",padding:5,width:this.layoutMgr.layoutEl.imageHeight+10,style:"background-color:#FAFAFA",contentEl:t}),e]}))},onMouseMove:Ext.emptyFn,onMouseEnter:Ext.emptyFn}),Ext.define("Bisque.Resource.Image.Grid",{extend:"Bisque.Resource.Image",prefetch:function(e){this.callParent(arguments);var t=new Image;t.src=this.resource.src+"?thumbnail=75,75&format=jpeg"},getFields:function(e){var t=this.callParent();return t[0]='<img style="height:40px;width:40px;" src='+this.resource.src+"?thumbnail=75,75&format=jpeg />",t[6].height=48,t}}),Ext.define("Bisque.Resource.Image.Page",{extend:"Bisque.Resource.Page",onResourceRender:function(){this.setLoading(!0),this.root="",this.resource&&this.resource.uri&&(this.root=this.resource.uri.replace(/\/data_service\/.*$/i,""));var e=Ext.create("Bisque.ResourceTagger",{resource:this.resource,title:"Annotations"}),t=Ext.create("Bisque.ResourceTagger",{resource:this.resource.src+"?meta",title:"Embedded",viewMode:"ReadOnly"}),n=new Bisque.ResourceBrowser.Browser({layout:5,title:"Analysis",viewMode:"MexBrowser",dataset:this.root+"/data_service/mex",tagQuery:'"'+this.resource.uri+'"',wpublic:!0,showOrganizer:!1,mexLoaded:!1,listeners:{browserLoad:function(e,t){e.mexLoaded=!0},Select:function(e,t){window.open(bq.url("/module_service/"+t.name+"/?mex="+t.uri))},scope:this}}),r=Ext.create("Ext.tab.Panel",{title:"Metadata",region:"east",activeTab:0,border:!1,bodyBorder:0,collapsible:!0,split:!0,width:400,plain:!0,bodyStyle:"background-color:#F00",items:[e,t,n]}),i=Ext.create("BQ.viewer.Image",{region:"center",resource:this.resource,toolbar:this.toolbar,parameters:{gobjectCreated:Ext.bind(function(e){this.gobjectTagger.appendGObjects([e])},this),gobjectDeleted:Ext.bind(function(e){this.gobjectTagger.deleteGObject(e)},this)},listeners:{changed:function(e,t){this.gobjectTagger.tree.getView().refresh()},scope:this}});this.add({xtype:"container",layout:"border",items:[i,r]}),this.gobjectTagger=new Bisque.GObjectTagger({resource:this.resource,imgViewer:i.viewer,mexBrowser:n,title:"Graphical",viewMode:"GObjectTagger",readFromMex:function(e){function t(e){this.appendFromMex([{resource:e}])}for(var n=0;n<e.length;n++)BQFactory.request({uri:e[n].resource.uri+"?view=deep",cb:Ext.bind(t,this)})},listeners:{beforeload:function(e,t){e.imgViewer.start_wait({op:"gobjects",message:"Fetching gobjects"})},onload:function(e,t){e.imgViewer.loadGObjects(t.gobjects,!1),e.mexBrowser.mexLoaded?e.readFromMex(e.mexBrowser.resourceQueue):e.mexBrowser.on("browserLoad",function(t,n){e.readFromMex(n)},e)},onappend:function(e,t){e.imgViewer.gobjectsLoaded(!0,t)},select:function(e,t,n){var r=t.raw instanceof BQGObject?t.raw:t.raw.gobjects;e.imgViewer.showGObjects(r)},deselect:function(e,t,n){var r=t.raw instanceof BQGObject?t.raw:t.raw.gobjects;e.imgViewer.hideGObjects(r)}}}),r.add(this.gobjectTagger),r.add({xtype:"bqgmap",title:"Map",url:this.resource.src+"?meta",zoomLevel:16,gmapType:"map",autoShow:!0}),this.setLoading(!1)},downloadOriginal:function(){window.open(this.resource.src)}}),Ext.define("Bisque.Resource.Mex",{extend:"Bisque.Resource",afterRenderFn:function(){this.setData("renderedRef",this),this.getData("fetched")==1&&this.updateContainer()}}),Ext.define("Bisque.Resource.Mex.Compact",{extend:"Bisque.Resource.Mex",constructor:function(){Ext.apply(this,{layout:{type:"vbox",align:"stretch"}}),this.callParent(arguments),this.addCls("compact")},onMouseEnter:function(){this.tagsLoaded||BQFactory.request({uri:this.resource.uri+"/tag",cb:Ext.bind(this.tagData,this)}),this.callParent(arguments)},tagData:function(e){this.tagsLoaded=!0,this.resource.tags=e.tags;var t=[],n={},r="";for(var i=0;i<this.resource.tags.length;i++)r=this.resource.tags[i].value,n[this.resource.tags[i].name]=r==null||r==""?"None":r,t.push(new Ext.grid.property.Property({name:this.resource.tags[i].name,value:n[this.resource.tags[i].name]}));var s=this.GetPropertyGrid({width:270},t);t.length>0&&this.ttip&&this.ttip.add(s),this.ttip&&this.ttip.setLoading(!1)},prefetch:function(){this.getData("fetched")||(this.setData("fetched",-1),this.loadResource({name:"Module.NoName"}))},loadResource:function(e){this.setData("module",e.name),this.setData("fetched",1);var t=this.getData("renderedRef");t&&t.updateContainer()},updateContainer:function(){var e=Ext.create("Ext.container.Container",{cls:"lblHeading1",html:Ext.String.ellipsis(this.resource.name||"undefined",24)}),t=new Date;t.setISO(this.resource.ts);var n=Ext.create("Ext.container.Container",{cls:"lblHeading2",html:Ext.Date.format(t,"m-d-Y g:i:s a")}),r=Ext.create("Ext.container.Container",{cls:"lblContent",html:this.resource.value});this.add([e,n,r]),this.setLoading(!1)}}),Ext.define("Bisque.Resource.Mex.Card",{extend:"Bisque.Resource.Card",prefetch:function(e){this.superclass.superclass.prefetch.apply(this,arguments),this.getData("fetched")||(this.setData("fetched",-1),BQFactory.load(this.resource.uri+"/tag?view=deep",Ext.bind(this.loadResource,this)))},loadResource:function(e){this.resource.tags=e.tags;var t,n=[],r=this.resource.toDict(!0);for(var i in r)t=new Ext.grid.property.Property({name:i,value:r[i]}),i.indexOf("inputs")!=-1||i.indexOf("outputs")!=-1?n.unshift(t):n.push(t);this.setData("tags",n.slice(0,12)),this.setData("fetched",1);var s=this.getData("renderedRef");s&&!s.isDestroyed&&s.updateContainer()}}),Ext.define("Bisque.Resource.Mex.Full",{extend:"Bisque.Resource.Full",loadResource:function(e){this.resource.tags=e.tags;var t,n=[],r=this.resource.toDict(!0);for(var i in r)t=new Ext.grid.property.Property({name:i,value:r[i]}),n.push(t);this.setData("tags",n),this.setData("fetched",1);var s=this.getData("renderedRef");s&&!s.isDestroyed&&s.updateContainer()}}),Ext.define("Bisque.Resource.Mex.List",{extend:"Bisque.Resource.Mex",constructor:function(){Ext.apply(this,{layout:{type:"hbox",align:"middle"}}),this.callParent(arguments),this.addCls("list")},afterRenderFn:function(e){this.ttip||(this.ttip=Ext.create("Ext.tip.ToolTip",{target:e.id,width:278,cls:"LightShadow",layout:"hbox",style:{"background-color":"#FAFAFA",border:"solid 3px #E0E0E0"},listeners:{afterrender:function(e){this.tagsLoaded||e.setLoading({msg:""})},scope:this}})),this.callParent(arguments)},onMouseEnter:function(){this.tagsLoaded||BQFactory.request({uri:this.resource.uri+"/tag",cb:Ext.bind(this.tagData,this)}),this.callParent(arguments)},onMouseLeave:function(e){this.mouseIn=!1,this.callParent(arguments)},tagData:function(e){this.tagsLoaded=!0,this.resource.tags=e.tags;var t=[],n={},r="";for(var i=0;i<this.resource.tags.length;i++)r=this.resource.tags[i].value,n[this.resource.tags[i].name]=r==null||r==""?"None":r,t.push(new Ext.grid.property.Property({name:this.resource.tags[i].name,value:n[this.resource.tags[i].name]}));var s=this.GetPropertyGrid({width:270},t);t.length>0&&this.ttip.add(s),this.ttip.setLoading(!1)},prefetch:function(){this.getData("fetched")||(this.setData("fetched",-1),this.resource.module&&this.resource.module.indexOf(window.location.host)!=-1?BQFactory.request({uri:this.resource.module,cb:Ext.bind(this.loadResource,this),errorcb:Ext.emptyFn}):this.loadResource({name:"Module.NoName"}))},loadResource:function(e){this.setData("module",this.resource.name),this.setData("fetched",1);var t=this.getData("renderedRef");t&&t.updateContainer()},updateContainer:function(){var e=new Ext.form.Label({text:" "+Ext.String.ellipsis(this.resource.name,22)+" ",padding:"0 8 0 8",cls:"lblModuleName"}),t=new Ext.form.Label({text:this.resource.status,padding:"0 0 0 4",cls:this.resource.status=="FINISHED"?"lblModuleOwnerFin":this.resource.status=="FAILED"?"lblModuleOwnerFail":"lblModuleOwner"}),n=new Date;n.setISO(this.resource.ts);var r=new Ext.form.Label({text:Ext.Date.format(n,"F j, Y g:i:s a"),padding:"0 0 0 8",cls:"lblModuleDate",flex:1});this.add([e,t,r]),this.setLoading(!1)}}),Ext.define("Bisque.Resource.Mex.Grid",{extend:"Bisque.Resource.Mex",getFields:function(e){var t=this.resource.status||"unknown",n=this.resource,r=t=="FINISHED"?"#1C1":t=="FAILED"?"#E11":"#22F";return["",n.name||"",'<div style="color:'+r+'">'+Ext.String.capitalize(t.toLowerCase())+"</div>"||"",n.resource_type,n.ts,this,{height:21}]}}),Ext.define("Bisque.Resource.Module",{extend:"Bisque.Resource",afterRenderFn:function(){this.setData("renderedRef",this),this.getData("fetched")==1&&this.updateContainer()}}),Ext.define("Bisque.Resource.Module.Compact",{extend:"Bisque.Resource.Module",constructor:function(){Ext.apply(this,{layout:{type:"vbox",align:"stretch"}}),this.callParent(arguments),this.addCls("compact")},prefetch:function(){this.getData("fetched")||(this.setData("fetched",-1),BQFactory.request({uri:this.resource.owner,cb:Ext.bind(this.loadResource,this),errorcb:Ext.emptyFn}))},loadResource:function(e){this.setData("owner",e.display_name),this.setData("fetched",1);var t=this.getData("renderedRef");t&&t.updateContainer()},updateContainer:function(){var e=Ext.create("Ext.container.Container",{cls:"lblHeading1",html:this.resource.name}),t=Ext.create("Ext.container.Container",{cls:"lblHeading2",html:this.getData("owner")}),n=Ext.create("Ext.container.Container",{cls:"lblContent",html:this.resource.value});this.add([e,t,n]),this.setLoading(!1)}}),Ext.define("Bisque.Resource.Module.List",{extend:"Bisque.Resource.Module",constructor:function(){Ext.apply(this,{layout:{type:"hbox",align:"middle"}}),this.callParent(arguments)},afterRenderFn:function(e){this.ttip||(this.ttip=Ext.create("Ext.tip.ToolTip",{target:e.id,width:278,cls:"LightShadow",style:"background-color:#FAFAFA;border: solid 3px #E0E0E0;",layout:"hbox",autoHide:!1,listeners:{afterrender:function(e){this.tagsLoaded||e.setLoading({msg:""})},scope:this}})),this.callParent(arguments)},onMouseEnter:function(){this.tagsLoaded||BQFactory.request({uri:this.resource.uri+"/tag",cb:Ext.bind(this.tagData,this)}),this.callParent(arguments)},tagData:function(e){this.tagsLoaded=!0,this.resource.tags=e.tags;var t=[],n={},r="";for(var i=0;i<this.resource.tags.length;i++)r=this.resource.tags[i].value,n[this.resource.tags[i].name]=r==null||r==""?"None":r,t.push(new Ext.grid.property.Property({name:this.resource.tags[i].name,value:n[this.resource.tags[i].name]}));var s=this.GetPropertyGrid({width:270},t);this.ttip.add(s),this.ttip.setLoading(!1)},prefetch:function(){this.getData("fetched")||(this.setData("fetched",-1),BQFactory.request({uri:this.resource.uri+"?view=deep",cb:Ext.bind(this.loadResourceTags,this),errorcb:Ext.emptyFn}))},loadResourceTags:function(e){this.setData("tags",e.tags),BQFactory.request({uri:this.resource.owner,cb:Ext.bind(this.loadResource,this),errorcb:Ext.emptyFn})},loadResource:function(e){this.setData("owner",e.display_name),this.setData("fetched",1);var t=this.getData("renderedRef");t&&t.updateContainer()},updateContainer:function(){var e=new Ext.form.Label({text:" "+this.resource.name+" ",cls:"lblModuleName"}),t=new Ext.form.Label({text:this.getData("owner"),cls:"lblModuleOwner"}),n=new Ext.form.Label({text:this.resource.type,padding:5,style:"color:#444"});this.add([e,t,n]),this.setLoading(!1)}}),Ext.define("Bisque.Resource.Module.IconList",{extend:"Bisque.Resource.Module.List",initComponent:function(){this.addCls("icon-list"),this.callParent()},afterRenderFn:function(){this.ttip=1,this.tagsLoaded=1,this.callParent(arguments)},updateContainer:function(){var e=BisqueServices.getURL("module_service")+this.resource.name,t=this.getData("tags"),n;for(var r=0;r<t.length;r++)t[r].name=="description"&&(n=t[r].value);var i=Ext.create("Ext.container.Container",{margin:"0 0 0 4",width:110,height:110,html:'<img style="position:relative;height:100%;width:100%" src="'+e+'/thumbnail"/>'}),s=new Ext.form.Label({text:this.resource.name,cls:"lblModuleName"}),o=new Ext.form.Label({html:this.getData("owner")!=0?"Owner: "+this.getData("owner"):"",maxHeight:18,cls:"lblModuleOwner"}),u=new Ext.form.Label({html:n,padding:"7 2 0 3"}),a=Ext.create("Ext.container.Container",{layout:{type:"vbox",align:"stretch"},margin:"2 0 0 2",height:120,flex:1,items:[s,o,u]});this.add([i,a]),this.setLoading(!1)}}),Ext.define("Bisque.Resource.Module.Page",{extend:"Bisque.Resource.Page"}),Ext.define("Bisque.Resource.Dataset",{extend:"Bisque.Resource",initComponent:function(){this.addCls("dataset"),this.callParent()},afterRenderFn:function(){this.setData("renderedRef",this),this.getData("fetched")==1&&this.updateContainer()}}),Ext.define("Bisque.Resource.Dataset.Compact",{extend:"Bisque.Resource.Dataset",constructor:function(){Ext.apply(this,{layout:{type:"vbox",align:"stretch"}}),this.callParent(arguments),this.addCls("compact")},prefetch:function(){this.getData("fetched")||(this.setData("fetched",-1),this.fetchMembers(this.resource))},fetchMembers:function(e){BQFactory.request({uri:e.uri+"/value?limit=4",cb:Ext.bind(this.loadResource,this),errorcb:Ext.emptyFn})},loadResource:function(e){var t='<div style = "margin:4px;width:152px;height:152px">',n,r;for(var i=0;i<e.children.length&&i<4;i++){switch(e.children[i].resource_type){case"image":n=e.children[i].src+"?thumbnail=75,75&format=jpeg";break;case"dataset":n=bq.url("../export_service/public/images/folder-large.png");break;default:n=bq.url("../export_service/public/images/file-large.png")}r=i==1?"margin:0px 0px 0px 2px;":i==2?"margin:2px 2px 0px 0px;":"",t+='<img style="display:inline-block;height:75px;width:75px;'+r+'" src='+n+" />"}t+="</div>",this.setData("fetched",1),this.setData("previewDiv",t);var s=this.getData("renderedRef");s&&s.updateContainer()},updateContainer:function(){var e=new Date;e.setISO(this.resource.ts),this.update('<div class="labelOnImage" style="width:160px;">'+this.resource.name+'<br><span class="smallLabelOnImage">'+Ext.Date.format(e,"m/d/Y")+"</span></div>"+this.getData("previewDiv")),this.setLoading(!1)}}),Ext.define("Bisque.Resource.Dataset.Card",{extend:"Bisque.Resource.Dataset.Compact",loadResource:function(e){var t='<div style = "margin:0px 0px 0px 12px;width:258px;height:310px">',n,r;for(var i=0;i<e.children.length&&i<12;i++){switch(e.children[i].resource_type){case"image":n=e.children[i].src+"?thumbnail=75,75&format=jpeg";break;case"dataset":n=bq.url("../export_service/public/images/folder-large.png");break;default:n=bq.url("../export_service/public/images/file-large.png")}r="margin:0px 3px 2px 0px;",t+='<img style="display:inline-block;height:75px;width:75px;'+r+'" src='+n+" />"}t+="</div>",this.setData("fetched",1),this.setData("previewDiv",t);var s=this.getData("renderedRef");s&&s.updateContainer()},updateContainer:function(){var e=new Date;e.setISO(this.resource.ts),this.update('<div class="labelOnImage" style="width:260px;">'+this.resource.name+'<br><span class="smallLabelOnImage">'+Ext.Date.format(e,"m/d/Y")+"</span></div>"+this.getData("previewDiv")),this.setLoading(!1)}}),Ext.define("Bisque.Resource.Dataset.Full",{extend:"Bisque.Resource.Dataset.Compact",constructor:function(){this.callParent(arguments),Ext.apply(this,{layout:"fit"})},loadResource:function(e){var t='<div style = "margin:0px 0px 0px 12px;width:99%;">',n,r;for(var i=0;i<e.children.length;i++){switch(e.children[i].resource_type){case"image":n=e.children[i].src+"?thumbnail=75,75&format=jpeg";break;case"dataset":n=bq.url("../export_service/public/images/folder-large.png");break;default:n=bq.url("../export_service/public/images/file-large.png")}r="margin:0px 3px 2px 0px;",t+='<img style="display:inline-block;height:75px;width:75px;'+r+'" src='+n+" />"}t+="</div>",this.setData("fetched",1),this.setData("previewDiv",t);var s=this.getData("renderedRef");s&&s.updateContainer()},updateContainer:function(){var e=new Date;e.setISO(this.resource.ts);var t=new Ext.get(document.createElement("div"));t.update('<div class="labelOnImage" style="width:99%;">'+this.resource.name+'<br><span class="smallLabelOnImage">'+Ext.Date.format(e,"m/d/Y")+"</span></div>"+this.getData("previewDiv")),this.add(Ext.create("Ext.panel.Panel",{border:0,autoScroll:!0,contentEl:t})),this.setLoading(!1)}}),Ext.define("Bisque.Resource.Dataset.List",{extend:"Bisque.Resource.Dataset.Compact",constructor:function(){this.callParent(arguments),Ext.apply(this,{layout:{type:"hbox",align:"middle"}}),this.addCls("list")},updateContainer:function(){var e=new Ext.form.Label({text:" "+this.resource.name+" ",padding:"0 8 0 8",cls:"lblModuleName"}),t=new Ext.form.Label({text:this.getData("owner"),padding:"0 0 0 4",cls:"lblModuleOwner"}),n=new Date;n.setISO(this.resource.ts);var r=new Ext.form.Label({text:Ext.Date.format(n,"F j, Y g:i:s a"),cls:"lblModuleDate",flex:1});this.add([e,t,r]),this.setLoading(!1)}}),Ext.define("Bisque.Resource.Dataset.Page",{extend:"Bisque.Resource",constructor:function(){Ext.apply(this,{layout:"fit"}),this.callParent(arguments)},updateContainer:function(){this.setLoading(!1);var e=Ext.create("BQ.renderers.dataset",{resource:this.resource,loadmap:!0});this.add(e)}}),Ext.define("Bisque.Resource.File.Page",{extend:"Bisque.Resource.Page",downloadOriginal:function(){window.open(this.resource.src)}}),Ext.define("Bisque.Resource.User.Grid",{extend:"Bisque.Resource.Grid",getFields:function(e){var t=BQApp.userList[this.resource.owner];this.displayName=t?t.find_tags("display_name").value:"",this.resource.display_name=this.displayName;var n=this.callParent();return n[1]=this.displayName,n[2]=t.email||"",n}}),Ext.define("Bisque.Resource.Template.Page",{extend:"Bisque.Resource.Page",onResourceRender:function(){this.setLoading(!1);var e=new BQ.TemplateManager.create({resource:this.resource});this.add(e),this.toolbar.insert(0,[{xtype:"tbspacer",width:8},{text:"Save",iconCls:"icon-save",handler:e.saveTemplate,scope:e},"-"])}}),Ext.define("Bisque.Misc.MessageBus",{extend:"Ext.util.Observable"}),Ext.namespace("Bisque.Misc"),Ext.define("Bisque.Misc.Slider",{extend:"Ext.panel.Panel",height:32,width:200,border:!1,leftBtn:!1,rightBtn:!1,label:null,slider:null,bodyStyle:"background:transparent;",layout:{type:"vbox",align:"stretch"},items:[{xtype:"tbtext",text:"Showing 0 of total 0",style:"text-align:center"},{xtype:"slider",minValue:0,hideLabel:!0,maxValue:100,margin:"0 10 10 10",cls:"sliderBackground",tipText:function(e){return Ext.String.format("<b>View resource: {0}</b>",e.value)}}],initComponent:function(){this.callParent(arguments),this.label=this.getLabel(),this.slider=this.getSlider(),this.slider.on("changecomplete",function(e,t){this.fireEvent("buttonClick",t-1)},this)},getLabel:function(){return this.getComponent(0)},getSlider:function(){return this.getComponent(1)},setStatus:function(e){if(!this.hidden){var t=e.sliderSt;this.label.setText(e.status),this.showLeftBtn(t.left),this.showRightBtn(t.right),this.slider.setMinValue(t.min),this.slider.setMaxValue(t.max),this.slider.setValue(t.value)}},showLeftBtn:function(e){e?(this.slider.addCls("sliderLeftButton"),this.rightBtn&&this.slider.addCls("sliderBothButtons"),this.leftBtn=!0):(this.rightBtn&&this.slider.removeCls("sliderBothButtons"),this.slider.removeCls("sliderLeftButton"),this.leftBtn=!1)},showRightBtn:function(e){e?(this.slider.addCls("sliderRightButton"),this.leftBtn&&this.slider.addCls("sliderBothButtons"),this.rightBtn=!0):(this.leftBtn&&this.slider.removeCls("sliderBothButtons"),this.slider.removeCls("sliderRightButton"),this.rightBtn=!1)},destroy:function(){this.rendered&&!this.hidden&&this.callParent(arguments)}}),Ext.ux.DataTip=Ext.extend(Ext.ToolTip,function(){function e(){var e=this.body||this.el;this.dataTip.renderToTarget&&this.dataTip.render(e),this.dataTip.setTarget(e)}function t(e,t){e.rendered?e.update(t):Ext.isString(t)?e.html=t:e.data=t}function n(e){var n=Ext.fly(e.triggerElement).findParent("div.x-tree-node-el",null,!0),r=n?e.host.getNodeById(n.getAttribute("tree-node-id","ext")):null;if(!r)return!1;t(e,r.attributes)}function r(e){var n=this.host.getStore().getAt(e.triggerElement.viewIndex);if(!n)return!1;t(e,n.data)}function i(e){var n=this.host.getRecord(e.triggerElement);if(!n)return!1;t(e,n.data)}function s(e){var n=Ext.fly(e.triggerElement).child("input,textarea"),r=n?this.host.getForm().findField(n.id):null;if(!r||!r.tooltip&&!e.tpl)return!1;t(e,r.tooltip||r)}function o(e){var n=this.host.store.getAt(this.host.selectedIndex);if(!n)return!1;t(e,n.data)}return{init:function(t){t.dataTip=this,this.host=t,t instanceof Ext.tree.TreePanel?(this.delegate=this.delegate||"div.x-tree-node-el",this.on("beforeshow",n)):t instanceof Ext.grid.GridPanel?(this.delegate=this.delegate||t.getView().itemSelector,this.on("beforeshow",r)):t instanceof Ext.DataView?(this.delegate=this.delegate||t.itemSelector,this.on("beforeshow",i)):t instanceof Ext.FormPanel?(this.delegate="div.x-form-item",this.on("beforeshow",s)):t instanceof Ext.form.ComboBox&&(this.delegate=this.delegate||t.itemSelector,this.on("beforeshow",o)),t.rendered?e.call(t):t.onRender=Ext.Function.createSequence(t.onRender,e)}}}()),typeof ExtTouch=="undefined"&&(ExtTouch={}),ExtTouch.apply=function(){for(var e in{valueOf:1})return function(e,t,n){n&&ExtTouch.apply(e,n);if(e&&t&&typeof t=="object")for(var r in t)e[r]=t[r];return e};return function(e,t,n){n&&ExtTouch.apply(e,n);if(e&&t&&typeof t=="object"){for(var r in t)e[r]=t[r];t.toString!==Object.prototype.toString&&(e.toString=t.toString),t.valueOf!==Object.prototype.valueOf&&(e.valueOf=t.valueOf)}return e}}(),ExtTouch.apply(ExtTouch,{platformVersion:"1.0",platformVersionDetail:{major:1,minor:0,patch:3},userAgent:navigator.userAgent.toLowerCase(),cache:{},idSeed:1e3,BLANK_IMAGE_URL:"data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==",isStrict:document.compatMode=="CSS1Compat",windowId:"ExtTouch-window",documentId:"ExtTouch-document",emptyFn:function(){},isSecure:/^https/i.test(window.location.protocol),isReady:!1,enableGarbageCollector:!0,enableListenerCollection:!0,applyIf:function(e,t){var n,r;if(e)for(n in t)e[n]===r&&(e[n]=t[n]);return e},repaint:function(){var e=ExtTouch.getBody().createChild({cls:"x-mask x-mask-transparent"});setTimeout(function(){e.remove()},0)},id:function(e,t){return e=ExtTouch.getDom(e)||{},e===document?e.id=this.documentId:e===window&&(e.id=this.windowId),e.id=e.id||(t||"ExtTouch-gen")+ ++ExtTouch.idSeed,e.id},ExtTouchend:function(){var e=function(e){for(var t in e){if(!e.hasOwnProperty(t))continue;this[t]=e[t]}},t=Object.prototype.constructor;return function(n,r,i){ExtTouch.isObject(r)&&(i=r,r=n,n=i.constructor!=t?i.constructor:function(){r.apply(this,arguments)});if(!r)throw"Attempting to ExtTouchend from a class which has not been loaded on the page.";var s=function(){},o,u=r.prototype;return s.prototype=u,o=n.prototype=new s,o.constructor=n,n.superclass=u,u.constructor==t&&(u.constructor=r),n.override=function(e){ExtTouch.override(n,e)},o.superclass=o.supr=function(){return u},o.override=e,o.proto=o,n.override(i),n.ExtTouchend=function(e){return ExtTouch.ExtTouchend(n,e)},n}}(),override:function(e,t){ExtTouch.apply(e.prototype,t)},namespace:function(){var e=arguments.length,t,n,r,i,s,o,u;for(t=0;t<e;t++){n=arguments[t],o=n.split("."),window.ExtTouch?u=window[o[0]]=Object(window[o[0]]):u=arguments.callee.caller.arguments[0];for(i=1,s=o.length;i<s;i++)u=u[o[i]]=Object(u[o[i]])}return u},urlEncode:function(e,t){var n,r=[],i=encodeURIComponent;return ExtTouch.iterate(e,function(e,t){n=ExtTouch.isEmpty(t),ExtTouch.each(n?e:t,function(t){r.push("&",i(e),"=",!ExtTouch.isEmpty(t)&&(t!=e||!n)?ExtTouch.isDate(t)?ExtTouch.encode(t).replace(/"/g,""):i(t):"")})}),t||(r.shift(),t=""),t+r.join("")},urlDecode:function(e,t){if(ExtTouch.isEmpty(e))return{};var n={},r=e.split("&"),i=decodeURIComponent,s,o;return ExtTouch.each(r,function(e){e=e.split("="),s=i(e[0]),o=i(e[1]),n[s]=t||!n[s]?o:[].concat(n[s]).concat(o)}),n},htmlEncode:function(e){return ExtTouch.util.Format.htmlEncode(e)},htmlDecode:function(e){return ExtTouch.util.Format.htmlDecode(e)},urlAppend:function(e,t){return ExtTouch.isEmpty(t)?e:e+(e.indexOf("?")===-1?"?":"&")+t},toArray:function(e,t,n){return Array.prototype.slice.call(e,t||0,n||e.length)},each:function(e,t,n){if(ExtTouch.isEmpty(e,!0))return 0;if(!ExtTouch.isIterable(e)||ExtTouch.isPrimitive(e))e=[e];for(var r=0,i=e.length;r<i;r++)if(t.call(n||e[r],e[r],r,e)===!1)return r;return!0},iterate:function(e,t,n){if(ExtTouch.isEmpty(e))return;if(ExtTouch.isIterable(e)){ExtTouch.each(e,t,n);return}if(ExtTouch.isObject(e))for(var r in e)if(e.hasOwnProperty(r)&&t.call(n||e,r,e[r],e)===!1)return},pluck:function(e,t){var n=[];return ExtTouch.each(e,function(e){n.push(e[t])}),n},getBody:function(){return ExtTouch.get(document.body||!1)},getHead:function(){var e;return function(){return e==undefined&&(e=ExtTouch.get(DOC.getElementsByTagName("head")[0])),e}}(),getDoc:function(){return ExtTouch.get(document)},getCmp:function(e){return ExtTouch.ComponentMgr.get(e)},getOrientation:function(){return window.innerHeight>window.innerWidth?"portrait":"landscape"},isIterable:function(e){return e?ExtTouch.isArray(e)||e.callee?!0:/NodeList|HTMLCollection/.test(Object.prototype.toString.call(e))?!0:(typeof e.nExtTouchNode!="undefined"||e.item)&&ExtTouch.isNumber(e.length)||!1:!1},num:function(e,t){return e=Number(ExtTouch.isEmpty(e)||ExtTouch.isArray(e)||typeof e=="boolean"||typeof e=="string"&&ExtTouch.util.Format.trim(e).length==0?NaN:e),isNaN(e)?t:e},isEmpty:function(e,t){var n=e==null,r=ExtTouch.isArray(e)&&!e.length,i=t?!1:e==="";return n||r||i},isArray:function(e){return Object.prototype.toString.apply(e)==="[object Array]"},isDate:function(e){return Object.prototype.toString.apply(e)==="[object Date]"},isObject:function(e){return!!e&&!e.tagName&&Object.prototype.toString.call(e)==="[object Object]"},isPrimitive:function(e){return ExtTouch.isString(e)||ExtTouch.isNumber(e)||ExtTouch.isBoolean(e)},isFunction:function(e){return Object.prototype.toString.apply(e)==="[object Function]"},isNumber:function(e){return Object.prototype.toString.apply(e)==="[object Number]"&&isFinite(e)},isString:function(e){return typeof e=="string"},isBoolean:function(e){return Object.prototype.toString.apply(e)==="[object Boolean]"},isElement:function(e){return e?!!e.tagName:!1},isDefined:function(e){return typeof e!="undefined"},destroy:function(){var e=arguments.length,t,n;for(t=0;t<e;t++)n=arguments[t],n&&(ExtTouch.isArray(n)?this.destroy.apply(this,n):ExtTouch.isFunction(n.destroy)?n.destroy():n.dom&&n.remove())}}),ExtTouch.SSL_SECURE_URL=ExtTouch.isSecure&&"about:blank",ExtTouch.ns=ExtTouch.namespace,ExtTouch.ns("ExtTouch.util","ExtTouch.data","ExtTouch.list","ExtTouch.form","ExtTouch.menu","ExtTouch.state","ExtTouch.layout","ExtTouch.app","ExtTouch.ux","ExtTouch.plugins","ExtTouch.direct","ExtTouch.lib","ExtTouch.gesture"),ExtTouch.onReady=function(){},ExtTouch.applyIf(Array.prototype,{indexOf:function(e,t){var n=this.length;t=t||0,t+=t<0?n:0;for(;t<n;++t)if(this[t]===e)return t;return-1},remove:function(e){var t=this.indexOf(e);return t!=-1&&this.splice(t,1),this},contains:function(e){return this.indexOf(e)!==-1}}),function(){var e=ExtTouch.Element=ExtTouch.ExtTouchend(Object,{defaultUnit:"px",constructor:function(e,t){var n=typeof e=="string"?document.getElementById(e):e,r;return n?(r=n.id,!t&&r&&ExtTouch.cache[r]?ExtTouch.cache[r].el:(this.dom=n,this.id=r||ExtTouch.id(n),this)):null},set:function(e,t){var n=this.dom,r,i;for(r in e)e.hasOwnProperty(r)&&(i=e[r],r=="style"?this.applyStyles(i):r=="cls"?n.className=i:t!==!1?n.setAttribute(r,i):n[r]=i);return this},is:function(e){return ExtTouch.DomQuery.is(this.dom,e)},getValue:function(e){var t=this.dom.value;return e?parseInt(t,10):t},addListener:function(e,t,n,r){return ExtTouch.EventManager.on(this.dom,e,t,n||this,r),this},removeListener:function(e,t,n){return ExtTouch.EventManager.un(this.dom,e,t,n),this},removeAllListeners:function(){return ExtTouch.EventManager.removeAll(this.dom),this},purgeAllListeners:function(){return ExtTouch.EventManager.purgeElement(this,!0),this},remove:function(){var e=this,t=e.dom;t&&(delete e.dom,ExtTouch.removeNode(t))},isAncestor:function(e){var t=this.dom;return e=ExtTouch.getDom(e),t&&e?t.contains(e):!1},isDescendent:function(e){return ExtTouch.fly(e,"_internal").isAncestor(this)},contains:function(e){return e?this.isAncestor(e):!1},getAttribute:function(e,t){var n=this.dom;return n.getAttributeNS(t,e)||n.getAttribute(t+":"+e)||n.getAttribute(e)||n[e]},setHTML:function(e){return this.dom&&(this.dom.innerHTML=e),this},getHTML:function(){return this.dom?this.dom.innerHTML:""},hide:function(){return this.setVisible(!1),this},show:function(){return this.setVisible(!0),this},setVisible:function(t,n){var r=this,i=r.dom,s=this.getVisibilityMode();switch(s){case e.VISIBILITY:this.removeCls(["x-hidden-display","x-hidden-offsets"]),this[t?"removeCls":"addCls"]("x-hidden-visibility");break;case e.DISPLAY:this.removeCls(["x-hidden-visibility","x-hidden-offsets"]),this[t?"removeCls":"addCls"]("x-hidden-display");break;case e.OFFSETS:this.removeCls(["x-hidden-visibility","x-hidden-display"]),this[t?"removeCls":"addCls"]("x-hidden-offsets")}return r},getVisibilityMode:function(){var t=this.dom,n=e.data(t,"visibilityMode");return n===undefined&&e.data(t,"visibilityMode",n=e.DISPLAY),n},setVisibilityMode:function(t){return e.data(this.dom,"visibilityMode",t),this}}),t=e.prototype;e.VISIBILITY=1,e.DISPLAY=2,e.OFFSETS=3,e.addMethods=function(e){ExtTouch.apply(t,e)},t.on=t.addListener,t.un=t.removeListener,t.update=t.setHTML,e.get=function(n){var r,i,s;if(!n)return null;if(typeof n=="string")return(i=document.getElementById(n))?(ExtTouch.cache[n]&&ExtTouch.cache[n].el?(r=ExtTouch.cache[n].el,r.dom=i):r=e.addToCache(new e(i)),r):null;if(n.tagName)return(s=n.id)||(s=ExtTouch.id(n)),ExtTouch.cache[s]&&ExtTouch.cache[s].el?(r=ExtTouch.cache[s].el,r.dom=n):r=e.addToCache(new e(n)),r;if(n instanceof e)return n!=e.docEl&&(n.dom=document.getElementById(n.id)||n.dom),n;if(n.isComposite)return n;if(ExtTouch.isArray(n))return e.select(n);if(n==document){if(!e.docEl){var o=function(){};o.prototype=t,e.docEl=new o,e.docEl.dom=document,e.docEl.id=ExtTouch.id(document)}return e.docEl}return null},e.addToCache=function(e,t){return t=t||e.id,ExtTouch.cache[t]={el:e,data:{},events:{}},e},e.data=function(t,n,r){t=e.get(t);if(!t)return null;var i=ExtTouch.cache[t.id].data;return arguments.length==2?i[n]:i[n]=r},e.garbageCollect=function(){if(!ExtTouch.enableGarbageCollector)clearInterval(e.collectorThreadId);else{var t,n,r=ExtTouch.cache;for(t in r){if(!r.hasOwnProperty(t))continue;if(r[t].skipGarbageCollection)continue;n=r[t].el.dom;if(!n||!n.parentNode||!n.offsetParent&&!document.getElementById(t))ExtTouch.enableListenerCollection&&ExtTouch.EventManager.removeAll(n),delete r[t]}}},e.Flyweight=function(e){this.dom=e};var n=function(){};n.prototype=t,e.Flyweight.prototype=new n,e.Flyweight.prototype.isFlyweight=!0,e._flyweights={},e.fly=function(t,n){var r=null;return n=n||"_global",t=ExtTouch.getDom(t),t&&((e._flyweights[n]=e._flyweights[n]||new e.Flyweight).dom=t,r=e._flyweights[n]),r},ExtTouch.get=e.get,ExtTouch.fly=e.fly}(),function(){ExtTouch.Element.classReCache={};var e=ExtTouch.Element,t=document.defaultView;e.addMethods({marginRightRe:/marginRight/i,trimRe:/^\s+|\s+$/g,spacesRe:/\s+/,getStyle:function(e){}})}(),ExtTouch.is={init:function(e){var t=this,n=t.platforms,r=n.length,i,s;e=e||window.navigator;for(i=0;i<r;i++)s=n[i],t[s.identity]=s.regex.test(e[s.property]);t.Desktop=t.Mac||t.Windows||t.Linux&&!t.Android,t.iOS=t.iPhone||t.iPad||t.iPod,t.Standalone=!!e.standalone,i=t.Android&&/Android\s(\d+\.\d+)/.exec(e.userAgent),i&&(t.AndroidVersion=i[1],t.AndroidMajorVersion=parseInt(i[1],10)),t.Tablet=t.iPad||t.Android&&t.AndroidMajorVersion===3,t.Phone=!t.Desktop&&!t.Tablet,t.MultiTouch=!t.Blackberry&&!t.Desktop&&!(t.Android&&t.AndroidVersion<3)},platforms:[{property:"platform",regex:/iPhone/i,identity:"iPhone"},{property:"platform",regex:/iPod/i,identity:"iPod"},{property:"userAgent",regex:/iPad/i,identity:"iPad"},{property:"userAgent",regex:/Blackberry/i,identity:"Blackberry"},{property:"userAgent",regex:/Android/i,identity:"Android"},{property:"platform",regex:/Mac/i,identity:"Mac"},{property:"platform",regex:/Win/i,identity:"Windows"},{property:"platform",regex:/Linux/i,identity:"Linux"}]},ExtTouch.is.init(),ExtTouch.supports={init:function(){var e=document,t=e.createElement("div"),n=this.tests,r=n.length,i,s;t.innerHTML=['<div style="height:30px;width:50px;">','<div style="height:20px;width:20px;"></div>',"</div>",'<div style="float:left; background-color:transparent;"></div>'].join(""),e.body.appendChild(t);for(i=0;i<r;i++)s=n[i],this[s.identity]=s.fn.call(this,e,t);e.body.removeChild(t)},OrientationChange:typeof window.orientation!="undefined"&&"onorientationchange"in window,DeviceMotion:"ondevicemotion"in window,Touch:"ontouchstart"in window&&!ExtTouch.is.Desktop,tests:[{identity:"Transitions",fn:function(e,t){var n=["webkit","Moz","o","ms","khtml"],r="TransitionEnd",i=[n[0]+r,"transitionend",n[2]+r,n[3]+r,n[4]+r],s=n.length,o=0,u=!1;t=ExtTouch.get(t);for(;o<s;o++)if(t.getStyle(n[o]+"TransitionProperty")){ExtTouch.supports.CSS3Prefix=n[o],ExtTouch.supports.CSS3TransitionEnd=i[o],u=!0;break}return u}},{identity:"RightMargin",fn:function(e,t,n){return n=e.defaultView,!n||n.getComputedStyle(t.firstChild.firstChild,null).marginRight=="0px"}},{identity:"TransparentColor",fn:function(e,t,n){return n=e.defaultView,!n||n.getComputedStyle(t.lastChild,null).backgroundColor=="transparent"}},{identity:"SVG",fn:function(e){return!!e.createElementNS&&!!e.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect}},{identity:"Canvas",fn:function(e){return!!e.createElement("canvas").getContExtTouch}},{identity:"VML",fn:function(e){var t=e.createElement("div");return t.innerHTML="<!--[if vml]><br><br><![endif]-->",t.childNodes.length==2}},{identity:"Float",fn:function(e,t){return!!t.lastChild.style.cssFloat}},{identity:"AudioTag",fn:function(e){return!!e.createElement("audio").canPlayType}},{identity:"History",fn:function(){return!!window.history&&!!history.pushState}},{identity:"CSS3DTransform",fn:function(){return typeof WebKitCSSMatrix!="undefined"&&(new WebKitCSSMatrix).hasOwnProperty("m41")}},{identity:"CSS3LinearGradient",fn:function(e,t){var n="background-image:",r="-webkit-gradient(linear, left top, right bottom, from(black), to(white))",i="linear-gradient(left top, black, white)",s="-moz-"+i,o=[n+r,n+i,n+s];return t.style.cssTExtTouch=o.join(";"),(""+t.style.backgroundImage).indexOf("gradient")!==-1}},{identity:"CSS3BorderRadius",fn:function(e,t){var n=["borderRadius","BorderRadius","MozBorderRadius","WebkitBorderRadius","OBorderRadius","KhtmlBorderRadius"],r=!1,i;for(i=0;i<n.length;i++)if(document.body.style[n[i]]!==undefined)return r=!0;return r}},{identity:"GeoLocation",fn:function(){return typeof navigator!="undefined"&&typeof navigator.geolocation!="undefined"||typeof google!="undefined"&&typeof google.gears!="undefined"}}]},ExtTouch.apply(ExtTouch,{version:"1.1.1",versionDetail:{major:1,minor:1,patch:1},setup:function(e){if(e&&typeof e=="object"){e.addMetaTags!==!1&&this.addMetaTags(e);if(ExtTouch.isFunction(e.onReady)){var t=this;ExtTouch.onReady(function(){var n=arguments;e.fullscreen!==!1?ExtTouch.Viewport.init(function(){e.onReady.apply(t,n)}):e.onReady.apply(this,n)},e.scope)}}},getDom:function(e){return!e||!document?null:e.dom?e.dom:typeof e=="string"?document.getElementById(e):e},removeNode:function(e){e&&e.parentNode&&e.tagName!="BODY"&&(ExtTouch.EventManager.removeAll(e),e.parentNode.removeChild(e),delete ExtTouch.cache[e.id])},addMetaTags:function(e){if(!ExtTouch.isObject(e))return;var t=ExtTouch.get(document.getElementsByTagName("head")[0]),n,r;ExtTouch.is.Desktop||(n=ExtTouch.get(document.createElement("meta")),n.set({name:"viewport",content:"width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0;"}),t.appendChild(n)),ExtTouch.is.iOS&&(e.fullscreen!==!1&&(n=ExtTouch.get(document.createElement("meta")),n.set({name:"apple-mobile-web-app-capable",content:"yes"}),t.appendChild(n),ExtTouch.isString(e.statusBarStyle)&&(n=ExtTouch.get(document.createElement("meta")),n.set({name:"apple-mobile-web-app-status-bar-style",content:e.statusBarStyle}),t.appendChild(n))),e.tabletStartupScreen&&ExtTouch.is.iPad&&(n=ExtTouch.get(document.createElement("link")),n.set({rel:"apple-touch-startup-image",href:e.tabletStartupScreen}),t.appendChild(n)),e.phoneStartupScreen&&!ExtTouch.is.iPad&&(n=ExtTouch.get(document.createElement("link")),n.set({rel:"apple-touch-startup-image",href:e.phoneStartupScreen}),t.appendChild(n)),e.icon&&(e.phoneIcon=e.tabletIcon=e.icon),r=e.glossOnIcon===!1?"-precomposed":"",ExtTouch.is.iPad&&ExtTouch.isString(e.tabletIcon)?(n=ExtTouch.get(document.createElement("link")),n.set({rel:"apple-touch-icon"+r,href:e.tabletIcon}),t.appendChild(n)):!ExtTouch.is.iPad&&ExtTouch.isString(e.phoneIcon)&&(n=ExtTouch.get(document.createElement("link")),n.set({rel:"apple-touch-icon"+r,href:e.phoneIcon}),t.appendChild(n)))}}),function(){var e=function(){var e=ExtTouch.getBody(),t=[];if(!e)return!1;var n=ExtTouch.is;return n.Phone?t.push("x-phone"):n.Tablet?t.push("x-tablet"):n.Desktop&&t.push("x-desktop"),n.iPad&&t.push("x-ipad"),n.iOS&&t.push("x-ios"),n.Android&&t.push("x-android","x-android-"+n.AndroidMajorVersion),n.Blackberry&&t.push("x-bb"),n.Standalone&&t.push("x-standalone"),t.length&&e.addCls(t),!0};e()||ExtTouch.onReady(e)}(),ExtTouch.util.Observable=ExtTouch.ExtTouchend(Object,{isObservable:!0,constructor:function(e){var t=this;ExtTouch.apply(t,e),t.listeners&&(t.on(t.listeners),delete t.listeners),t.events=t.events||{},this.bubbleEvents&&this.enableBubble(this.bubbleEvents)},eventOptionsRe:/^(?:scope|delay|buffer|single|stopEvent|preventDefault|stopPropagation|normalized|args|delegate|element|vertical|horizontal)$/,addManagedListener:function(e,t,n,r,i){var s=this,o=s.managedListeners=s.managedListeners||[],u;if(ExtTouch.isObject(t)){i=t;for(t in i){if(!i.hasOwnProperty(t))continue;u=i[t],s.eventOptionsRe.test(t)||s.addManagedListener(e,t,u.fn||u,u.scope||i.scope,u.fn?u:i)}}else o.push({item:e,ename:t,fn:n,scope:r,options:i}),e.on(t,n,r,i)},removeManagedListener:function(e,t,n,r){var i=this,s,o,u,a,f,l;if(ExtTouch.isObject(t)){s=t;for(t in s){if(!s.hasOwnProperty(t))continue;o=s[t],i.eventOptionsRe.test(t)||i.removeManagedListener(e,t,o.fn||o,o.scope||s.scope)}}u=this.managedListeners?this.managedListeners.slice():[],f=u.length;for(l=0;l<f;l++)a=u[l],a.item===e&&a.ename===t&&(!n||a.fn===n)&&(!r||a.scope===r)&&(this.managedListeners.remove(a),e.un(a.ename,a.fn,a.scope))},fireEvent:function(){var e=this,t=ExtTouch.toArray(arguments),n=t[0].toLowerCase(),r=!0,i=e.events[n],s=e.eventQueue,o;if(e.eventsSuspended===!0)return s&&s.push(t),!1;if(i&&ExtTouch.isObject(i)&&i.bubble){if(i.fire.apply(i,t.slice(1))===!1)return!1;o=e.getBubbleTarget&&e.getBubbleTarget();if(o&&o.isObservable)return(!o.events[n]||!ExtTouch.isObject(o.events[n])||!o.events[n].bubble)&&o.enableBubble(n),o.fireEvent.apply(o,t)}else i&&ExtTouch.isObject(i)&&(t.shift(),r=i.fire.apply(i,t));return r},addListener:function(e,t,n,r){var i=this,s,o;if(ExtTouch.isObject(e)){r=e;for(e in r){if(!r.hasOwnProperty(e))continue;s=r[e],i.eventOptionsRe.test(e)||i.addListener(e,s.fn||s,s.scope||r.scope,s.fn?s:r)}}else e=e.toLowerCase(),i.events[e]=i.events[e]||!0,o=i.events[e]||!0,ExtTouch.isBoolean(o)&&(i.events[e]=o=new ExtTouch.util.Event(i,e)),o.addListener(t,n,ExtTouch.isObject(r)?r:{})},removeListener:function(e,t,n){var r=this,i,s;if(ExtTouch.isObject(e)){var o=e;for(e in o){if(!o.hasOwnProperty(e))continue;i=o[e],r.eventOptionsRe.test(e)||r.removeListener(e,i.fn||i,i.scope||o.scope)}}else e=e.toLowerCase(),s=r.events[e],s.isEvent&&s.removeListener(t,n)},clearListeners:function(){var e=this.events,t,n;for(n in e){if(!e.hasOwnProperty(n))continue;t=e[n],t.isEvent&&t.clearListeners()}this.clearManagedListeners()},purgeListeners:function(){return console.warn("MixedCollection: purgeListeners has been deprecated. Please use clearListeners."),this.clearListeners.apply(this,arguments)},clearManagedListeners:function(){var e=this.managedListeners||[],t=e.length,n,r;for(n=0;n<t;n++)r=e[n],r.item.un(r.ename,r.fn,r.scope);this.managedListener=[]},purgeManagedListeners:function(){return console.warn("MixedCollection: purgeManagedListeners has been deprecated. Please use clearManagedListeners."),this.clearManagedListeners.apply(this,arguments)},addEvents:function(e){var t=this;t.events=t.events||{};if(ExtTouch.isString(e)){var n=arguments,r=n.length;while(r--)t.events[n[r]]=t.events[n[r]]||!0}else ExtTouch.applyIf(t.events,e)},hasListener:function(e){var t=this.events[e];return t.isEvent===!0&&t.listeners.length>0},suspendEvents:function(e){this.eventsSuspended=!0,e&&!this.eventQueue&&(this.eventQueue=[])},resumeEvents:function(){var e=this,t=e.eventQueue||[];e.eventsSuspended=!1,delete e.eventQueue,ExtTouch.each(t,function(t){e.fireEvent.apply(e,t)})},relayEvents:function(e,t,n){function u(e){return function(){return r.fireEvent.apply(r,[n+e].concat(Array.prototype.slice.call(arguments,0,-1)))}}n=n||"";var r=this,i=t.length,s,o;for(s=0,i=t.length;s<i;s++)o=t[s].substr(n.length),r.events[o]=r.events[o]||!0,e.on(o,u(o),r)},enableBubble:function(e){var t=this;ExtTouch.isEmpty(e)||(e=ExtTouch.isArray(e)?e:ExtTouch.toArray(arguments),ExtTouch.each(e,function(e){e=e.toLowerCase();var n=t.events[e]||!0;ExtTouch.isBoolean(n)&&(n=new ExtTouch.util.Event(t,e),t.events[e]=n),n.bubble=!0}))}}),ExtTouch.override(ExtTouch.util.Observable,{on:ExtTouch.util.Observable.prototype.addListener,un:ExtTouch.util.Observable.prototype.removeListener,mon:ExtTouch.util.Observable.prototype.addManagedListener,mun:ExtTouch.util.Observable.prototype.removeManagedListener}),ExtTouch.util.Observable.releaseCapture=function(e){e.fireEvent=ExtTouch.util.Observable.prototype.fireEvent},ExtTouch.util.Observable.capture=function(e,t,n){e.fireEvent=ExtTouch.createInterceptor(e.fireEvent,t,n)},ExtTouch.util.Observable.observe=function(e,t){if(e)return e.isObservable||(ExtTouch.applyIf(e,new ExtTouch.util.Observable),ExtTouch.util.Observable.capture(e.prototype,e.fireEvent,e)),typeof t=="object"&&e.on(t),e},ExtTouch.util.Observable.observeClass=ExtTouch.util.Observable.observe,ExtTouch.util.Event=ExtTouch.ExtTouchend(Object,function(){function e(e,t,n,r){return t.task=new ExtTouch.util.DelayedTask,function(){t.task.delay(n.buffer,e,r,ExtTouch.toArray(arguments))}}function t(e,t,n,r){return function(){var i=new ExtTouch.util.DelayedTask;t.tasks||(t.tasks=[]),t.tasks.push(i),i.delay(n.delay||10,e,r,ExtTouch.toArray(arguments))}}function n(e,t,n,r){return function(){return t.ev.removeListener(t.fn,r),e.apply(r,arguments)}}return{isEvent:!0,constructor:function(e,t){this.name=t,this.observable=e,this.listeners=[]},addListener:function(e,t,n){var r=this,i;t=t||r.observable,r.isListening(e,t)||(i=r.createListener(e,t,n),r.firing&&(r.listeners=r.listeners.slice(0)),r.listeners.push(i))},createListener:function(r,i,s){s=s||{},i=i||this.observable;var o={fn:r,scope:i,o:s,ev:this},u=r;return s.delay&&(u=t(u,o,s,i)),s.buffer&&(u=e(u,o,s,i)),s.single&&(u=n(u,o,s,i)),o.fireFn=u,o},findListener:function(e,t){var n=this.listeners,r=n.length,i,s;while(r--){i=n[r];if(i){s=i.scope;if(i.fn==e&&(s==t||s==this.observable))return r}}return-1},isListening:function(e,t){return this.findListener(e,t)!==-1},removeListener:function(e,t){var n=this,r,i,s;r=n.findListener(e,t);if(r!=-1){i=n.listeners[r],n.firing&&(n.listeners=n.listeners.slice(0)),i.task&&(i.task.cancel(),delete i.task),s=i.tasks&&i.tasks.length;if(s){while(s--)i.tasks[s].cancel();delete i.tasks}return n.listeners.splice(r,1),!0}return!1},clearListeners:function(){var e=this.listeners,t=e.length;while(t--)this.removeListener(e[t].fn,e[t].scope)},fire:function(){var e=this,t=e.listeners,n=t.length,r,i,s;if(n>0){e.firing=!0;for(r=0;r<n;r++){s=t[r],i=arguments.length?Array.prototype.slice.call(arguments,0):[],s.o&&i.push(s.o);if(s&&s.fireFn.apply(s.scope||e.observable,i)===!1)return e.firing=!1}}return e.firing=!1,!0}}}()),ExtTouch.util.HashMap=ExtTouch.ExtTouchend(ExtTouch.util.Observable,{constructor:function(e){this.addEvents("add","clear","remove","replace"),ExtTouch.util.HashMap.superclass.constructor.call(this,e),this.clear(!0)},getCount:function(){return this.length},getData:function(e,t){return t===undefined&&(t=e,e=this.getKey(t)),[e,t]},getKey:function(e){return e.id},add:function(e,t){var n=this,r;if(n.containsKey(e))throw new Error("This key already exists in the HashMap");return r=this.getData(e,t),e=r[0],t=r[1],n.map[e]=t,++n.length,n.fireEvent("add",n,e,t),t},replace:function(e,t){var n=this,r=n.map,i;return n.containsKey(e)||n.add(e,t),i=r[e],r[e]=t,n.fireEvent("replace",n,e,t,i),t},remove:function(e){var t=this.findKey(e);return t!==undefined?this.removeByKey(t):!1},removeByKey:function(e){var t=this,n;return t.containsKey(e)?(n=t.map[e],delete t.map[e],--t.length,t.fireEvent("remove",t,e,n),!0):!1},get:function(e){return this.map[e]},clear:function(e){var t=this;return t.map={},t.length=0,e!==!0&&t.fireEvent("clear",t),t},containsKey:function(e){return this.map[e]!==undefined},contains:function(e){return this.containsKey(this.findKey(e))},getKeys:function(){return this.getArray(!0)},getValues:function(){return this.getArray(!1)},getArray:function(e){var t=[],n,r=this.map;for(n in r)r.hasOwnProperty(n)&&t.push(e?n:r[n]);return t},each:function(e,t){var n=ExtTouch.apply({},this.map),r,i=this.length;t=t||this;for(r in n)if(n.hasOwnProperty(r)&&e.call(t,r,n[r],i)===!1)break;return this},clone:function(){var e=new ExtTouch.util.HashMap,t=this.map,n;e.suspendEvents();for(n in t)t.hasOwnProperty(n)&&e.add(n,t[n]);return e.resumeEvents(),e},findKey:function(e){var t,n=this.map;for(t in n)if(n.hasOwnProperty(t)&&n[t]===e)return t;return undefined}}),ExtTouch.util.Functions={createInterceptor:function(e,t,n,r){var i=e;return ExtTouch.isFunction(t)?function(){var i=this,s=arguments;return t.target=i,t.method=e,t.apply(n||i||window,s)!==!1?e.apply(i||window,s):r||null}:e},createDelegate:function(e,t,n,r){return ExtTouch.isFunction(e)?function(){var i=n||arguments;if(r===!0)i=Array.prototype.slice.call(arguments,0),i=i.concat(n);else if(ExtTouch.isNumber(r)){i=Array.prototype.slice.call(arguments,0);var s=[r,0].concat(n);Array.prototype.splice.apply(i,s)}return e.apply(t||window,i)}:e},defer:function(e,t,n,r,i){return e=ExtTouch.util.Functions.createDelegate(e,n,r,i),t>0?setTimeout(e,t):(e(),0)},createSequence:function(e,t,n){return ExtTouch.isFunction(t)?function(){var r=e.apply(this||window,arguments);return t.apply(n||this||window,arguments),r}:e}},ExtTouch.defer=ExtTouch.util.Functions.defer,ExtTouch.createInterceptor=ExtTouch.util.Functions.createInterceptor,ExtTouch.createSequence=ExtTouch.util.Functions.createSequence,ExtTouch.createDelegate=ExtTouch.util.Functions.createDelegate,ExtTouch.util.Point=ExtTouch.ExtTouchend(Object,{constructor:function(e,t){return this.x=e!=null&&!isNaN(e)?e:0,this.y=t!=null&&!isNaN(t)?t:0,this},copy:function(){return new ExtTouch.util.Point(this.x,this.y)},copyFrom:function(e){return this.x=e.x,this.y=e.y,this},toString:function(){return"Point["+this.x+","+this.y+"]"},equals:function(e){return this.x==e.x&&this.y==e.y},isWithin:function(e,t){return ExtTouch.isObject(t)||(t={x:t},t.y=t.x),this.x<=e.x+t.x&&this.x>=e.x-t.x&&this.y<=e.y+t.y&&this.y>=e.y-t.y},translate:function(e,t){e!=null&&!isNaN(e)&&(this.x+=e),t!=null&&!isNaN(t)&&(this.y+=t)},roundedEquals:function(e){return Math.round(this.x)==Math.round(e.x)&&Math.round(this.y)==Math.round(e.y)}}),ExtTouch.util.Point.fromEvent=function(e){var t=e.changedTouches&&e.changedTouches.length>0?e.changedTouches[0]:e;return new ExtTouch.util.Point(t.pageX,t.pageY)},ExtTouch.AbstractManager=ExtTouch.ExtTouchend(Object,{typeName:"type",constructor:function(e){ExtTouch.apply(this,e||{}),this.all=new ExtTouch.util.HashMap,this.types={}},get:function(e){return this.all.get(e)},register:function(e){this.all.add(e)},unregister:function(e){this.all.remove(e)},registerType:function(e,t){this.types[e]=t,t[this.typeName]=e},isRegistered:function(e){return this.types[e]!==undefined},create:function(e,t){var n=e[this.typeName]||e.type||t,r=this.types[n];if(r==undefined)throw new Error(ExtTouch.util.Format.format("The '{0}' type has not been registered with this manager",n));return new r(e)},onAvailable:function(e,t,n){var r=this.all;r.on("add",function(i,s){s.id==e&&(t.call(n||s,s),r.un("add",t,n))})},each:function(e,t){this.all.each(e,t||this)},getCount:function(){return this.all.getCount()}}),ExtTouch.gesture.Manager=new ExtTouch.AbstractManager({eventNames:{start:"touchstart",move:"touchmove",end:"touchend"},clickMoveThreshold:5,init:function(){this.targets=[],this.followTouches=[],this.currentGestures=[],this.currentTargets=[],this.listenerWrappers={start:ExtTouch.createDelegate(this.onTouchStart,this),move:ExtTouch.createDelegate(this.onTouchMove,this),end:ExtTouch.createDelegate(this.onTouchEnd,this)},this.attachListeners()},freeze:function(){this.isFrozen=!0},thaw:function(){this.isFrozen=!1},getEventSimulator:function(){return this.eventSimulator||(this.eventSimulator=new ExtTouch.util.EventSimulator),this.eventSimulator},attachListeners:function(){ExtTouch.iterate(this.eventNames,function(e,t){document.addEventListener(t,this.listenerWrappers[e],!1)},this)},detachListeners:function(){ExtTouch.iterate(this.eventNames,function(e,t){document.removeEventListener(t,this.listenerWrappers[e],!1)},this)},onTouchStart:function(e){var t=[],n=e.target;if(e.stopped===!0)return;ExtTouch.is.Android&&(!n.tagName||["input","tExtToucharea","select"].indexOf(n.tagName.toLowerCase())===-1)&&e.preventDefault();if(this.isFrozen)return;this.startEvent&&this.onTouchEnd(e),this.locks={},this.currentTargets=[n];while(n)this.targets.indexOf(n)!==-1&&t.unshift(n),n=n.parentNode,this.currentTargets.push(n);this.startEvent=e,this.startPoint=ExtTouch.util.Point.fromEvent(e),this.lastMovePoint=null,this.isClick=!0,this.handleTargets(t,e)},onTouchMove:function(e){ExtTouch.is.MultiTouch&&e.preventDefault();if(!this.startEvent)return;ExtTouch.is.Desktop&&(e.target=this.startEvent.target);if(this.isFrozen)return;var t=this.currentGestures,n,r=e.changedTouches?e.changedTouches[0]:e;this.lastMovePoint=ExtTouch.util.Point.fromEvent(e),ExtTouch.supports.Touch&&this.isClick&&!this.lastMovePoint.isWithin(this.startPoint,this.clickMoveThreshold)&&(this.isClick=!1);for(var i=0;i<t.length;i++){if(e.stopped)break;n=t[i],n.listenForMove&&n.onTouchMove(e,r)}},onTouchEnd:function(e){ExtTouch.is.Blackberry&&e.preventDefault();if(this.isFrozen)return;var t=this.currentGestures.slice(0),n=t.length,r,i,s,o=!1,u=e.changedTouches?e.changedTouches[0]:e;this.startPoint&&(s=ExtTouch.util.Point.fromEvent(e),(this.lastMovePoint||this.startPoint).equals(s)||(o=!0));for(r=0;r<n;r++)i=t[r],!e.stopped&&i.listenForEnd&&(o&&i.onTouchMove(e,u),i.onTouchEnd(e,u)),this.stopGesture(i);ExtTouch.supports.Touch&&this.isClick&&(this.isClick=!1),this.lastMovePoint=null,this.followTouches=[],this.startedChangedTouch=!1,this.currentTargets=[],this.startEvent=null,this.startPoint=null},handleTargets:function(e,t){var n=e.length,r;this.startedChangedTouch=!1,this.startedTouches=ExtTouch.supports.Touch?t.touches:[t];for(r=0;r<n;r++){if(t.stopped)break;this.handleTarget(e[r],t,!0)}for(r=n-1;r>=0;r--){if(t.stopped)break;this.handleTarget(e[r],t,!1)}this.startedChangedTouch&&(this.followTouches=this.followTouches.concat(ExtTouch.supports.Touch&&t.targetTouches?ExtTouch.toArray(t.targetTouches):[t]))},handleTarget:function(e,t,n){var r=ExtTouch.Element.data(e,"x-gestures")||[],i=r.length,s,o;for(s=0;s<i;s++){o=r[s];if(!!o.capture==!!n&&this.followTouches.length<o.touches&&(ExtTouch.supports.Touch&&t.targetTouches?t.targetTouches.length===o.touches:!0)){this.startedChangedTouch=!0,this.startGesture(o),o.listenForStart&&o.onTouchStart(t,t.changedTouches?t.changedTouches[0]:t);if(t.stopped)break}}},startGesture:function(e){e.started=!0,this.currentGestures.push(e)},stopGesture:function(e){e.started=!1,this.currentGestures.remove(e)},addEventListener:function(e,t,n,r){e=ExtTouch.getDom(e),r=r||{};var i=this.targets,s=this.getGestureName(t),o=ExtTouch.Element.data(e,"x-gestures"),u;o||(o=[],ExtTouch.Element.data(e,"x-gestures",o));if(!s)throw new Error("Trying to subscribe to unknown event "+t);i.indexOf(e)===-1&&this.targets.push(e),u=this.get(e.id+"-"+s),u||(u=this.create(ExtTouch.apply({},r,{target:e,type:s})),o.push(u)),u.addListener(t,n),this.startedChangedTouch&&this.currentTargets.contains(e)&&!u.started&&!r.subsequent&&(this.startGesture(u),u.listenForStart&&u.onTouchStart(this.startEvent,this.startedTouches[0]))},removeEventListener:function(e,t,n){e=ExtTouch.getDom(e);var r=this.getGestureName(t),i=ExtTouch.Element.data(e,"x-gestures")||[],s;s=this.get(e.id+"-"+r);if(s){s.removeListener(t,n);for(r in s.listeners)return;s.destroy(),i.remove(s),ExtTouch.Element.data(e,"x-gestures",i)}},getGestureName:function(e){return this.names&&this.names[e]},registerType:function(e,t){var n=t.prototype.handles,r,i;this.types[e]=t,t[this.typeName]=e,n||(n=t.prototype.handles=[e]),this.names=this.names||{};for(r=0,i=n.length;r<i;r++)this.names[n[r]]=e}}),ExtTouch.regGesture=function(){return ExtTouch.gesture.Manager.registerType.apply(ExtTouch.gesture.Manager,arguments)},ExtTouch.TouchEventObjectImpl=ExtTouch.ExtTouchend(Object,{constructor:function(e,t){e&&this.setEvent(e,t)},setEvent:function(e,t){return ExtTouch.apply(this,{event:e,time:e.timeStamp}),this.touches=e.touches||[e],this.changedTouches=e.changedTouches||[e],this.targetTouches=e.targetTouches||[e],t?(this.target=t.target,ExtTouch.apply(this,t)):this.target=e.target,this},stopEvent:function(){this.stopPropagation(),this.preventDefault()},stopPropagation:function(){this.event.stopped=!0},preventDefault:function(){this.event.preventDefault()},getTarget:function(e,t,n){return e?ExtTouch.fly(this.target).findParent(e,t,n):n?ExtTouch.get(this.target):this.target}}),ExtTouch.TouchEventObject=new ExtTouch.TouchEventObjectImpl,ExtTouch.gesture.Gesture=ExtTouch.ExtTouchend(Object,{listenForStart:!0,listenForEnd:!0,listenForMove:!0,disableLocking:!1,touches:1,constructor:function(e){e=e||{},ExtTouch.apply(this,e),this.target=ExtTouch.getDom(this.target),this.listeners={};if(!this.target)throw new Error("Trying to bind a "+this.type+" event to element that does'nt exist: "+this.target);this.id=this.target.id+"-"+this.type,ExtTouch.gesture.Gesture.superclass.constructor.call(this),ExtTouch.gesture.Manager.register(this)},addListener:function(e,t){this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(t)},removeListener:function(e,t){var n=this.listeners[e];if(n){n.remove(t),n.length==0&&delete this.listeners[e];for(e in this.listeners)if(this.listeners.hasOwnProperty(e))return;this.listeners={}}},fire:function(e,t,n){var r=this.listeners&&this.listeners[e],i=r&&r.length,s;if(!this.disableLocking&&this.isLocked(e))return!1;if(i){n=ExtTouch.apply(n||{},{time:t.timeStamp,type:e,gesture:this,target:t.target.nodeType==3?t.target.parentNode:t.target});for(s=0;s<i;s++)r[s](t,n)}return!0},stop:function(){ExtTouch.gesture.Manager.stopGesture(this)},lock:function(){if(!this.disableLocking){var e=arguments,t=e.length,n;for(n=0;n<t;n++)ExtTouch.gesture.Manager.locks[e[n]]=this.id}},unlock:function(){if(!this.disableLocking){var e=arguments,t=e.length,n;for(n=0;n<t;n++)ExtTouch.gesture.Manager.locks[e[n]]==this.id&&delete ExtTouch.gesture.Manager.locks[e[n]]}},isLocked:function(e){var t=ExtTouch.gesture.Manager.locks[e];return!!t&&t!==this.id},getLockingGesture:function(e){var t=ExtTouch.gesture.Manager.locks[e];return t?ExtTouch.gesture.Manager.get(t)||null:null},onTouchStart:ExtTouch.emptyFn,onTouchMove:ExtTouch.emptyFn,onTouchEnd:ExtTouch.emptyFn,destroy:function(){this.stop(),this.listeners=null,ExtTouch.gesture.Manager.unregister(this)}}),ExtTouch.gesture.Touch=ExtTouch.ExtTouchend(ExtTouch.gesture.Gesture,{handles:["touchstart","touchmove","touchend","touchdown"],touchDownInterval:500,onTouchStart:function(e,t){this.startX=this.previousX=t.pageX,this.startY=this.previousY=t.pageY,this.startTime=this.previousTime=e.timeStamp,this.fire("touchstart",e),this.lastEvent=e,this.listeners&&this.listeners.touchdown&&(this.touchDownIntervalId=setInterval(ExtTouch.createDelegate(this.touchDownHandler,this),this.touchDownInterval))},onTouchMove:function(e,t){this.fire("touchmove",e,this.getInfo(t)),this.lastEvent=e},onTouchEnd:function(e){this.fire("touchend",e,this.lastInfo),clearInterval(this.touchDownIntervalId)},touchDownHandler:function(){this.fire("touchdown",this.lastEvent,this.lastInfo)},getInfo:function(e){var t=Date.now(),n=e.pageX-this.startX,r=e.pageY-this.startY,i={startX:this.startX,startY:this.startY,previousX:this.previousX,previousY:this.previousY,pageX:e.pageX,pageY:e.pageY,deltaX:n,deltaY:r,absDeltaX:Math.abs(n),absDeltaY:Math.abs(r),previousDeltaX:e.pageX-this.previousX,previousDeltaY:e.pageY-this.previousY,time:t,startTime:this.startTime,previousTime:this.previousTime,deltaTime:t-this.startTime,previousDeltaTime:t-this.previousTime};return this.previousTime=i.time,this.previousX=i.pageX,this.previousY=i.pageY,this.lastInfo=i,i}}),ExtTouch.regGesture("touch",ExtTouch.gesture.Touch),ExtTouch.gesture.Swipe=ExtTouch.ExtTouchend(ExtTouch.gesture.Gesture,{listenForEnd:!1,swipeThreshold:35,swipeTime:1e3,onTouchStart:function(e,t){this.startTime=e.timeStamp,this.startX=t.pageX,this.startY=t.pageY,this.lock("scroll","scrollstart","scrollend")},onTouchMove:function(e,t){var n=t.pageY-this.startY,r=t.pageX-this.startX,i=Math.abs(n),s=Math.abs(r),o=e.timeStamp-this.startTime;i-s>3||o>this.swipeTime?(this.unlock("drag","dragstart","dragend"),this.stop()):s>this.swipeThreshold&&s>i&&(this.fire("swipe",e,{direction:r<0?"left":"right",distance:s,deltaTime:o,deltaX:r}),this.stop())}}),ExtTouch.regGesture("swipe",ExtTouch.gesture.Swipe),ExtTouch.gesture.Tap=ExtTouch.ExtTouchend(ExtTouch.gesture.Gesture,{handles:["tapstart","tapcancel","tap","doubletap","taphold","singletap"],cancelThreshold:10,doubleTapThreshold:800,singleTapThreshold:400,holdThreshold:1e3,fireClickEvent:!1,onTouchStart:function(e,t){var n=this;n.startX=t.pageX,n.startY=t.pageY,n.fire("tapstart",e,n.getInfo(t)),this.listeners.taphold&&(n.timeout=setTimeout(function(){n.fire("taphold",e,n.getInfo(t)),delete n.timeout},n.holdThreshold)),n.lastTouch=t},onTouchMove:function(e,t){var n=this;n.isCancel(t)&&(n.fire("tapcancel",e,n.getInfo(t)),n.timeout&&(clearTimeout(n.timeout),delete n.timeout),n.stop()),n.lastTouch=t},onTouchEnd:function(e){var t=this,n=t.getInfo(t.lastTouch);this.fireTapEvent(e,n),t.lastTapTime&&e.timeStamp-t.lastTapTime<=t.doubleTapThreshold?(t.lastTapTime=null,e.preventDefault(),t.fire("doubletap",e,n)):t.lastTapTime=e.timeStamp,t.listeners&&t.listeners.singletap&&t.singleTapThreshold&&!t.preventSingleTap&&(t.fire("singletap",e,n),t.preventSingleTap=!0,setTimeout(function(){t.preventSingleTap=!1},t.singleTapThreshold)),t.timeout&&(clearTimeout(t.timeout),delete t.timeout)},fireTapEvent:function(e,t){this.fire("tap",e,t),e.event&&(e=e.event);var n=(e.changedTouches?e.changedTouches[0]:e).target;if(!n.disabled&&this.fireClickEvent){var r=document.createEvent("MouseEvent");r.initMouseEvent("click",e.bubbles,e.cancelable,document.defaultView,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.metaKey,e.button,e.relatedTarget),r.isSimulated=!0,n.dispatchEvent(r)}},getInfo:function(e){var t=e.pageX,n=e.pageY;return{pageX:t,pageY:n,startX:t,startY:n}},isCancel:function(e){var t=this;return Math.abs(e.pageX-t.startX)>=t.cancelThreshold||Math.abs(e.pageY-t.startY)>=t.cancelThreshold}}),ExtTouch.regGesture("tap",ExtTouch.gesture.Tap),ExtTouch.gesture.Pinch=ExtTouch.ExtTouchend(ExtTouch.gesture.Gesture,{handles:["pinchstart","pinch","pinchend"],touches:2,onTouchStart:function(e){var t=this;if(this.isMultiTouch(e)){t.lock("swipe","scroll","scrollstart","scrollend","touchmove","touchend","touchstart","tap","tapstart","taphold","tapcancel","doubletap"),t.pinching=!0;var n=e.targetTouches;t.startFirstTouch=n[0],t.startSecondTouch=n[1],t.previousDistance=t.startDistance=t.getDistance(t.startFirstTouch,t.startSecondTouch),t.previousScale=1,t.fire("pinchstart",e,{distance:t.startDistance,scale:t.previousScale})}else t.pinching&&(t.unlock("swipe","scroll","scrollstart","scrollend","touchmove","touchend","touchstart","tap","tapstart","taphold","tapcancel","doubletap"),t.pinching=!1)},isMultiTouch:function(e){return e&&ExtTouch.supports.Touch&&e.targetTouches&&e.targetTouches.length>1},onTouchMove:function(e){if(!this.isMultiTouch(e)){this.onTouchEnd(e);return}this.pinching&&this.fire("pinch",e,this.getPinchInfo(e))},onTouchEnd:function(e){this.pinching&&this.fire("pinchend",e)},getPinchInfo:function(e){var t=this,n=e.targetTouches,r=n[0],i=n[1],s=t.getDistance(r,i),o=s/t.startDistance,u={scale:o,deltaScale:o-1,previousScale:t.previousScale,previousDeltaScale:o-t.previousScale,distance:s,deltaDistance:s-t.startDistance,startDistance:t.startDistance,previousDistance:t.previousDistance,previousDeltaDistance:s-t.previousDistance,firstTouch:r,secondTouch:i,firstPageX:r.pageX,firstPageY:r.pageY,secondPageX:i.pageX,secondPageY:i.pageY,midPointX:(r.pageX+i.pageX)/2,midPointY:(r.pageY+i.pageY)/2};return t.previousScale=o,t.previousDistance=s,u},getDistance:function(e,t){return Math.sqrt(Math.pow(Math.abs(e.pageX-t.pageX),2)+Math.pow(Math.abs(e.pageY-t.pageY),2))}}),ExtTouch.regGesture("pinch",ExtTouch.gesture.Pinch),Ext.define("Bisque.Misc.GestureManager",{constructor:function(){if(typeof ExtTouch=="undefined")return;ExtTouch.supports.init(),ExtTouch.gesture.Manager.init()},addListener:function(e){if(typeof ExtTouch=="undefined")return;if(Ext.isArray(e)){Ext.Array.forEach(e,this.addListener,this);return}Ext.getDom(e.dom)&&ExtTouch.gesture.Manager.addEventListener(e.dom,e.eventName,e.listener,e.options)}}),Ext.Loader.setConfig({enabled:!0}),Ext.Loader.setPath("Ext.ux",bq.url("/js/Share")),Ext.require(["Ext.ux.CheckColumn"]),Ext.define("BQ.ShareDialog",{extend:"Ext.window.Window",constructor:function(e){e=e||{},e.height=e.height||"65%",e.width=e.width||"65%";var t=Ext.getBody().getViewSize(),n=parseInt(e.height.toString().indexOf("%")==-1?e.height:t.height*parseInt(e.height)/100),r=parseInt(e.width.toString().indexOf("%")==-1?e.width:t.width*parseInt(e.width)/100);this.eastPanel=Ext.create("Ext.panel.Panel",{layout:{type:"vbox",align:"stretch"},flex:4,title:"Add user",region:"east",margin:"3 3 3 0",collapsible:!0,frame:!0,split:!0}),this.centerPanel=Ext.create("Ext.panel.Panel",{region:"center",border:!1,flex:6,margin:"3 1 3 3",layout:"fit"}),Ext.apply(this,{title:"Sharing settings - "+(e.resource?e.resource.name:""),modal:!0,height:n,bodyStyle:"border:0px",width:r,layout:"border",bodyCls:"white",items:[this.centerPanel,this.eastPanel],owner:undefined,bbar:{xtype:"toolbar",style:{background:"#FFF",border:0},layout:{type:"hbox",align:"middle",pack:"center"},defaults:{cls:"x-btn-default-medium",scale:"medium",style:"border-color:#D1D1D1",width:85,margin:1,textAlign:"left",scope:this},padding:"6 6 9 6",items:[{text:"Save",iconCls:"icon-select24",handler:this.btnSave,scope:this},{text:"Cancel",iconCls:"icon-cancel24",handler:this.btnCancel}]}},e),this.callParent(arguments),this.addComponents(),this.show()},btnSave:function(){var e=!1;for(var t=0;t<this.store.getCount();t++){var n=this.store.getAt(t);n.dirty&&(e=!0,n.commit(),this.authRecord.children[t-1].action=n.get("edit")?"edit":"read")}if(e||this.userModified){var r=this.grid.getDockedItems('toolbar[dock="bottom"]')[0].getComponent("cbNotify").getValue();r||(this.authRecord.uri=Ext.urlAppend(this.authRecord.uri,"notify=false")),this.authRecord.save_(),BQ.ui.notification("Sharing settings saved!",2500)}this.close()},btnCancel:function(){this.close()},userSelected:function(e,t){var n=this.store.find("user_name",t.user_name);n==-1?this.addUser({user:t.uri,email:t.email,action:"read"}):BQ.ui.notification("Selected user already exists in the share list!")},addEmail:function(){this.addUser({email:this.txtEmail.getValue(),action:"read"}),this.clearForm()},clearForm:function(){this.txtEmail.setValue(""),this.txtEmail.focus()},addUser:function(e){this.userModified=!0;var t=new BQAuth;Ext.apply(t,e),this.authRecord.addchild(t),this.reloadPermissions(this.authRecord)},reloadPermissions:function(e){if(!e){this.resource.getAuth(Ext.bind(this.reloadPermissions,this));return}this.store.removeAll(!0),this.authRecord=e,e=this.authRecord.children,this.fetchUserInfo(this.resource.owner,"owner",-1);for(var t=0;t<e.length;t++)e[t].user?this.fetchUserInfo(e[t].user,e[t].action,t):this.store.loadData([["",e[t].email,e[t].action,t,e[t].user_name]],!0)},fetchUserInfo:function(e,t,n,r){r?this.store.loadData([[r.display_name,r.email,t,n,r.user_name]],!0):BQFactory.request({uri:e,cb:Ext.bind(this.fetchUserInfo,this,[e,t,n],0)})},addComponents:function(){this.browser=Ext.create("Bisque.ResourceBrowser.Browser",{showOrganizer:!1,layout:Bisque.ResourceBrowser.LayoutFactory.LAYOUT_KEYS.Grid,layoutConfig:{colIconWidth:8,colValueText:"Email"},flex:1,frame:!0,region:"east",viewMode:"ViewSearch",wpublic:"true",dataset:"/data_service/user?view=full",listeners:{scope:this,Select:this.userSelected,browserLoad:Ext.Function.pass(this.reloadPermissions,[undefined],this)}});var e=Ext.create("Ext.form.Label",{html:"<b>- or -</b>",margin:3,style:"color:#04408C;text-align:center"});this.form=Ext.create("Ext.form.Panel",{frame:!0,height:110,title:"Invite a guest",fieldDefaults:{labelAlign:"left",labelWidth:90,anchor:"100%"},items:[{xtype:"textfield",name:"email",fieldLabel:"Email address",vtype:"email",margin:"10 5 5 5"}],buttonAlign:"center",buttons:{defaults:{scope:this,padding:5},items:[{text:"Add guest",handler:this.addEmail},{text:"Clear",handler:this.clearForm}]}}),this.txtEmail=this.form.getComponent(0),this.grid=Ext.create("Ext.grid.Panel",{store:this.getStore(),frame:!0,border:!1,dockedItems:[{xtype:"toolbar",dock:"bottom",layout:{type:"hbox",pack:"center"},items:[{xtype:"checkbox",itemId:"cbNotify",boxLabel:"Notify users.",checked:!0,handler:Ext.emptyFn}]}],columns:{defaults:{minWidth:20},items:[{text:"Name",flex:3,sortable:!1,dataIndex:"name"},{text:"Email address",flex:4,sortable:!1,align:"center",dataIndex:"value"},{text:"Permission",defaults:{align:"center",sortable:!1,minWidth:25,maxWidth:60},columns:[{xtype:"checkcolumn",text:"View",dataIndex:"view"},{xtype:"checkcolumn",text:"Edit",dataIndex:"edit"}],flex:1,sortable:!1,align:"center"},{xtype:"actioncolumn",itemId:"colAction",maxWidth:60,menuDisabled:!0,sortable:!1,align:"center",items:[{icon:bq.url("../export_service/public/images/delete.png"),align:"center",tooltip:"Remove",handler:function(e,t,n){if(t==0){BQ.ui.error("Cannot delete owner record!",3e3);return}this.userModified=!0,this.authRecord.children.splice(t-1,1),e.store.removeAt(t)},scope:this}]}]}}),this.centerPanel.add(this.grid),this.eastPanel.add([this.browser,e,this.form])},getStore:function(){return this.store=Ext.create("Ext.data.ArrayStore",{fields:["name","value","permission","viewPriority","user_name",{name:"view",type:"bool",convert:function(e,t){return!0}},{name:"edit",type:"bool",convert:function(e,t){return Ext.isEmpty(e)&&(e=t.data.permission=="edit"||t.data.permission=="owner"?!0:!1),t.data.permission=="owner"&&(e=!0),e}}],sorters:[{property:"viewPriority",direction:"ASC"}]}),this.store}}),Ext.define("BQ.ShareDialog.Offline",{extend:"BQ.ShareDialog",constructor:function(e){var t=new BQResource;Ext.apply(t,{owner:BQApp.user.uri,getAuth:function(e){var t=new BQResource;e(t)}}),e.resource=t,this.callParent([e])},btnSave:function(){var e=!1;for(var t=0;t<this.store.getCount();t++){var n=this.store.getAt(t);n.dirty&&(e=!0,n.commit(),this.authRecord.children[t-1].action=n.get("edit")?"edit":"read")}var r=this.grid.getDockedItems('toolbar[dock="bottom"]')[0].getComponent("cbNotify").getValue();if(e||this.userModified)for(var t=0;t<this.resources.length;t++)this.resources[t].resource.getAuth(Ext.bind(this.addAuth,this,[r],1));this.close()},addAuth:function(e,t){t||(e.uri=Ext.urlAppend(e.uri,"notify=false"));for(var n=0;n<this.authRecord.children.length;n++)e.addchild(this.authRecord.children[n]);e.save_(undefined,this.success,this.failure)},success:function(e,t){BQ.ui.notification(t||"Operation successful.")},failure:function(e){BQ.ui.error(e||"Operation failed!")}}),Ext.define("BQ.form.ComboBox",{extend:"Ext.form.field.ComboBox",alias:["widget.bqcombobox","widget.bqcombo"],setValue:function(e,t){return this.valueNotFoundText=e,this.rawValue||(this.rawValue=e),this.callParent(arguments)}}),Ext.define("BQ.grid.plugin.RowEditing",{extend:"Ext.grid.plugin.RowEditing",alias:"bq.rowediting",requires:["Ext.grid.RowEditor"],cancelEdit:function(){var e=this;e.callParent();var t=e.getEditor().getForm();t.isValid()||e.fireEvent("canceledit",e.grid,{})}}),Ext.define("Bisque.ResourceTagger",{extend:"Ext.panel.Panel",constructor:function(e){e=e||{},Ext.apply(this,{layout:"fit",padding:"0 1 0 0",style:"background-color:#FFF",border:!1,rootProperty:e.rootProperty||"tags",autoSave:e.autoSave==undefined?!0:!1,resource:{},editable:!0,tree:e.tree||{btnAdd:!0,btnDelete:!0,btnImport:!0},store:{},dirtyRecords:[]}),this.viewMgr=Ext.create("Bisque.ResourceTagger.viewStateManager",e.viewMode),this.populateComboStore(),this.callParent([e]),this.setResource(e.resource)},populateComboStore:function(){var e=Ext.ModelManager.getModel("TagValues");e||Ext.define("TagValues",{extend:"Ext.data.Model",fields:[{name:"value",mapping:"@value"}]}),this.store_values=Ext.create("Ext.data.Store",{model:"TagValues",autoLoad:!0,autoSync:!1,proxy:{noCache:!1,type:"ajax",limitParam:undefined,pageParam:undefined,startParam:undefined,url:"/xml/dummy_tag_values.xml",reader:{type:"xml",root:"resource",record:"tag"}}});var t=Ext.ModelManager.getModel("TagNames");t||Ext.define("TagNames",{extend:"Ext.data.Model",fields:[{name:"name",mapping:"@name"}]}),this.store_names=Ext.create("Ext.data.Store",{model:"TagNames",autoLoad:!0,autoSync:!1,proxy:{noCache:!1,type:"ajax",limitParam:undefined,pageParam:undefined,startParam:undefined,url:"/data_service/image/?tag_names=1",reader:{type:"xml",root:"resource",record:"tag"}}})},setResource:function(e,t){this.setLoading(!0),e instanceof BQObject?this.loadResourceInfo(e):BQFactory.request({uri:e,cb:Ext.bind(this.loadResourceInfo,this)})},loadResourceInfo:function(e){this.fireEvent("beforeload",this,e),this.resource=e,this.editable=!1,this.disableAuthTest||this.testAuth(BQApp.user,!1),this.resource.tags.length>0?this.loadResourceTags(this.resource.tags):this.resource.loadTags({cb:callback(this,"loadResourceTags"),depth:"deep&wpublic=1"})},reload:function(){this.setResource(this.resource.uri)},loadResourceTags:function(e,t){var n=this.resource.type||this.resource.resource_type;if(n.indexOf("data_service/template")!=-1&&!t){BQFactory.request({uri:this.resource.type+"?view=deep",cb:Ext.bind(this.initCopy,this),errorcb:Ext.bind(this.loadResourceTags,this,[this.resource.tags,!0])});return}this.setLoading(!1);var r={};r[this.rootProperty]=e,this.removeAll(!0),this.add(this.getTagTree(r)),this.fireEvent("onload",this,this.resource),this.relayEvents(this.tree,["itemclick"])},initCopy:function(e){var t=this.copyTemplate(e,this.resource);this.resource=t,this.loadResourceTags(this.resource.tags,e)},copyTemplate:function(e,t){for(var n=0;n<t.tags.length;n++){var r=e.findTags({attr:"uri",value:window.location.origin+t.tags[n].type});Ext.isEmpty(r)||(r=r instanceof Array?r[0]:r,t.tags[n].template=r.template,this.copyTemplate(r,t.tags[n]))}return t},getTagTree:function(e){return this.rowEditor=Ext.create("Bisque.ResourceTagger.Editor",{clicksToMoveEditor:1,tagger:this,errorSummary:!1,listeners:{edit:this.finishEdit,cancelEdit:this.cancelEdit,scope:this},beforeEdit:function(e){if(this.tagger.editable&&!isEmptyObject(e.record.raw.template)&&this.tagger.resource.resource_type!="template"){if(e.record.raw.template.Editable){try{this.tagger.tree.columns[1].setEditor(BQ.TagRenderer.Base.getRenderer({tplType:e.record.get("type"),tplInfo:e.record.raw.template}))}catch(t){alert(t)}return!0}return!1}return this.tagger.editable&&(this.tagger.updateQueryTagValues(e.record.get("name")),this.tagger.tree.columns[1].setEditor(BQ.TagRenderer.Base.getRenderer({tplType:"",tplInfo:"",valueStore:this.tagger.store_values}))),this.tagger.editable}}),this.tree=Ext.create("Ext.tree.Panel",{useArrows:!0,rootVisible:!1,border:!1,columnLines:!0,rowLines:!0,lines:!0,iconCls:"icon-grid",animate:this.animate,header:!1,store:this.getTagStore(e),multiSelect:!0,tbar:this.getToolbar(),columns:this.getTreeColumns(),selModel:this.getSelModel(),plugins:this.viewMgr.state.editable?[this.rowEditor]:null,viewConfig:{plugins:{ptype:"treeviewdragdrop",allowParentInserts:!0}},listeners:{checkchange:function(e,t){t?this.fireEvent("select",this,e):this.fireEvent("deselect",this,e),this.checkTree(e,t)},scope:this}}),this.store.tagTree=this.tree,this.tree},checkTree:function(e,t){e.set("checked",t);for(var n=0;n<e.childNodes.length;n++)this.checkTree(e.childNodes[n],t)},toggleTree:function(e){e.set("checked",!e.get("checked"));for(var t=0;t<e.childNodes.length;t++)this.toggleTree(e.childNodes[t])},getSelModel:function(){return null},updateQueryTagValues:function(e){var t=this.store_values.getProxy();t.url="/data_service/image?tag_values="+encodeURIComponent(e),this.store_values.load()},getTreeColumns:function(){return[{xtype:"treecolumn",dataIndex:"name",text:this.colNameText||"Name",flex:.8,sortable:!0,field:{xtype:"bqcombobox",tabIndex:0,store:this.store_names,displayField:"name",valueField:"name",queryMode:"local",allowBlank:!1,validateOnChange:!1,blankText:"Tag name is required!",msgTarget:"none",listeners:{change:{fn:function(e,t,n,r){this.updateQueryTagValues(t)},buffer:250},scope:this}}},{text:this.colValueText||"Value",itemId:"colValue",dataIndex:"value",flex:1,sortable:!0,editor:{allowBlank:!1},renderer:Bisque.ResourceTagger.BaseRenderer}]},getTagStore:function(e){return this.store=Ext.create("Ext.data.TreeStore",{defaultRootProperty:this.rootProperty,root:e,fields:[{name:"name",type:"string",convert:function(e,t){if(t.raw instanceof BQGObject){var n=[];t.raw.type&&t.raw.type!="gobject"&&n.push(t.raw.type),t.raw.name&&n.push(t.raw.name);if(n.length>0)return n.join(": ")}return e||t.data.type}},{name:"value",type:"string"},{name:"type",type:"string"},{name:"iconCls",type:"string",convert:Ext.bind(function(e,t){return t.raw&&t.raw[this.rootProperty].length!=0?"icon-folder":"icon-tag"},this)},{name:"qtip",type:"string",convert:this.getTooltip},this.getStoreFields()],indexOf:function(e){return this.tagTree.getView().indexOf(e)},applyModifications:function(){var e=this.tree.nodeHash,t=!1;for(var n in e)e[n].dirty&&(t=!0,Ext.apply(e[n].raw,{name:e[n].get("name"),value:e[n].get("value")}),e[n].commit());return this.getRemovedRecords().length>0?!0:t},onNodeAdded:function(e,t){var n=this,r=n.getProxy(),i=r.getReader(),s=t.raw||t[t.persistenceProperty],o;Ext.Array.remove(n.removed,t),t.isLeaf()||(o=i.getRoot(s),o&&n.fillNode(t,i.extractData(o))),n.autoSync&&!n.autoSyncSuspended&&(t.phantom||t.dirty)&&n.sync()}}),this.store},getTooltip:function(e,t){if(t.raw instanceof BQGObject){var n=[];t.raw.type&&t.raw.type!="gobject"&&n.push(t.raw.type),t.raw.name&&n.push(t.raw.name);if(n.length>0)return n.join(" : ")}return t.data.name+" : "+t.data.value},getStoreFields:function(){return{name:"dummy",type:"string"}},getToolbar:function(){var e=[{xtype:"buttongroup",itemId:"grpAddDelete",hidden:this.viewMgr.state.btnAdd&&this.viewMgr.state.btnDelete,items:[{itemId:"btnAdd",text:"Add",hidden:this.viewMgr.state.btnAdd,scale:"small",iconCls:"icon-add",handler:this.addTags,disabled:this.tree.btnAdd,scope:this},{itemId:"btnDelete",text:"Delete",hidden:this.viewMgr.state.btnDelete,scale:"small",iconCls:"icon-delete",handler:this.deleteTags,disabled:this.tree.btnDelete,scope:this}]},{xtype:"buttongroup",itemId:"grpImportExport",hidden:this.viewMgr.state.btnImport&&this.viewMgr.state.btnExport,items:[{itemId:"btnImport",text:"Import",hidden:this.viewMgr.state.btnImport,scale:"small",iconCls:"icon-import",handler:this.importMenu,disabled:this.tree.btnImport,scope:this},{text:"Export",scale:"small",hidden:this.viewMgr.state.btnExport,disabled:this.tree.btnExport,iconCls:"icon-export",menu:{items:[{text:"as XML",handler:this.exportToXml,hidden:this.viewMgr.state.btnXML,scope:this},{text:"as CSV",handler:this.exportToCsv,hidden:this.viewMgr.state.btnCSV,scope:this},{text:"to Google Docs",handler:this.exportToGDocs,hidden:!0,scope:this}]}}]},{xtype:"buttongroup",hidden:this.viewMgr.state.btnSave||this.autoSave,items:[{text:"Save",hidden:this.viewMgr.state.btnSave||this.autoSave,scale:"small",iconCls:"icon-save",handler:this.saveTags,scope:this}]}];return e},addTags:function(){var e=this.tree.getSelectionModel().getSelection(),t=this.tree.plugins[0];e.length?e=e[0]:e=this.tree.getRootNode();var n={name:this.defaultTagName||"",value:this.defaultTagValue||""};n[this.rootProperty]=[];var r=e.appendChild(n);this.newNode=r,e.expand(),t.startEdit(r,0)},cancelEdit:function(e,t){t.record&&t.record.dirty&&t.record.parentNode.removeChild(t.record)},finishEdit:function(e,t){if(t.record.raw instanceof BQObject){this.autoSave&&(this.saveTags(t.record.raw,!0),t.record.data.qtip=this.getTooltip("",t.record),t.record.commit());return}this.editing=!0;var n=new BQTag;n=Ext.apply(n,{name:t.record.data.name,value:t.record.data.value});var r=t.record.parentNode.isRoot()?this.resource:t.record.parentNode.raw;r.addtag(n),this.isValidURL(n.value)&&(n.type="link",t.record.data.type="link"),this.autoSave&&this.saveTags(r,!0,n),t.record.raw=n,t.record.loaded=!0,t.record.data.qtip=this.getTooltip("",t.record),t.record.commit(),t.record.parentNode.data.iconCls="icon-folder",t.view.refresh(),this.editing=!1},deleteTags:function(){var e=this.tree.getSelectionModel().getSelection(),t,n=Ext.bind(function(){this.tree.setLoading(!1)},this);if(e.length){this.tree.setLoading(!0);for(var r=0;r<e.length;r++)t=e[r].parentNode.isRoot()?this.resource:e[r].parentNode.raw,t.deleteTag(e[r].raw,n,n),e[r].parentNode.childNodes.length<=1&&(e[r].parentNode.data.iconCls="icon-tag"),e[r].parentNode.removeChild(e[r],!0);BQ.ui.message("Resource tagger - Delete",e.length+" record(s) deleted!"),this.tree.getSelectionModel().deselectAll()}},saveTags:function(e,t){var n=typeof e==BQObject?e:this.resource;if(this.store.applyModifications()){function r(e,t,n,r){}n.save_(undefined,r),t||BQ.ui.message("","Changes were saved successfully!")}else BQ.ui.message("","No records modified!")},importMenu:function(e,t){if(!e.menu){var n=[];for(var r=0;r<BQApp.resourceTypes.length;r++)n.push({text:"from <b>"+BQApp.resourceTypes[r].name+"</b>",name:"/data_service/"+BQApp.resourceTypes[r].name,handler:this.importTags,scope:this});e.menu=Ext.create("Ext.menu.Menu",{items:n})}e.showMenu()},importTags:function(e){var t=new Bisque.ResourceBrowser.Dialog({height:"85%",width:"85%",dataset:e.name,viewMode:"ViewerLayouts",selType:"SINGLE",listeners:{Select:function(e,t){if(t instanceof BQTemplate){function n(e){e=="yes"&&BQ.TemplateManager.createResource({name:"",noSave:!0},Ext.bind(this.onResourceCreated,this),t.uri+"?view=deep")}this.resource.type?Ext.MessageBox.confirm("Reapply template","This resource is already templated. Do you wish to reapply selected template?",Ext.bind(n,this)):n.apply(this,["yes"])}else t.loadTags({cb:callback(this,"appendTags")})},scope:this}})},onResourceCreated:function(e,t){e.type==this.resource.type?this.mergeTags(e.tags):(this.resource.type=e.type,this.appendTags(e.tags));var e=this.copyTemplate(t,this.resource);this.resource=e},mergeTags:function(e){this.tree.setLoading(!0);if(e.length>0){var t=this.stripURIs(e);for(var n=0;n<e.length;n++){var r=this.resource.findTags({attr:"type",value:e[n].type});Ext.isEmpty(r)&&(this.resource.tags.push(t[n]),this.addNode(this.tree.getRootNode(),t[n]))}this.autoSave&&this.saveTags(null,!0)}this.tree.setLoading(!1)},appendTags:function(e){this.tree.setLoading(!0);if(e.length>0){e=this.stripURIs(e);var t=this.tree.getSelectionModel().getSelection();t.length?(t=t[0],t.raw.tags=t.raw.tags.concat(e)):(t=this.tree.getRootNode(),this.resource.tags=this.resource.tags.concat(e)),this.addNode(t,e),t.expand(),this.autoSave&&this.saveTags(null,!0)}this.tree.setLoading(!1)},stripURIs:function(e){var t=Ext.create("Bisque.ResourceTagger.OwnershipStripper");return t.visit_array(e),e},updateNode:function(e,t,n){if(!e)t.raw.loadTags({cb:callback(this,"updateNode",!0,t),depth:"full"});else for(var r=0;r<n.length;r++)n[r].uri!=t.childNodes[r].raw.uri?alert("Tagger::updateNode - URIs not same!"):this.addNode(t.childNodes[r],n[r][this.rootProperty])},addNode:function(e,t){var n,r;t instanceof Array||(t=[t]);for(r=0;r<t.length;r++)n=Ext.ModelManager.create(t[r],this.store.model),Ext.data.NodeInterface.decorate(n),n.raw=t[r],e.appendChild(n),e.data.iconCls="icon-folder",this.tree.getView().refresh()},testAuth:function(e,t,n){if(e){if(!t)this.resource.testAuth(e.uri,Ext.bind(this.testAuth,this,[e,!0],0));else if(n){this.tree.btnAdd=!1,this.tree.btnDelete=!1,this.tree.btnImport=!1,this.editable=!0;if(this.tree instanceof Ext.Component){var r=this.tree.getDockedItems("toolbar")[0];r.getComponent("grpAddDelete").getComponent("btnAdd").setDisabled(!1),r.getComponent("grpAddDelete").getComponent("btnDelete").setDisabled(!1),r.getComponent("grpImportExport").getComponent("btnImport").setDisabled(!1)}}}else e===undefined&&BQApp.on("gotuser",Ext.bind(this.testAuth,this,[!1],1))},isValidURL:function(e){var t=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;return t.test(e)},exportToXml:function(){var e="/export/initStream?urls=";e+=encodeURIComponent(this.resource.uri+"?view=deep"),e+="&filename="+(this.resource.name||"document"),window.open(e)},exportToCsv:function(){var e="/stats/csv?url=";e+=encodeURIComponent(this.resource.uri),e+="&xpath=%2F%2Ftag&xmap=tag-name-string&xmap1=tag-value-string&xreduce=vector",e+="&title=Name&title1=Value",e+="&filename="+(this.resource.name||"document")+".csv",window.open(e)},exportToGDocs:function(){var e="/export/to_gdocs?url="+encodeURIComponent(this.resource.uri);window.open(e)}}),Ext.define("Bisque.GObjectTagger",{extend:"Bisque.ResourceTagger",animate:!1,constructor:function(e){e.rootProperty="gobjects",e.colNameText="GObject",e.colValueText="Vertices",e.tree={btnExport:!0},this.callParent(arguments)},loadResourceInfo:function(e){this.fireEvent("beforeload",this,e),this.resource=e,this.resource.loadGObjects({cb:callback(this,"loadResourceTags"),depth:"deep&wpublic=1"})},getStoreFields:function(){return{name:"checked",type:"bool",defaultValue:!0}},getToolbar:function(){var e=this.callParent(arguments),t=[{xtype:"buttongroup",items:[{xtype:"splitbutton",arrowAlign:"right",text:"Toggle selection",scale:"small",iconCls:"icon-uncheck",handler:this.toggleCheckTree,checked:!0,scope:this,menu:{items:[{check:!0,text:"Check all",handler:this.toggleCheck,scope:this},{check:!1,text:"Uncheck all",handler:this.toggleCheck,scope:this}]}}]}];return t.concat(e)},toggleCheckTree:function(e){var t=this.tree.getRootNode(),n;e.checked=!e.checked,e.checked?e.setIconCls("icon-uncheck"):e.setIconCls("icon-check");for(var r=0;r<t.childNodes.length;r++)n=t.childNodes[r].get("checked")?"Deselect":"Select",this.fireEvent(n,this,t.childNodes[r]);this.toggleTree(t)},toggleCheck:function(e){e.checked=e.check;var t=this.tree.getRootNode(),n=e.checked?"Select":"Deselect";for(var r=0;r<t.childNodes.length;r++)this.fireEvent(n,this,t.childNodes[r]);this.checkTree(t,e.checked)},appendFromMex:function(e){var t=[];for(var n=0;n<e.length;n++)t[n]=e[n];for(var n=0;n<t.length;n++){if(t[n].resource.children&&t[n].resource.children.length>0){for(var r=0;r<t[n].resource.children.length;r++)if(t[n].resource instanceof BQMex){var i=Ext.create("Bisque.Resource.Mex",{resource:t[n].resource.children[r]});t.push(i)}continue}var s=t[n].resource.find_tags("outputs");s?this.appendGObjects(this.findGObjects(s,this.resource.uri),t[n].resource):t[n].resource.loadGObjects({cb:Ext.bind(this.appendGObjects,this,[t[n].resource],!0)})}},findGObjects:function(e,t){if(e.value&&e.value==t)return e.gobjects;var n=null,r=null;for(var i=0;(r=e.tags[i])&&!n;i++)n=this.findGObjects(r,t);return n},deleteGObject:function(e){var t=this.tree.getRootNode(),n=t.getChildAt(e);t.removeChild(n,!0),this.tree.getView().refresh()},appendGObjects:function(e,t){if(e&&e.length>0)if(t){var n=new Date;n.setISO(t.ts),this.addNode(this.tree.getRootNode(),{name:e[0].name,value:Ext.Date.format(n,"F j, Y g:i:s a"),gobjects:e}),this.fireEvent("onappend",this,e)}else this.addNode(this.tree.getRootNode(),e)},exportToXml:function(){},exportToCsv:function(){},exportTo:function(e){function r(e,t){e.raw&&this.noFiles++}e=e||"csv";var t,n=this.tree.getChecked();this.noFiles=0,this.csvData="",n.forEach(Ext.bind(r,this));for(var i=0;i<n.length;i++)t=n[i].raw,t&&Ext.Ajax.request({url:t.uri+"?view=deep&format="+e,success:Ext.bind(this.saveCSV,this,[e],!0),disableCaching:!1})},saveCSV:function(e,t,n){this.csvData+="\n"+e.responseText,this.noFiles--,this.noFiles||(location.href="data:text/attachment,"+encodeURIComponent(this.csvData))},updateViewState:function(e){}}),Ext.define("Bisque.ResourceTagger.Editor",{extend:"BQ.grid.plugin.RowEditing",completeEdit:function(){this.callParent(arguments),this.finishEdit()},cancelEdit:function(){this.callParent(arguments),this.finishEdit()},finishEdit:function(){this.context&&this.context.grid.getSelectionModel().deselect(this.context.record)}}),Ext.define("Bisque.ResourceTagger.OwnershipStripper",{extend:BQVisitor,visit:function(e,t){Ext.apply(e,{uri:undefined,ts:undefined,owner:undefined,perm:undefined,index:undefined})}}),Ext.define("Bisque.ResourceTagger.viewStateManager",{constructor:function(e){function t(e,t){var n={};for(i in e)n[i]=t;return n}this.state={btnAdd:!0,btnDelete:!0,btnToggleCheck:!0,btnImport:!0,btnExport:!0,btnXML:!0,btnCSV:!0,btnGDocs:!0,btnSave:!0,editable:!0};switch(e){case"ViewerOnly":this.state=t(this.state,!0),this.state.editable=!1;break;case"PreferenceTagger":this.state.btnAdd=!1,this.state.btnDelete=!1;break;case"ReadOnly":this.state.btnExport=!1,this.state.btnXML=!1,this.state.btnCSV=!1,this.state.btnGDocs=!1,this.state.editable=!1;break;case"Offline":this.state.btnAdd=!1,this.state.btnDelete=!1,this.state.btnImport=!1;break;case"GObjectTagger":this.state=t(this.state,!0),this.state.editable=!1,this.state.btnExport=!1,this.state.btnCSV=!1,this.state.btnGDocs=!1,this.state.btnXML=!1;break;default:this.state=t(this.state,!1),this.state.editable=!0}}}),Ext.define("Bisque.ResourceTaggerOffline",{extend:"Bisque.ResourceTagger",constructor:function(e){e=e||{},Ext.apply(e,{viewMode:"Offline",tree:{btnAdd:!1,btnDelete:!1,btnImport:!1}}),this.callParent([e])},setResource:function(e){this.resource=e||new BQResource,this.loadResourceTags(this.resource.tags)},saveTags:function(){this.store.applyModifications()},getTagDocument:function(){return this.resource&&this.resource.tags?this.resource.tags:[]}}),Bisque.ResourceTagger.LinkRenderer=function(e,t,n){return Ext.String.format('<a href={0} target="_blank">{1}</a>',e,e)},Bisque.ResourceTagger.ResourceRenderer=function(e,t,n){return Ext.String.format('<a href={0} target="_blank">{1}</a>',bq.url("/client_service/view?resource="+e),e)},Bisque.ResourceTagger.EmailRenderer=function(e,t,n){return Ext.String.format('<a href={0} target="_blank">{1}</a>',"mailto:"+e,e)},Bisque.ResourceTagger.VertexRenderer=function(e,t,n){var r="<select>",i=n.raw.vertices,s;for(var o=0;o<i.length;o++){s=i[o],r+="<option>";for(var u=0;u<s.xmlfields.length;u++)if(s[s.xmlfields[u]]!=null||s[s.xmlfields[u]]!=undefined)r+=s.xmlfields[u]+":"+s[s.xmlfields[u]]+", ";r+="</option>"}return r+="</select>",r},Bisque.ResourceTagger.RenderersAvailable={file:Bisque.ResourceTagger.LinkRenderer,link:Bisque.ResourceTagger.LinkRenderer,hyperlink:Bisque.ResourceTagger.LinkRenderer,statistics:Bisque.ResourceTagger.LinkRenderer,resource:Bisque.ResourceTagger.ResourceRenderer,bisqueresource:Bisque.ResourceTagger.ResourceRenderer,image:Bisque.ResourceTagger.ResourceRenderer,email:Bisque.ResourceTagger.EmailRenderer,point:Bisque.ResourceTagger.VertexRenderer,polyline:Bisque.ResourceTagger.VertexRenderer,polygon:Bisque.ResourceTagger.VertexRenderer,rectangle:Bisque.ResourceTagger.VertexRenderer,square:Bisque.ResourceTagger.VertexRenderer,circle:Bisque.ResourceTagger.VertexRenderer,ellipse:Bisque.ResourceTagger.VertexRenderer},Bisque.ResourceTagger.BaseRenderer=function(e,t,n){var r=Bisque.ResourceTagger.RenderersAvailable[n.data.type.toLowerCase()];return r?r.apply(this,arguments):e},Ext.define("BQ.Preferences.Object",{tag:{},dictionary:{tags:{}},status:undefined,exists:undefined,object:undefined}),Ext.define("BQ.Preferences",{singleton:!0,queue:[],constructor:function(){this.system=Ext.create("BQ.Preferences.Object"),this.user=Ext.create("BQ.Preferences.Object"),this.loadSystem(undefined,"INIT")},loadSystem:function(e,t){this.system.status=t;if(t=="INIT")BQFactory.request({uri:bq.url("/data_service/system?wpublic=1&view=deep"),cb:Ext.bind(this.loadSystem,this,["LOADED"],!0)});else if(t=="LOADED"){e=e.children[0],this.system.object=e;var n=e.find_tags("Preferences",!1);n!=null?(this.system.tag=n,this.system.dictionary=n.toNestedDict(!0)):(clog("SYSTEM preferences tag not found!\n"),this.system.exists=!1)}this.clearQueue()},loadUser:function(e,t){this.user.status=t;if(t=="INIT")BQFactory.request({uri:e.uri+"?view=deep",cb:Ext.bind(this.loadUser,this,["LOADED"],!0)});else if(t=="LOADED")if(e!=null){this.user.object=e;var n=e.find_tags("Preferences",!1);n!=null?(this.user.tag=n,this.user.dictionary=n.toNestedDict(!0)):(clog("USER preferences tag not found!\n"),this.user.exists=!0,this.user.tag=e)}else clog("USER - no user found!\n"),this.user.exists=!1;this.clearQueue()},clearQueue:function(){if(this.system.status=="LOADED"&&this.user.status=="LOADED")while(this.queue.length!=0)this.get(this.queue.pop())},get:function(e){function t(e){var n={};for(var r in e.tags)n[e.tags[r].data.name]=t(e.tags[r]);return isEmptyObject(n)?Ext.isString(e.data.value)?e.data.value.trim():e.data.value:n}e.type=e.type||"user",this.system.status=="LOADED"&&this.user.status=="LOADED"?e.type=="user"?e.callback(t(Ext.Object.merge(this.system.dictionary.tags[e.key]||{},this.user.dictionary.tags[e.key]||{}))):e.callback(t(this.system.dictionary.tags[e.key]||{data:{value:""}})):this.queue.push(e)},getMerged:function(){var e=Ext.Object.merge(this.system.dictionary,this.user.dictionary),t=new BQObject;return t.name="Preferences",t.fromNestedDict(e),t.tags},reloadUser:function(e){this.user=Ext.create("BQ.Preferences.Object"),this.loadUser(e,"INIT")},InitFromSystem:function(e){var t=this.stripOwnership([this.preference.systemTag.find_tags(e,!1)])},stripOwnership:function(e){var t=Ext.create("Bisque.ResourceTagger.OwnershipStripper");return t.visit_array(e),e}}),Ext.define("BQ.Preferences.Dialog",{extend:"Ext.window.Window",constructor:function(e){e=e||{},Ext.apply(this,{title:"Set preferences",modal:!0,layout:"fit",height:"70%",width:"70%",prefType:e.prefType||"user"});if(this.prefType=="user"){if(BQ.Preferences.user.status!="LOADED"){BQ.ui.notification("Initializing. Please wait...",2e3);return}if(BQ.Preferences.user.exists==0){BQ.ui.notification("Guests cannot save preferences! Please login first...",3e3);return}}this.callParent(arguments),BQ.Preferences.reloadUser(BQSession.current_session.user),BQ.Preferences.get({key:"",type:"system",callback:Ext.bind(this.addTagger,this,[this.prefType])}),this.show()},addTagger:function(e){this.tagger=Ext.create("Bisque.PreferenceTagger",{viewMode:"Offline",prefType:e}),this.add(this.tagger)}}),Ext.define("Bisque.PreferenceTagger",{extend:"Bisque.ResourceTagger",constructor:function(e){e=e||{},e.viewMode="PreferenceTagger",e.autoSave=!0,e.tree=e.tree||{btnAdd:!1,btnDelete:!1},this.callParent([e])},setResource:function(e){this.prefType=="user"?(this.resource=e||new BQResource,this.loadResourceTags(this.resource.tags),this.appendTags(BQ.Preferences.getMerged())):(this.resource=BQ.Preferences.system.tag,this.loadResourceTags(this.resource.tags)),this.tree.expandAll()},saveTags:function(e,t,n){if(e)if(this.store.applyModifications())if(this.prefType=="user"){n&&(e=n);var r=this.getTagParents(e);this.savePrefs(e,r),t||BQ.ui.message("Save","Changes were saved successfully!")}else this.resource.doc=this.resource,this.resource.save_();else BQ.ui.message("Save","No records modified!")},savePrefs:function(e,t){var n=BQ.Preferences.user.object;for(var r=t.length;r>=1;r--){var i=t[r-1],s=n.find_tags(i.name,!1);n=s?s:n.addtag({name:i.name,value:i.value})}n.uri&&(n.name=e.name,n.value=e.value||""),BQ.Preferences.user.tag.save_()},deleteTags:function(){var e=this.tree.getSelectionModel().getSelection(),t,n=BQ.Preferences.user.tag;BQ.Preferences.user.object.tags[0].delete_();var r=Ext.bind(function(){this.tree.setLoading(!1)},this);if(e.length){this.tree.setLoading(!0);for(var i=0;i<e.length;i++){var s=n.findTags({attr:"name",value:e[i].get("name"),deep:!0});if(!Ext.isEmpty(s))for(var o=0;o<s.length;o++)if(s[o].value==e[i].get("value")){t=e[i].parentNode.isRoot()?n:s[o].parent,t.deleteTag(s[o],r,r),e[i].parentNode.childNodes.length<=1&&(e[i].parentNode.data.iconCls="icon-tag"),e[i].parentNode.removeChild(e[i],!0);break}}this.tree.setLoading(!1),BQ.ui.message("Resource tagger - Delete",e.length+" record(s) deleted!"),this.tree.getSelectionModel().deselectAll()}},getTagParents:function(e){var t=[];while(e.parent)t.push(e),e=e.parent;return t.push(e),t}}),Ext.define("Bisque.DatasetBrowser.Dialog",{extend:"Ext.window.Window",constructor:function(e){var t=Ext.getBody().getViewSize(),n=parseInt(e.height.indexOf("%")==-1?e.height:t.height*parseInt(e.height)/100),r=parseInt(e.width.indexOf("%")==-1?e.width:t.width*parseInt(e.width)/100);Ext.apply(this,{layout:"fit",title:e.title||"Select a dataset...",modal:!0,border:!1,height:n,width:r,items:new Bisque.DatasetBrowser.Browser(e)},e),this.callParent([arguments]),this.relayEvents(this.getComponent(0),["DatasetDestroy"]),this.on("DatasetDestroy",this.destroy,this),this.show()}}),Ext.define("Bisque.DatasetBrowser.Browser",{extend:"Bisque.ResourceBrowser.Browser",constructor:function(e){Ext.apply(e,{viewMode:"DatasetBrowser"}),Ext.apply(this,{selectedDataset:null,bbar:{xtype:"toolbar",layout:{type:"hbox",align:"middle",pack:"center"},padding:12,items:[{xtype:"buttongroup",items:[{text:"Select",iconCls:"icon-select",scale:"medium",textAlign:"left",width:75,handler:this.btnSelect,scope:this}]},{xtype:"buttongroup",items:[{text:"Cancel",iconCls:"icon-cancel",textAlign:"left",scale:"medium",width:75,handler:this.btnCancel,scope:this}]}]}}),this.callParent(arguments),this.commandBar.btnDatasetClick(),this.manageEvents()},manageEvents:function(){this.msgBus.on({DatasetSelected:function(e){this.selectedDataset=e,this.ownerCt&&this.ownerCt.setTitle("Viewing dataset : "+e.name)},DatasetUnselected:function(){this.selectedDataset=null,this.ownerCt&&this.ownerCt.setTitle("Select a dataset...")},scope:this})},btnSelect:function(){this.selectedDataset?(this.fireEvent("DatasetSelect",this,this.selectedDataset),this.fireEvent("DatasetDestroy")):alert("No dataset selected!")},btnCancel:function(){this.fireEvent("DatasetDestroy")}}),Ext.define("Bisque.TemplateTagger",{extend:"Bisque.ResourceTagger",constructor:function(e){e=e||{},Ext.apply(e,{tree:{btnAdd:!1,btnDelete:!1,btnImport:!0,btnExport:!0},importDataset:"/data_service/template"}),this.tagRenderers=Ext.ClassManager.getNamesByExpression("BQ.TagRenderer.*"),this.tagTypes={};for(var t=0;t<this.tagRenderers.length;t++)Ext.ClassManager.get(this.tagRenderers[t]).componentName&&(this.tagTypes[Ext.ClassManager.get(this.tagRenderers[t]).componentName]=this.tagRenderers[t]);this.callParent([e])},setResource:function(e){this.resource=e||new BQTemplate,this.loadResourceTags(this.resource.tags),this.testAuth(BQApp.user,!1)},onEdit:function(e){if(e.field=="value"&&e.value!=e.record.get("value")){var t=e.record.raw,n=t.find_children("template");t.remove_resource(n.uri);var r=Ext.ClassManager.get(this.tagTypes[e.record.get("value")]).getTemplate();t.addchild(r)}e.record.raw&&this.autoSave&&(this.saveTags(e.record.raw,!0),e.record.commit())},importMenu:function(){var e=new Bisque.ResourceBrowser.Dialog({height:"85%",width:"85%",dataset:this.importDataset,viewMode:"ViewerLayouts",selType:"SINGLE",listeners:{Select:function(e,t){t.loadTags({depth:"deep",cb:Ext.bind(this.appendTags,this)})},scope:this}})},saveTags:Ext.emptyFn,updateQueryTagValues:Ext.emptyFn,finishEdit:function(e,t){this.callParent(arguments);var n=Ext.ClassManager.get(this.tagTypes[t.record.data.value]).getTemplate();t.record.raw.addchild(n)},populateComboStore:function(){this.store_names=[],this.store_values=Ext.create("Ext.data.ArrayStore",{fields:["value"]});var e=Ext.Object.getKeys(this.tagTypes);Ext.Array.forEach(e,function(e,t,n){n[t]=[e]}),this.store_values.loadData(e),this.defaultTagValue=this.store_values.getAt(0).get("value")},getTreeColumns:function(){return[{xtype:"treecolumn",text:"Field name",flex:1,dataIndex:"name",field:{tabIndex:0,allowBlank:!1,blankText:"Field name is required!"}},{text:"Type",flex:1,sortable:!0,dataIndex:"value",renderer:Bisque.ResourceTagger.BaseRenderer,field:{xtype:"combobox",displayField:"value",tabIndex:1,store:this.store_values,editable:!1,queryMode:"local"}}]}}),Ext.define("BQ.TemplateManager",{statics:{create:function(e){return Ext.create("BQ.TemplateManager.Creator",e)},createResource:function(e,t,n){function s(e,t){var n=document.createElement("a");for(var r=0;r<e.tags.length;r++){var i=e.tags[r];n.href=i.uri,s.call(this,i,t.addtag({name:i.name,value:i.template["Default value"]||"",type:n.pathname}))}return t}if(n instanceof BQTemplate){var r=document.createElement("a");r.href=n.uri;var i=new BQResource;Ext.apply(i,{resource_type:n.name,type:r.pathname},e),i=s.call(this,n,i),e.noSave?t(i,n):i.save_("/data_service/"+i.resource_type+"?view=deep",t,function(e){BQ.ui.error("An error occured while trying to create a resource from template: "+e)})}else BQFactory.request({uri:n,cb:Ext.pass(BQ.TemplateManager.createResource,[e,t]),cache:!1})}}}),Ext.define("BQ.TemplateManager.Creator",{extend:"Ext.panel.Panel",border:!1,layout:"border",heading:"Create template",bodyCls:"white",constructor:function(e){Ext.apply(this,{centerPanel:Ext.create("Ext.panel.Panel",{region:"center",border:!1,flex:7,title:"Editing resource template - "+e.resource.name||"",layout:"fit"}),eastPanel:Ext.create("Ext.panel.Panel",{region:"east",frame:!0,flex:3,title:"Properties",layout:"fit",collapsible:!0,split:!0})}),Ext.apply(this,{items:[this.centerPanel,this.eastPanel]}),this.callParent(arguments)},initComponent:function(){this.callParent(arguments),this.tagger=Ext.create("Bisque.TemplateTagger",{resource:this.resource,listeners:{itemclick:this.onFieldSelect,scope:this}}),this.grid=Ext.create("Ext.grid.property.Grid",{source:{},listeners:{edit:this.onPropertyEdit,scope:this},customEditors:{"Display values":{xtype:"textareafield",emptyText:"Enter comma separated display values e.g. Alabama, Alaska"},"Passed values":{xtype:"textareafield",emptyText:"Enter comma separated passed values e.g. AL, AK (defaults to display values)"},"Resource type":{xtype:"combo",store:Ext.create("Ext.data.Store",{fields:["name","uri"],data:BQApp.resourceTypes}),queryMode:"local",displayField:"name",editable:!1}}}),this.centerPanel.add(this.tagger),this.eastPanel.add(this.grid)},saveTemplate:function(){function e(e){BQ.ui.notification("Changes saved!",2e3),this.tagger.setResource(e)}this.resource.uri=this.resource.uri+"?view=deep",this.resource.save_(undefined,Ext.bind(e,this),Ext.pass(BQ.ui.error,["Save failed!"]))},onFieldSelect:function(e,t){this.currentField=t.raw,this.currentTemplate=this.currentField.find_children("template"),this.eastPanel.setTitle("Properties - "+this.currentField.name),this.grid.setSource(BQ.TagRenderer.Base.convertTemplate(this.currentTemplate))},onPropertyEdit:function(e,t){var n=t.record.get("name"),r=this.currentTemplate.find_tags(n);r&&(r.value=t.value.toString())}}),Ext.define("BQ.TagRenderer.Base",{alias:"BQ.TagRenderer.Base",inheritableStatics:{baseClass:"BQ.TagRenderer",template:{Type:"Base","Default value":"","Allow blank":!1,Editable:!0},getRenderer:function(e){var t=e.tplInfo.Type,n=BQ.TagRenderer.Base.baseClass+"."+t;return Ext.ClassManager.get(n)?Ext.create(n).getRenderer(e):(Ext.log({msg:Ext.String.format("TagRenderer: Unknown class: {0}, type: {1}. Initializing with default tag renderer.",n,t),level:"warn",stack:!0}),Ext.create(BQ.TagRenderer.Base.baseClass+"."+"String").getRenderer(e))},getTemplate:function(){var e=Ext.clone(this.template||{}),t=Ext.clone(Ext.ClassManager.get("BQ.TagRenderer.Base").template);return this.convertTemplate(Ext.Object.merge(t,e))},convertTemplate:function(e){if(e instanceof BQTemplate){var t={},e=e.tags;for(var n=0;n<e.length;n++)t[e[n].name]=this.parseVariable(e[n]);return t}if(e instanceof Object){var r=new BQTemplate,i;for(var n in e)r.addtag({name:n,value:e[n].toString(),type:typeof e[n]});return r.resource_type="template",r}},parseVariable:function(e){var t;e.value=Ext.isEmpty(e.value)?"":e.value;switch(e.type){case"number":t=parseFloat(e.value);break;case"boolean":t=Boolean(e.value);break;default:t=e.value}return t}}}),Ext.define("BQ.TagRenderer.String",{extend:"BQ.TagRenderer.Base",alias:"BQ.TagRenderer.String",inheritableStatics:{componentName:"String",template:{Type:"String",minLength:1,maxLength:200,RegEx:""}},getRenderer:function(e){var t=e.valueStore;if(!t){Ext.ModelManager.getModel("TagValues")||Ext.define("TagValues",{extend:"Ext.data.Model",fields:[{name:"value",mapping:"@value"}]});var t=Ext.create("Ext.data.Store",{model:"TagValues",autoLoad:!0,autoSync:!1,proxy:{noCache:!1,type:"ajax",limitParam:undefined,pageParam:undefined,startParam:undefined,url:"/xml/dummy_tag_values.xml",reader:{type:"xml",root:"resource",record:"tag"}}})}return{xtype:"combobox",store:t,displayField:"value",valueField:"value",queryMode:"local",typeAhead:!0,minLength:e.tplInfo.minLength||BQ.TagRenderer.String.template.minLength,maxLength:e.tplInfo.maxLength||BQ.TagRenderer.String.template.maxLength,regex:RegExp(e.tplInfo.RegEx||"")}}}),Ext.define("BQ.TagRenderer.Number",{extend:"BQ.TagRenderer.Base",alias:"BQ.TagRenderer.Number",inheritableStatics:{componentName:"Number",template:{Type:"Number",minValue:0,maxValue:100,allowDecimals:!0,decimalPrecision:2}},getRenderer:function(e){return{xtype:"numberfield",minValue:e.tplInfo.minValue||BQ.TagRenderer.Number.template.minValue,maxValue:e.tplInfo.maxValue||BQ.TagRenderer.Number.template.maxValue,allowDecimals:e.tplInfo.allowDecimals||BQ.TagRenderer.Number.template.allowDecimals,decimalPrecision:e.tplInfo.decimalPrecision||BQ.TagRenderer.Number.template.decimalPrecision}}}),Ext.define("BQ.TagRenderer.Boolean",{extend:"BQ.TagRenderer.Base",alias:"BQ.TagRenderer.Boolean",inheritableStatics:{componentName:"Boolean",template:{Type:"Boolean"}},getRenderer:function(e){return{xtype:"checkbox",boxLabel:" (checked = True, unchecked = False)"}}}),Ext.define("BQ.TagRenderer.Date",{extend:"BQ.TagRenderer.Base",alias:"BQ.TagRenderer.Date",inheritableStatics:{componentName:"Date",template:{Type:"Date",format:"m/d/Y"}},getRenderer:function(e){return{xtype:"datefield",format:e.tplInfo.format||BQ.TagRenderer.Date.template.format,getValue:function(){return this.getRawValue()}}}}),Ext.define("BQ.TagRenderer.ComboBox",{extend:"BQ.TagRenderer.Base",alias:"BQ.TagRenderer.ComboBox",inheritableStatics:{componentName:"ComboBox",template:{Type:"ComboBox","Display values":"","Passed values":""}},getRenderer:function(e){var t=e.tplInfo["Display values"]||"",n="";t=t.split(","),e.tplInfo["Passed values"]?n=e.tplInfo["Passed values"].split(","):n=t;for(var r=0,i=[];r<t.length;r++)i.push({name:t[r],value:n[r]});var s=Ext.create("Ext.data.Store",{fields:["name","value"],data:i});return{xtype:"combobox",store:s,displayField:"name",valueField:"value",editable:!1}}}),Ext.define("BQ.TagRenderer.Hyperlink",{extend:"BQ.TagRenderer.Base",alias:"BQ.TagRenderer.Hyperlink",inheritableStatics:{componentName:"Hyperlink",template:{Type:"Hyperlink"}},getRenderer:function(e){return{xtype:"textfield",vtype:"url"}}}),Ext.define("BQ.TagRenderer.BisqueResource",{extend:"BQ.TagRenderer.Base",alias:"BQ.TagRenderer.BisqueResource",inheritableStatics:{componentName:"BisqueResource",template:{Type:"BisqueResource","Resource type":"image"}},getRenderer:function(e){return{xtype:"BisqueResourcePicker",dataset:e.tplInfo["Resource type"]||BQ.TagRenderer.BisqueResource.template["Resource type"],editable:!1}}}),Ext.define("Bisque.Resource.Picker",{extend:"Ext.form.field.Picker",xtype:"BisqueResourcePicker",triggerCls:Ext.baseCSSPrefix+"form-date-trigger",createPicker:function(){var e=new Bisque.ResourceBrowser.Dialog({height:"85%",width:"85%",viewMode:"ViewerLayouts",selType:"SINGLE",dataset:"/data_service/"+this.dataset,listeners:{Select:function(e,t){this.setValue(t.uri)},scope:this}})}}),Ext.define("BQ.TagRenderer.Email",{extend:"BQ.TagRenderer.Base",alias:"BQ.TagRenderer.Email",inheritableStatics:{componentName:"Email",template:{Type:"Email"}},getRenderer:function(e){return{xtype:"textfield",vtype:"email"}}}),Ext.define("BQ.Export.Panel",{extend:"Ext.panel.Panel",constructor:function(){Ext.apply(this,{heading:"Download Images",layout:"fit"}),this.callParent(arguments)},initComponent:function(){this.dockedItems=[{xtype:"toolbar",dock:"top",items:[{xtype:"tbtext",padding:10,html:"<h2>"+this.heading+":</h2>"},{xtype:"buttongroup",margin:5,items:{xtype:"splitbutton",arrowAlign:"right",text:"Add Images",scale:"large",width:140,padding:3,iconCls:"add",iconAlign:"left",iconCls:"icon-select-images",resourceType:"image",handler:this.selectImage,scope:this,menu:{items:[{resourceType:"file",text:"Add Files",handler:this.selectImage,scope:this}]}}},{xtype:"buttongroup",margin:5,items:{text:"Add Dataset",scale:"large",padding:3,width:140,iconCls:"add",iconAlign:"left",iconCls:"icon-select-dataset",handler:this.selectDataset,scope:this}}]},{xtype:"toolbar",dock:"bottom",items:[{xtype:"tbspacer",width:10,padding:10},{xtype:"buttongroup",margin:5,items:{xtype:"splitbutton",text:"Download",scale:"large",padding:3,width:160,iconCls:"add",iconAlign:"left",iconCls:"icon-download",arrowAlign:"right",menuAlign:"bl-tl?",compressionType:"tar",handler:this.download,scope:this,menu:{defaults:{xtype:"menucheckitem",group:"downloadGroup",groupCls:Ext.baseCSSClass+"menu-group-icon",checked:!1,scope:this,handler:this.download},items:[{compressionType:"tar",text:"as TARball",checked:!0},{compressionType:"gzip",text:"as GZip archive"},{compressionType:"bz2",text:"as BZip2 archive"},{compressionType:"zip",text:"as (PK)Zip archive"}]}}},{xtype:"buttongroup",margin:5,items:{text:"Export to Google Docs",disabled:!0,scale:"large",padding:3,width:160,textAlign:"left",iconCls:"add",iconAlign:"left",iconCls:"icon-gdocs"}}]}],this.callParent(arguments),this.add(this.getResourceGrid())},downloadResource:function(e,t){e instanceof Array||(e=[e]);for(var n=0,r,i=[];n<e.length;n++){r=e[n].resource_type;if(r!="dataset"||t=="none")r="file";i.push(["","",r,e[n].ts,"",e[n].uri,0])}this.resourceStore.loadData(i),this.download({compressionType:t})},download:function(e){function t(e){var t=0,n=[];while((t=this.resourceStore.find("type",e,t))!=-1)n.push(this.resourceStore.getAt(t).get("uri")),t++;return n}if(!this.resourceStore.count()){BQ.ui.message("Download failed","Nothing to download! Please add files or datasets first...");return}Ext.create("Ext.form.Panel",{url:"/export/initStream",defaultType:"hiddenfield",method:"GET",standardSubmit:!0,items:[{name:"compressionType",value:e.compressionType},{name:"files",value:t.call(this,"image").concat(t.call(this,"file"))},{name:"datasets",value:t.call(this,"dataset")}]}).submit()},exportResponse:function(e){},selectImage:function(e){var t=Ext.create("Bisque.ResourceBrowser.Dialog",{height:"85%",width:"85%",dataset:"/data_service/"+e.resourceType,wpublic:"true",listeners:{Select:this.addToStore,scope:this}})},selectDataset:function(){var e=Ext.create("Bisque.DatasetBrowser.Dialog",{height:"85%",width:"85%",wpublic:"true",listeners:{DatasetSelect:this.addToStore,scope:this}})},addToStore:function(e,t){if(t instanceof Array){for(var n=0;n<t.length;n++)this.addToStore(e,t[n]);return}var r=[],i,s;t.resource_type=="image"?(i=t.src,s=1):t.resource_type=="dataset"?(i=bq.url("../export_service/public/images/folder.png"),s=0):t.resource_type=="file"&&(i=bq.url("../export_service/public/images/file.png"),s=2),r.push(i,t.name||"",t.resource_type,t.ts,t.permission||"",t.uri,s),this.resourceStore.loadData([r],!0)},getResourceGrid:function(){return this.resourceGrid=Ext.create("Ext.grid.Panel",{store:this.getResourceStore(),border:0,listeners:{scope:this,itemdblclick:function(e,t,n,r){var i=window.open("","_blank");i.location=bq.url("/client_service/view?resource="+t.get("uri"))}},columns:{items:[{width:120,dataIndex:"icon",menuDisabled:!0,sortable:!1,align:"center",renderer:function(e){return'<div style="height:40px"><img src='+e+"?thumbnail=40,40&format=jpeg /></div>"}},{text:"Name",flex:.6,maxWidth:350,sortable:!0,dataIndex:"name"},{text:"Type",flex:.4,maxWidth:200,align:"center",sortable:!0,dataIndex:"type"},{text:"Date created",flex:.5,maxWidth:250,align:"center",sortable:!0,dataIndex:"ts"},{text:"Published",flex:.4,maxWidth:200,align:"center",sortable:!0,dataIndex:"public"},{xtype:"actioncolumn",maxWidth:80,menuDisabled:!0,sortable:!1,align:"center",items:[{icon:bq.url("../export_service/public/images/delete.png"),align:"center",tooltip:"Remove",handler:function(e,t,n){var r=e.store.getAt(t).get("name");e.store.removeAt(t),BQ.ui.message("Export - Remove","File "+r+" removed!")}}]}],defaults:{tdCls:"align"}}}),this.resourceGrid},getResourceStore:function(){return this.resourceStore=Ext.create("Ext.data.ArrayStore",{fields:["icon","name",{name:"type",convert:function(e){return Ext.String.capitalize(e)}},{name:"ts",convert:function(e){return Ext.Date.format(new Date(e),"F j, Y g:i:s a")}},{name:"public",convert:function(e){return e=="published"?"Yes":"No"}},"uri","viewPriority"],sorters:[{property:"viewPriority",direction:"ASC"}]}),this.resourceStore}});