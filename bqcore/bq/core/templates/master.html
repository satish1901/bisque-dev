<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      py:strip="">

<py:match path="head" once="true">
<head py:attrs="select('@*')">

    <meta content="text/html; charset=UTF-8" http-equiv="content-type" py:replace="''"/>
    <meta name = "viewport" content="width=900, maximum-scale=1" />

    <title py:with="title = list(select('title/text()'))">
    Bisque<py:if test="title">: ${title}</py:if>
    </title>

    <!-- Bisque styles -->
    <!--<link href="http://fonts.googleapis.com/css?family=Abel|Varela+Round" rel="stylesheet" type="text/css" />-->
    <link href="//fonts.googleapis.com/css?family=Abel|Varela+Round" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="${tg.url('/extjs/resources/css/ext-all.css')}" />
    <!--<link rel="stylesheet" type="text/css" href="${tg.url('/extjs/resources/css/ext-all-neptune.css')}"/>-->

    <!-- ExtJS5 styles -->
    <!--<link rel="stylesheet" type="text/css" href="${tg.url('/extjs/packages/ext-theme-classic/build/resources/ext-theme-classic-all.css')}"/>-->
    <!--<link rel="stylesheet" type="text/css" href="${tg.url('/extjs/packages/ext-theme-crisp/build/resources/ext-theme-crisp-all.css')}"/>-->


    ${h.stylesheet_link (
    '/css/bq.css',
    '/css/bq_ui_toolbar.css',
    '/js/bq_ui_misc.css',
    '/js/ResourceBrowser/ResourceBrowser.css',
    '/js/ResourceTagger/Tagger.css',
    '/js/DatasetBrowser/DatasetBrowser.css',
    '/js/Share/BQ.share.Dialog.css',
    '/js/picker/Path.css',
    '/js/tree/files.css',
    { 'file' : '/image_service/public/converter.css', 'path' : h.file_root() + 'bqserver/bq' },
    '/panojs3/styles/panojs.css',
    '/js/slider/slider.css',
    '/js/picker/Color.css',
    '/js/form/field/Color.css',
    '/css/imgview.css',
    '/js/movie/movie.css',
    { 'file': '/dataset_service/public/dataset_panel.css', 'path' : h.file_root() + 'bqserver/bq' },
    '/js/renderers/dataset.css',
    '/js/volume/bioWeb3D.css',
    {'file' : '/export_service/public/css/BQ.Export.css', 'path' : h.file_root() + 'bqserver/bq'},
    '/css/bisquik_extjs_fix.css',
    # combined will not work for now due to relative urls in .css files
    #fs_root=h.file_public(),
    #combined='/css/b.css',
    version=bq.release.__VERSION_HASH__
    )}

    <!-- ExtJS 4 -->
    <script py:if="tg.config.get('bisque.js_environment', None) == 'production'" type="text/javascript" src="${tg.url('/extjs/ext-all.js')}"></script>
    <script py:if="tg.config.get('bisque.js_environment', None) != 'production'" type="text/javascript" src="${tg.url('/extjs/ext-all-debug.js')}"></script>


    <!-- ExtJS 5 -->
    <!--
    <script>
        var Ext = Ext || {};
        Ext.manifest = {
            compatibility: {
                ext: '4.2'
            },
        };
    </script>
    <script py:if="tg.config.get('bisque.js_environment', None) == 'production'" type="text/javascript" src="${tg.url('/extjs/ext-all.js')}"></script>
    <script py:if="tg.config.get('bisque.js_environment', None) != 'production'" type="text/javascript" src="${tg.url('/extjs/ext-all-debug.js')}"></script>
    -->

    <!-- GMaps API -->
    <!--<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?sensor=false"></script>-->


    <?python
       if tg.config.get('bisque.js_environment', None) == 'production':
          link_kw = dict (fs_root = h.file_public(),
                          combined= '/js/b.js',
                          minify= 'minify',
                          version=bq.release.__VERSION_HASH__)
      else:
          link_kw = {}
    ?>


    ${h.javascript_link(
    '/js/bq_ui_extjs_fix.js',
    # --Bisque JsApi - this needs cleaning and updating--
    '/js/utils.js',
    '/js/bq_api.js',
    '/js/bq_ui_application.js',
    '/js/bq_ui_toolbar.js',
    '/js/bq_ui_misc.js',
    '/js/date.js',
    '/js/encoder.js',
    # -- ResourceBrowser code --
    '/js/ResourceBrowser/Browser.js',
    '/js/ResourceBrowser/LayoutFactory.js',
    '/js/ResourceBrowser/Organizer.js',
    '/js/ResourceBrowser/ResourceQueue.js',
    '/js/ResourceBrowser/DatasetManager.js',
    '/js/ResourceBrowser/CommandBar.js',
    '/js/ResourceBrowser/viewStateManager.js',
    '/js/ResourceBrowser/OperationBar.js',
    '/js/ResourceBrowser/ResourceFactory/ResourceFactory.js',
    '/js/ResourceBrowser/ResourceFactory/ResourceImage.js',
    '/js/ResourceBrowser/ResourceFactory/ResourceMex.js',
    '/js/ResourceBrowser/ResourceFactory/ResourceModule.js',
    '/js/ResourceBrowser/ResourceFactory/ResourceDataset.js',
    '/js/ResourceBrowser/ResourceFactory/ResourceFile.js',
    '/js/ResourceBrowser/ResourceFactory/ResourceUser.js',
    '/js/ResourceBrowser/ResourceFactory/ResourceTemplate.js',
    '/js/ResourceBrowser/ResourceFactory/ResourceDir.js',
    '/js/ResourceBrowser/Misc/MessageBus.js',
    '/js/ResourceBrowser/Misc/Slider.js',
    '/js/ResourceBrowser/Misc/DataTip.js',

    # -- Gesture manager --
    '/js/senchatouch/sencha-touch-gestures.js',
    '/js/ResourceBrowser/Misc/GestureManager.js',

    # -- Share dialog files --
    #'/js/Share/BQ.ShareDialog.js',
    #'/js/Share/BQ.ShareDialog.Offline.js',
    '/js/Share/BQ.share.Dialog.js',
    '/js/Share/BQ.share.Multi.js',
    '/js/ResourceTagger/ComboBox.js',
    '/js/ResourceTagger/RowEditing.js',
    '/js/ResourceTagger/Tagger.js',
    '/js/ResourceTagger/TaggerOffline.js',
    '/js/ResourceTagger/ResourceRenderers/BaseRenderer.js',
    # -- Preferences --
    '/js/Preferences/BQ.Preferences.js',
    '/js/Preferences/PreferenceViewer.js',
    '/js/Preferences/PreferenceTagger.js',
    #-- DatasetBrowser --
    '/js/DatasetBrowser/DatasetBrowser.js',
    # -- TemplateManager --
    '/js/TemplateManager/TemplateTagger.js',
    '/js/TemplateManager/TemplateManager.js',
    '/js/TemplateManager/TagRenderer.js',

    # -- Exporter --
    {'file': '/export_service/public/js/BQ.Export.js', 'path': h.file_root() + 'bqserver/bq/'},

    # -- Directory Browser --
    '/extjs/examples/ux/BoxReorderer.js',
    '/extjs/examples/ux/TabReorderer.js',
    '/js/TagBrowser/TagBrowser.js',

    # -- Tree Organizer --
    '/js/Organizer/BQ.Organizer.Tree.js',
    '/js/picker/Path.js',
    '/js/tree/files.js',

    # -- PanoJS3 --
    '/panojs3/panojs/utils.js',
    '/panojs3/panojs/PanoJS.js',
    '/panojs3/panojs/controls.js',
    '/panojs3/panojs/pyramid_Bisque.js',
    '/panojs3/panojs/control_thumbnail.js',
    '/panojs3/panojs/control_info.js',
    '/panojs3/panojs/control_svg.js',

    # -- Image viewer --
    { 'file' : '/image_service/public/converter.js', 'path': h.file_root() + 'bqserver/bq/'},

    '/js/slider/inversible.js',
    '/js/slider/slider.js',
    '/js/slider/tslider.js',
    '/js/slider/zslider.js',

    '/js/picker/Color.js',
    '/js/form/field/Color.js',

    '/js/viewer/scalebar.js',
    '/js/viewer/2D.js',
    '/js/viewer/imgview.js',
    '/js/viewer/imgops.js',
    '/js/viewer/imgslicer.js',
    '/js/viewer/imgstats.js',
    '/js/viewer/listner_zoom.js',
    '/js/viewer/tilerender.js',
    '/js/viewer/svgrender.js',
    '/js/viewer/imgedit.js',
    '/js/viewer/imgmovie.js',
    '/js/viewer/imageconverter.js',
    '/js/viewer/imgexternal.js',
    '/js/viewer/imgscalebar.js',
    '/js/viewer/imginfobar.js',
    '/js/viewer/progressbar.js',
    '/js/viewer/widget_extjs.js',
    '/js/viewer/imgpixelcounter.js',

    #-- Movie player --
    '/js/movie/movie.js',

    #-- Stats --
    { 'file' : '/stats/public/js/stats.js', 'path': h.file_root() + 'bqserver/bq/'},
    '/js/bq_ui_progress.js',

    #-- GMaps API --
    '/js/map/map.js',

    #-- Resource dispatch --
    { 'file': '/dataset_service/public/dataset_service.js','path': h.file_root() + 'bqserver/bq/'},
    { 'file': '/dataset_service/public/dataset_operations.js','path': h.file_root() + 'bqserver/bq/'},
    { 'file': '/dataset_service/public/dataset_panel.js','path': h.file_root() + 'bqserver/bq/'},
    '/js/renderers/dataset.js',
    '/js/resourceview.js',

    # -- WebGL viewer --
    '/js/volume/lib/whammy.js',
    '/js/volume/lib/polygon.js',
    '/js/volume/threejs/three.min.js',
    '/js/volume/threejs/OrbitControls.js',
    '/js/volume/threejs/TypedArrayUtils.js',
    '/js/volume/animationControls.js',
    '/js/volume/renderingControls.js',
    '/js/volume/extThreeJS.js',
    '/js/volume/bioWeb3D.js',
    '/js/volume/gobjectbuffers.js',
    '/js/picker/Excolor.js',
    {'file': '/dataset_service/public/dataset_service.js', 'path': h.file_root() + 'bqserver/bq/'},

    **link_kw
    )}


    <!-- Configuration variables   -->
    <script type="text/javascript" >
        // update the configuration in your template
        bq = Ext.create('BQ', {
          title : "${tg.config.get('bisque.title', 'CBI Repository')}",
          root  : "${tg.url('/')}",
        });
    </script>

    <!-- Derived template configuration includes   -->
    ${select('*[@id="config" and local-name()="script"]')}

    <!-- Bisque Application instantiation   -->
    <script type="text/javascript" >
        Ext.onReady( function(){
            BQApp = Ext.create('BQ.Application', bq);
        });
    </script>

    <!-- Derived template includes   -->
    ${select('*[local-name()!="title" and not(@id="config" and local-name()="script")]')}

    <script type="text/javascript" py:if="tg.flash" >
        Ext.onReady( function(){
            BQ.ui.popup( '${tg.flash_obj.status}', '${tg.flash_obj.message}' );
        });
    </script>

</head>
</py:match>


<py:match path="body" once="true">

<body py:attrs="select('@*')">
	<div id="content" class="content" >
    ${select('*|text()')}
  </div>


 <xi:include href="${tg.config.get('bisque.tracking')}" py:if="tg.config.get('bisque.tracking')" />
</body>
</py:match>

</html>
