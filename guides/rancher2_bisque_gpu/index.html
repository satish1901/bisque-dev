<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Rahul Vishwakarma">
        <link rel="canonical" href="https://UCSB-VRL.github.io/bisque/guides/rancher2_bisque_gpu/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Bisque Workload on Rancher 2.0 Setup (with Kubernetes engine) - BisQue-Docs</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/color-brewer.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-XXXXXXXX-X', 'auto');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">BisQue-Docs</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../bisque/">BisQue</a>
</li>
                                    
<li >
    <a href="../bisque_docker/">Docker</a>
</li>
                                    
<li >
    <a href="../jupyter_notebooks/">Jupyter</a>
</li>
                                    
<li >
    <a href="../errors/">Errors</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../about/">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li>
                                <a href="https://github.com/UCSB-VRL/bisque/edit/master/docs/guides/rancher2_bisque_gpu.md">Edit on UCSB-VRL/bisque</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#bisque-workload-on-rancher-20-setup-with-kubernetes-engine">Bisque Workload on Rancher 2.0 Setup (with Kubernetes engine)</a></li>
            <li><a href="#pre-requisite">Pre-requisite</a></li>
            <li><a href="#setup-workload-on-the-bq-cluster">Setup Workload on the bq-cluster</a></li>
            <li><a href="#connoisseurgpu-workload-provisioning">Connoisseur/GPU Workload provisioning</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="bisque-workload-on-rancher-20-setup-with-kubernetes-engine">Bisque Workload on Rancher 2.0 Setup (with Kubernetes engine)<a class="headerlink" href="#bisque-workload-on-rancher-20-setup-with-kubernetes-engine" title="Permanent link">&para;</a></h1>
<hr />
<h3 id="pre-requisite">Pre-requisite<a class="headerlink" href="#pre-requisite" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="/guides/rancher2_bisque">Rancher 2.0 with bq-cluster workload instructions</a></li>
<li><a href="/guides/rancher2_postgresql">Rancher 2.0 with PostgreSql workload instructions</a></li>
</ul>
<h5 id="general-instructions">General instructions<a class="headerlink" href="#general-instructions" title="Permanent link">&para;</a></h5>
<ul>
<li>Setup Cluster with <a href="https://rancher.com/docs/rancher/v2.x/en/cluster-provisioning/rke-clusters/custom-nodes/">/rke-clusters/custom-nodes</a></li>
</ul>
<h5 id="note-assuming-we-have-bq-cluster-with-postgres-and-persistent-volumes">Note: Assuming we have bq-cluster with postgres and persistent volumes<a class="headerlink" href="#note-assuming-we-have-bq-cluster-with-postgres-and-persistent-volumes" title="Permanent link">&para;</a></h5>
<hr />
<h3 id="setup-workload-on-the-bq-cluster">Setup Workload on the bq-cluster<a class="headerlink" href="#setup-workload-on-the-bq-cluster" title="Permanent link">&para;</a></h3>
<p>Bisque Test environment where workloads are deployed with open NodePort
https://rancher.com/managing-kubernetes-workloads-with-rancher-2-0/</p>
<ul>
<li>We will be using the image at custom registry biodev.ece.ucsb.edu:5000/ucsb-bisque05-svc or another available at <a href="https://hub.docker.com/r/vishwakarmarhl/ucsb-bisque05-svc">vishwakarmarhl/ucsb-bisque05-svc:dev</a></li>
</ul>
<h5 id="bisque-service-workload-configuration">Bisque Service Workload configuration<a class="headerlink" href="#bisque-service-workload-configuration" title="Permanent link">&para;</a></h5>
<ul>
<li>Name: ucsb-bisque05-svc</li>
<li>Pods: 2</li>
<li>Docker Image : biodev.ece.ucsb.edu:5000/bisque-caffe-xenial:dev or <a href="https://hub.docker.com/r/vishwakarmarhl/ucsb-bisque05-svc">vishwakarmarhl/ucsb-bisque05-svc:dev</a></li>
<li>Port Mapping: 8080-tcp-NodePort-Random &amp; 27000-tcp-NodePort-Random </li>
<li>Environment Variables: Copy paste the "Environment Configuration" section </li>
<li>Node Scheduling: Run all the pods on a particular host</li>
<li>Health Check: No change</li>
<li>Volumes: Persistent Volume claim and set the mount point as /run/bisque</li>
<li>Scaling: No change</li>
<li>Command: No Change</li>
<li>Networking: No Change</li>
<li>Labels: No change</li>
<li>Security: No change</li>
</ul>
<h5 id="environment-configuration">Environment Configuration<a class="headerlink" href="#environment-configuration" title="Permanent link">&para;</a></h5>
<ul>
<li>Bisque service variables</li>
</ul>
<pre class="codehilite"><code>      BISQUE_USER= bisque
      BISQUE_BISQUE_ADMIN_EMAIL= admin@loup.ece.ucsb.edu
      BISQUE_BISQUE_BLOB_SERVICE_STORES= blobs,local
      BISQUE_BISQUE_STORES_BLOBS_MOUNTURL= file://$$datadir/blobdir/$$user/
      BISQUE_BISQUE_STORES_BLOBS_TOP= file://$$datadir/blobdir/
      BISQUE_BISQUE_STORES_LOCAL_MOUNTURL= file://$$datadir/imagedir/$$user/
      BISQUE_BISQUE_STORES_LOCAL_READONLY= true
      BISQUE_BISQUE_STORES_LOCAL_TOP= file://$$datadir/imagedir/
      BISQUE_DOCKER_DOCKER_HUB= biodev.ece.ucsb.edu:5000
      BISQUE_SECRET= bq123
      BISQUE_UID= 12027
      BISQUE_RUNTIME_STAGING_BASE= /run/bisque/data/staging
      BQ__BISQUE__IMAGE_SERVICE__WORK_DIR= /run/bisque/local/workdir
      BQ__BISQUE__PATHS__DATA= /run/bisque/data
      MAIL_SERVER= dough.ece.ucsb.edu
      BISQUE_DBURL=postgresql://postgres:postgres@10.42.0.15:5432/postgres

      DEBIAN_FRONTEND=noninteractive
      IMGCNV=imgcnv_ubuntu16_2.4.3</code></pre>


<h5 id="condor-provisioning">Condor provisioning<a class="headerlink" href="#condor-provisioning" title="Permanent link">&para;</a></h5>
<p>Condor Master 
- Image: biodev.ece.ucsb.edu:5000/condor 
- Ports: 9618, 9886 as HostPort
- Environment</p>
<pre class="codehilite"><code>CONDOR_DAEMONS = COLLECTOR,MASTER,NEGOTIATOR,SCHEDD,SHARED_PORT
CONDOR_MANAGER_HOST = master</code></pre>


<p>Condor Worker
- Same configuration as above
- Ports: 9886 NodePort Random</p>
<h5 id="workload-bq-cluster-dashboard">Workload (bq-cluster) Dashboard<a class="headerlink" href="#workload-bq-cluster-dashboard" title="Permanent link">&para;</a></h5>
<p><img alt="Rancher Workload Dashboard" src="../img/bqranch/workload_bisque_dash.png?raw=true" /></p>
<hr />
<h2 id="connoisseurgpu-workload-provisioning">Connoisseur/GPU Workload provisioning<a class="headerlink" href="#connoisseurgpu-workload-provisioning" title="Permanent link">&para;</a></h2>
<hr />
<p>Here lets take a look at connoissuer service in Bisque. We will run a Bisque H1 server disabling the engine_service and connoisseur in part (A) and later another service in part (B) with Connoisseur and engine service for the actual compute. </p>
<h5 id="pre-requisites">Pre-requisites<a class="headerlink" href="#pre-requisites" title="Permanent link">&para;</a></h5>
<ul>
<li>Create a namespace "connoisseur" and deploy everything isolated from the existing bisque-svc</li>
<li>Create a postgres database for this deployment</li>
<li>psql -h 10.42.0.15 -U postgres --password -p 5432 postgres</li>
<li>"create database connoissuer;"</li>
<li>"grant all privileges on database connoisseur to postgres;"</li>
<li>Create a volume bqcon-vol mounted at 192.168.1.123:/opt/bisque/connoisseur over NFS </li>
</ul>
<h4 id="a-bisque-client-service-workload-configuration">A.) Bisque Client Service Workload configuration<a class="headerlink" href="#a-bisque-client-service-workload-configuration" title="Permanent link">&para;</a></h4>
<ul>
<li>Name: bq-connoisseur-client-svc</li>
<li>Pods: 1</li>
<li>Docker Image : biodev.ece.ucsb.edu:5000/bisque-caffe-xenial:dev</li>
<li>Port Mapping: 80-tcp-NodePort-Random &amp; 27000-tcp-NodePort-Random </li>
<li>Environment Variables: Copy paste the "Environment Configuration" section </li>
<li>Node Scheduling: Run all the pods on a particular host that has GPU, Say "arkady" </li>
<li>Health Check: No change</li>
<li>Volumes: Persistent Volume claim of bqcon-vol and set the mount point as /run/bisque/</li>
<li>Scaling: No change</li>
<li>Command: No Change</li>
<li>Networking: No Change</li>
<li>Labels: No change</li>
<li>Security: No change</li>
</ul>
<h5 id="environment-configuration_1">Environment Configuration<a class="headerlink" href="#environment-configuration_1" title="Permanent link">&para;</a></h5>
<ul>
<li>Bisque client service variables</li>
</ul>
<pre class="codehilite"><code>      BISQUE_USER= bisque
      BISQUE_BISQUE_ADMIN_EMAIL= admin@loup.ece.ucsb.edu
      BISQUE_BISQUE_BLOB_SERVICE_STORES= blobs,local
      BISQUE_BISQUE_STORES_BLOBS_MOUNTURL= file://$$datadir/blobdir/$$user/
      BISQUE_BISQUE_STORES_BLOBS_TOP= file://$$datadir/blobdir/
      BISQUE_BISQUE_STORES_LOCAL_MOUNTURL= file://$$datadir/imagedir/$$user/
      BISQUE_BISQUE_STORES_LOCAL_READONLY= true
      BISQUE_BISQUE_STORES_LOCAL_TOP= file://$$datadir/imagedir/
      BISQUE_DOCKER_DOCKER_HUB= biodev.ece.ucsb.edu:5000
      BISQUE_SECRET= bq123
      BISQUE_UID= 12027
      BISQUE_RUNTIME_STAGING_BASE= /run/bisque/data/staging
      BQ__BISQUE__IMAGE_SERVICE__WORK_DIR= /run/bisque/local/workdir
      BQ__BISQUE__PATHS__DATA= /run/bisque/data
      MAIL_SERVER= dough.ece.ucsb.edu
      DEBIAN_FRONTEND=noninteractive
      IMGCNV=imgcnv_ubuntu16_2.4.3
      BISQUE_DBURL=postgresql://postgres:postgres@10.42.0.15:5432/connoisseur
      BISQUE_SERVERS_H1_SERVICES_DISABLED = engine_service,connoisseur</code></pre>


<h4 id="b-bisque-engine-service-workload-configuration">B.) Bisque Engine Service Workload configuration<a class="headerlink" href="#b-bisque-engine-service-workload-configuration" title="Permanent link">&para;</a></h4>
<ul>
<li>All the same configuration as above but skipping one environment variable</li>
<li>
<p>Skip the disable variable --&gt; BISQUE_SERVERS_H1_SERVICES_DISABLED = engine_service,connoisseur</p>
</li>
<li>
<p>Verify connoisseur GPU variables </p>
</li>
</ul>
<pre class="codehilite"><code>      NVIDIA_REQUIRE_CUDA=cuda&gt;=8.0
      NVIDIA_VISIBLE_DEVICES=all
      NVIDIA_DRIVER_CAPABILITIES=compute,utility
      CUDA_PKG_VERSION=8-0=8.0.61-1
      CAFFE_PKG_VERSION=0.15.13-1ubuntu16.04+cuda8.0
      CAFFE_VERSION=0.15
      CUDA_VERSION=8.0.61

      CONDOR_MANAGER_HOST=master.condor
      CONDOR_DAEMONS=MASTER,SCHEDD,SHARED_PORT</code></pre>


<h5 id="workload-bq-cluster-with-namespace-connoissuer">Workload (bq-cluster) with Namespace Connoissuer<a class="headerlink" href="#workload-bq-cluster-with-namespace-connoissuer" title="Permanent link">&para;</a></h5>
<p><img alt="Rancher Workload Dashboard" src="../img/bqranch/workload_connoisseur.png?raw=true" /></p>
<hr />
<p>TODO:<br />
- Fix Caffe and CUDA within the image 
- Probably write your own Docker file for a new CUDA/GPU enabled container</p>
<pre class="codehilite"><code>bisque@bq-connoisseur-engine-svc-74755f798b-6lbgk:/source$ caffe deveice_query -gpu all
E0213 00:36:24.855478  1798 caffe.cpp:77] Available caffe actions:
E0213 00:36:24.856573  1798 caffe.cpp:80]       device_query
E0213 00:36:24.856690  1798 caffe.cpp:80]       test
E0213 00:36:24.856793  1798 caffe.cpp:80]       time
E0213 00:36:24.856899  1798 caffe.cpp:80]       train
F0213 00:36:24.857019  1798 caffe.cpp:82] Unknown action: deveice_query
*** Check failure stack trace: ***
    @     0x7fafbc7c65cd  google::LogMessage::Fail()
    @     0x7fafbc7c8433  google::LogMessage::SendToLog()
    @     0x7fafbc7c615b  google::LogMessage::Flush()
    @     0x7fafbc7c8e1e  google::LogMessageFatal::~LogMessageFatal()
    @           0x40863a  main
    @     0x7fafbb218830  __libc_start_main
    @           0x408dd9  _start
    @              (nil)  (unknown)
Aborted (core dumped)</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2017 - 2018 Bisque, UCSB VRL</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
